<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>自律助手</title>
    <!-- 网页图标设置 -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="build/icons/32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="build/icons/16x16.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="build/icons/180x180.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="build/icons/152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="build/icons/144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="build/icons/120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="build/icons/120x120.png"
    />
    <link rel="apple-touch-icon" sizes="76x76" href="build/icons/76x76.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="build/icons/72x72.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="build/icons/60x60.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="build/icons/60x60.png" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Arial, sans-serif;
        background: white;
        min-height: 100vh;
        overflow: auto; /* 允许手机端上下滑动 */
        /* 防止弹性滚动导致的导航栏移动 */
        overscroll-behavior: none;
        -webkit-overflow-scrolling: touch;
      }

      html {
        /* 防止页面整体弹性滚动 */
        overscroll-behavior: none;
        -webkit-overflow-scrolling: touch;
      }

      /* 主题色变量 */
      :root {
        --primary-color: #4caf50;
        --primary-hover: #45a049;
        --background-color: white;
        --content-opacity: 0.95;
        --text-box-opacity: 0.9;
        --blur-amount: 10px;
      }

      /* 动画效果 */
      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateY(-10px);
        }
        10% {
          opacity: 1;
          transform: translateY(0);
        }
        90% {
          opacity: 1;
          transform: translateY(0);
        }
        100% {
          opacity: 0;
          transform: translateY(-10px);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      /* 顶部信息栏 */
      .top-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: background 0.3s ease;
        backdrop-filter: blur(var(--blur-amount));
      }

      /* 背景图片样式 */
      body.has-background {
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
      }

      .main-app {
        background: rgba(255, 255, 255, var(--content-opacity));
        backdrop-filter: blur(var(--blur-amount));
        transition: background 0.3s ease, opacity 0.3s ease,
          backdrop-filter 0.3s ease;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.9rem;
      }

      /* 货币项样式 */
      .currency-item {
        display: flex;
        align-items: center;
        margin-right: 1rem;
      }

      /* 手机端响应式样式 */
      @media (max-width: 768px) {
        .header-left {
          display: none;
        }

        .header-center .daily-task-button span {
          display: none;
        }

        .header-right .username {
          display: inline;
          font-size: 0.9rem;
          margin-right: 0.3rem;
        }

        .header-right .rank-badge {
          display: inline;
          font-size: 0.8rem;
        }

        .announcement-icon span {
          display: none;
        }

        /* 手机端顶部导航栏调整 */
        .top-header {
          padding: 0 0.5rem;
          height: 50px;
        }

        .daily-task-button {
          padding: 6px 12px;
        }

        .user-avatar {
          width: 35px;
          height: 35px;
          font-size: 1rem;
        }

        /* 番茄钟窄屏幕适配 */
        .tomato-clock-container {
          max-width: 95% !important;
          padding: 1rem !important;
          margin: 0.5rem auto !important;
        }

        #taskNameDisplay {
          font-size: 1rem !important;
          max-width: 100%;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        #timeDisplay {
          font-size: 4rem !important;
          margin-bottom: 0.3rem !important;
        }

        #encouragementDisplay {
          font-size: 0.9rem !important;
          max-width: 100%;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        #tomatoClockSettings input,
        #tomatoClockSettings textarea {
          font-size: 0.9rem !important;
          padding: 0.5rem !important;
        }

        #tomatoClockSettings label {
          font-size: 0.8rem !important;
        }

        #tomatoClockSettings div[style*="min-width: 150px"] {
          min-width: 100% !important;
          flex: 1 1 100% !important;
        }

        #tomatoClockSettings div[style*="min-width: 300px"] {
          min-width: 100% !important;
          flex: 1 1 100% !important;
        }

        /* 自律日历窄屏幕适配 */
        .calendar-container {
          max-width: 95% !important;
          padding: 1rem !important;
          margin: 0.5rem auto !important;
        }

        .calendar-header {
          flex-direction: column !important;
          gap: 1rem !important;
          align-items: stretch !important;
        }

        .calendar-header h3 {
          font-size: 1.2rem !important;
          text-align: center !important;
        }

        .calendar-nav {
          justify-content: center !important;
          gap: 1rem !important;
        }

        .calendar-nav button {
          padding: 0.4rem 0.8rem !important;
          font-size: 0.9rem !important;
        }

        .calendar-grid {
          grid-template-columns: repeat(7, 1fr) !important;
          gap: 0.3rem !important;
        }

        .calendar-day {
          padding: 0.3rem !important;
          font-size: 0.8rem !important;
          min-height: 40px !important;
        }

        .calendar-day div {
          font-size: 0.7rem !important;
          line-height: 1.2 !important;
        }

        .stats-container {
          padding: 1rem !important;
          margin-top: 1rem !important;
        }

        .stats-chart {
          height: 150px !important;
          gap: 0.3rem !important;
        }

        .chart-bar {
          width: 20px !important;
        }

        .chart-value {
          font-size: 0.7rem !important;
          top: -20px !important;
        }

        .chart-label {
          font-size: 0.6rem !important;
          bottom: -20px !important;
        }
      }

      /* 默认样式 - 显示完整文本 */
      .header-left .currency-icon {
        display: none;
      }

      .header-left .currency-text {
        display: inline;
      }

      /* 超小屏幕响应式 */
      @media (max-width: 480px) {
        .header-left {
          gap: 0.3rem;
        }

        .currency-item {
          margin-right: 0.3rem;
        }

        .currency-icon {
          margin-right: 0.2rem;
          font-size: 0.9rem;
        }

        .currency-value {
          font-size: 0.8rem;
        }

        .daily-task-button {
          padding: 4px 8px;
        }

        .user-avatar {
          width: 30px;
          height: 30px;
          font-size: 0.9rem;
        }
      }

      .header-center {
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
      }

      /* 每日任务按钮样式 */
      .daily-task-button {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .daily-task-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* 公告图标样式 */
      .announcement-icon {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background-color 0.2s ease;
      }

      .announcement-icon:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      /* 可选：添加通知红点提示 */
      .announcement-icon.has-notification {
        position: relative;
      }

      .announcement-icon.has-notification::after {
        content: "";
        position: absolute;
        top: 8px;
        right: 8px;
        width: 8px;
        height: 8px;
        background-color: #ff4444;
        border-radius: 50%;
        border: 1px solid white;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        color: #667eea;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        overflow: hidden;
        position: relative;
      }

      .user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .username {
        font-weight: bold;
        font-size: 1.1rem;
      }

      #profileName {
        font-size: 1.5rem !important;
        margin-bottom: 0.5rem;
      }

      .avatar-upload {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        font-size: 0.8rem;
        text-align: center;
        line-height: 40px;
        border-radius: 50%;
      }

      .user-avatar:hover .avatar-upload {
        display: block;
      }

      /* 欢迎界面 */
      .welcome-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.8s ease-in;
      }

      .welcome-screen h1 {
        font-size: 3rem;
        color: #333;
        font-weight: 300;
      }

      /* 登录/注册界面 */
      .login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 999;
        opacity: 0;
        transition: opacity 0.8s ease-in;
      }

      .login-container {
        width: 100%;
        max-width: 400px;
        padding: 2rem;
        text-align: center;
        background: rgba(255, 255, 255, var(--text-box-opacity));
        border-radius: 15px;
        backdrop-filter: blur(var(--blur-amount));
      }

      .login-container h2 {
        margin-bottom: 2rem;
        color: #333;
        font-weight: 400;
      }

      .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #555;
        font-size: 0.9rem;
      }

      .form-group input {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        outline: none;
      }

      .form-group input:focus {
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        padding: 0.8rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .btn:hover {
        background: var(--primary-hover);
      }

      .toggle-link {
        margin-top: 1rem;
        color: #666;
        font-size: 0.9rem;
      }

      .toggle-link a {
        color: #667eea;
        text-decoration: none;
        margin-left: 0.5rem;
      }

      /* 主界面 */
      .main-app {
        display: none;
        height: 100vh;
        background: #f5f5f5;
        position: relative;
        opacity: 0;
        transition: opacity 0.8s ease-in;
        padding-top: 60px;
        padding-bottom: 70px;
      }

      .content-area {
        height: calc(100vh - 60px - 70px);
        overflow-y: auto;
        padding: 1rem;
        /* 防止内容区域弹性滚动 */
        overscroll-behavior: none;
        -webkit-overflow-scrolling: touch;
      }

      /* 导航栏 */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, var(--text-box-opacity));
        backdrop-filter: blur(var(--blur-amount));
        display: flex;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }

      .nav-item {
        flex: 1;
        text-align: center;
        padding: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #666;
      }

      .nav-item.active {
        color: var(--primary-color);
      }

      .nav-item i {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 0.2rem;
      }

      /* 代办界面 */
      .todo-section,
      .tools-section,
      .shop-section,
      .profile-section {
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease-out;
      }

      .todo-section.active,
      .tools-section.active,
      .shop-section.active,
      .profile-section.active {
        display: block;
        opacity: 1;
      }

      .todo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .todo-stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        flex: 1;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
      }

      .add-todo-btn {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        z-index: 100;
        transition: opacity 0.5s ease, visibility 0.5s ease, transform 0.3s ease,
          background-color 0.3s ease;
      }

      .add-todo-btn:hover {
        background: var(--primary-hover);
        transform: scale(1.1);
      }

      .todo-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .todo-item {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 1rem;
        backdrop-filter: blur(var(--blur-amount));
      }

      .todo-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .todo-content {
        flex: 1;
      }

      .todo-title {
        font-weight: bold;
        margin-bottom: 0.2rem;
      }

      .todo-time {
        font-size: 0.8rem;
        color: #666;
      }

      .todo-priority {
        padding: 0.2rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        color: white;
      }

      .priority-high {
        background: #ff4757;
      }
      .priority-medium {
        background: #ffa502;
      }
      .priority-low {
        background: #2ed573;
      }

      .delete-todo-btn {
        background: none;
        border: none;
        color: #ff4757;
        cursor: pointer;
        padding: 0.3rem;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        opacity: 0.7;
      }

      .delete-todo-btn:hover {
        background: rgba(255, 71, 87, 0.1);
        opacity: 1;
        transform: scale(1.1);
      }

      /* 我的界面 */
      .profile-header {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .profile-avatar {
        width: 80px;
        height: 80px;
        background: #667eea;
        border-radius: 50%;
        margin: 0 auto 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
      }

      .profile-info {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(238, 238, 238, var(--text-box-opacity));
      }

      .info-item:last-child {
        border-bottom: none;
      }

      /* 弹窗 */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1001;
      }

      .modal-content {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        backdrop-filter: blur(var(--blur-amount));
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
      }

      .remember-me {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 1rem;
      }

      .remember-me input[type="checkbox"] {
        margin-right: 0.5rem;
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .remember-me label {
        margin-bottom: 0;
        cursor: pointer;
        color: #666;
        user-select: none;
      }

      /* 工具栏 */
      .tools-section,
      .shop-section {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      /* 自律日历样式 */
      .calendar-container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, var(--text-box-opacity));
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .calendar-header h3 {
        color: #333;
        font-weight: 400;
        margin: 0;
      }

      .calendar-nav {
        display: flex;
        gap: 0.5rem;
      }

      .calendar-nav button {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .calendar-nav button:hover {
        background: var(--primary-hover);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .calendar-day {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 0.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .calendar-day:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .calendar-day.today {
        background: rgba(76, 175, 80, 0.2);
        border-color: var(--primary-color);
      }

      .calendar-day.has-data {
        border-width: 2px;
      }

      .calendar-day.efficient {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .calendar-day.inefficient {
        border-color: #ff4757;
        background: rgba(255, 71, 87, 0.1);
      }

      .calendar-day.empty {
        background: transparent;
        border: none;
        cursor: default;
      }

      .stats-container {
        background: rgba(255, 255, 255, var(--text-box-opacity));
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(var(--blur-amount));
      }

      .stats-container h4 {
        color: #333;
        margin-bottom: 1rem;
        font-weight: 400;
      }

      .stats-chart {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        height: 200px;
        gap: 0.5rem;
      }

      .chart-bar {
        background: var(--primary-color);
        border-radius: 4px 4px 0 0;
        width: 30px;
        position: relative;
        transition: height 0.3s ease;
      }

      .chart-bar.efficient {
        background: #4caf50;
      }

      .chart-bar.inefficient {
        background: #ff4757;
      }

      .chart-value {
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8rem;
        color: #333;
        font-weight: bold;
      }

      .chart-label {
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.7rem;
        color: #666;
      }

      .day-details {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
        border-left: 4px solid var(--primary-color);
      }

      .day-details p {
        margin: 0.5rem 0;
        color: #333;
      }

      /* 段位铭牌样式 */
      .rank-badge {
        background: linear-gradient(135deg, #ffd700, #ffa500);
        color: #fff;
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: 8px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.4);
        animation: rankGlow 2s ease-in-out infinite alternate;
        min-width: 50px;
        text-align: center;
        display: inline-block;
      }

      @keyframes rankGlow {
        0% {
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        100% {
          box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }
      }

      /* 不同段位的颜色样式 */
      .rank-badge.bronze {
        background: linear-gradient(135deg, #cd7f32, #8b4513);
      }

      .rank-badge.silver {
        background: linear-gradient(135deg, #c0c0c0, #808080);
      }

      .rank-badge.gold {
        background: linear-gradient(135deg, #ffd700, #ffa500);
      }

      .rank-badge.platinum {
        background: linear-gradient(135deg, #e5e4e2, #b9b9b9);
      }

      .rank-badge.diamond {
        background: linear-gradient(135deg, #b9f2ff, #7ec0ee);
      }

      .rank-badge.master {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      }

      .rank-badge.grandmaster {
        background: linear-gradient(135deg, #8a2be2, #4b0082);
      }

      .rank-badge.challenger {
        background: linear-gradient(135deg, #ff1493, #dc143c);
      }

      /* 用户名等级颜色样式 */
      .username.level-1 {
        color: #808080; /* 灰色 */
      }

      .username.level-2 {
        color: #4169e1; /* 蓝色 */
      }

      .username.level-3 {
        color: #8b4513; /* 棕色 */
      }

      .username.level-4 {
        color: #228b22; /* 绿色 */
      }

      .username.level-5 {
        color: #ff8c00; /* 橙色 */
      }

      .username.level-6 {
        color: #dc143c; /* 红色 */
      }

      .username.level-7 {
        color: #8a2be2; /* 紫色 */
      }

      .username.level-8 {
        color: #ff1493; /* 粉红色 */
      }

      .username.level-9 {
        color: #00ced1; /* 青色 */
      }

      .username.level-10 {
        color: #ffd700; /* 金色 */
      }

      .username.level-gold {
        color: #ffd700;
        background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
      }

      /* 高级等级颜色（11-256级）使用循环颜色 */
      .username.level-high {
        text-shadow: 0 0 10px currentColor, 0 0 20px currentColor,
          0 0 30px currentColor;
        animation: textGlow 2s ease-in-out infinite alternate;
      }

      /* 详情界面样式 */
      .details-section {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        padding: 2rem;
        box-sizing: border-box;
      }

      .details-header {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
      }

      .back-button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        cursor: pointer;
        margin-right: 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .back-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateX(-5px);
      }

      .details-header h2 {
        color: white;
        margin: 0;
        font-size: 1.8rem;
      }

      .details-content {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 2rem;
        flex: 1;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .details-content h3 {
        color: #333;
        margin-bottom: 1rem;
        font-size: 1.3rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 0.5rem;
      }

      .details-content ul {
        color: #555;
        line-height: 1.6;
        margin-bottom: 2rem;
      }

      .details-content li {
        margin-bottom: 0.5rem;
      }

      .color-grid,
      .rank-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .color-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        border: 1px solid #eee;
      }

      .color-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #ddd;
      }

      .rank-item {
        padding: 1.5rem;
        border-radius: 10px;
        text-align: center;
        color: white;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .rank-item.bronze {
        background: linear-gradient(135deg, #cd7f32, #b87333);
      }
      .rank-item.silver {
        background: linear-gradient(135deg, #c0c0c0, #a8a8a8);
      }
      .rank-item.gold {
        background: linear-gradient(135deg, #ffd700, #daa520);
      }
      .rank-item.platinum {
        background: linear-gradient(135deg, #e5e4e2, #b8b8b8);
      }
      .rank-item.diamond {
        background: linear-gradient(135deg, #b9f2ff, #89cff0);
      }
      .rank-item.master {
        background: linear-gradient(135deg, #8a2be2, #6a0dad);
      }
      .rank-item.grandmaster {
        background: linear-gradient(135deg, #ff6b6b, #ff4757);
      }
      .rank-item.challenger {
        background: linear-gradient(135deg, #ffd700, #ffa500);
      }

      .rank-name {
        display: block;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
      }

      .rank-requirement {
        display: block;
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .level-rewards,
      .rank-rewards {
        background: rgba(102, 126, 234, 0.1);
        padding: 1.5rem;
        border-radius: 10px;
        border-left: 4px solid var(--primary-color);
      }

      .level-rewards p,
      .rank-rewards p {
        margin: 0;
        color: #333;
        font-size: 1.1rem;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <!-- 欢迎界面 -->
    <div
      id="welcomeScreen"
      class="welcome-screen"
      onclick="skipWelcomeAnimation()"
    >
      <h1>欢迎！</h1>
      <p
        style="
          position: absolute;
          bottom: 2rem;
          left: 0;
          right: 0;
          text-align: center;
          font-size: 0.9rem;
          color: #888;
        "
      >
        点击任意位置跳过
      </p>
    </div>

    <!-- 登录/注册界面 -->
    <div id="loginScreen" class="login-screen">
      <div class="login-container">
        <h2 id="authTitle">欢迎回来</h2>
        <form id="authForm">
          <div class="form-group">
            <label>用户名</label>
            <input
              type="text"
              id="username"
              placeholder="请输入用户名"
              required
              title="用户名输入框"
              aria-label="用户名"
            />
          </div>
          <div class="form-group">
            <label>密码</label>
            <input
              type="password"
              id="password"
              placeholder="请输入密码"
              required
              title="密码输入框"
              aria-label="密码"
            />
          </div>
          <div class="form-group remember-me">
            <input
              type="checkbox"
              id="rememberMe"
              title="记住我"
              aria-label="记住我"
            />
            <label for="rememberMe">记住我</label>
          </div>
          <button type="submit" class="btn" id="authButton">登录</button>
          <div class="toggle-link">
            <span id="toggleText">还没有账号？</span>
            <a href="#" id="toggleLink">立即注册</a>
          </div>
        </form>
      </div>
    </div>

    <!-- 主界面 -->
    <div id="mainApp" class="main-app">
      <!-- 顶部信息栏 -->
      <div class="top-header">
        <div class="header-left">
          <span class="currency-item">
            <span class="currency-icon">💰</span>
            <span class="currency-text">金币: </span>
            <span class="currency-value" id="headerCoins">0</span>
          </span>
          <span class="currency-item">
            <span class="currency-icon">💎</span>
            <span class="currency-text">钻石: </span>
            <span class="currency-value" id="headerDiamonds">0</span>
          </span>
        </div>
        <div class="header-center">
          <!-- 每日任务按钮 -->
          <div
            class="daily-task-button"
            onclick="showDailyTasks()"
            title="每日任务"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="currentColor"
              style="margin-right: 8px"
            >
              <path
                d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-7 4h14v2H5V7zm0 4h14v2H5v-2zm0 4h14v2H5v-2zm0 4h14v2H5v-2z"
              />
            </svg>
            <span style="font-size: 0.9rem; white-space: nowrap">每日任务</span>
          </div>
        </div>
        <div class="header-right" onclick="switchTab('profile')">
          <!-- 公告通知图标 -->
          <div
            class="announcement-icon"
            onclick="event.stopPropagation(); showAnnouncementBoard()"
            title="公告"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="currentColor"
              style="margin-right: 8px"
            >
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm1-13h-2v6h2V7zm0 8h-2v2h2v-2z"
              />
            </svg>
            <span style="font-size: 0.9rem; white-space: nowrap">公告</span>
          </div>
          <div class="user-avatar" id="headerAvatar">
            <span id="headerAvatarText">U</span>
            <img id="headerAvatarImg" style="display: none" alt="用户头像" />
            <input
              type="file"
              id="avatarUpload"
              accept="image/*"
              style="display: none"
              onchange="uploadAvatar(event)"
              title="上传头像"
              aria-label="上传头像"
            />
          </div>
          <span class="username" id="headerUsername">用户名</span>
          <span class="rank-badge" id="headerRankBadge">青铜</span>
        </div>
      </div>
      <div class="content-area">
        <!-- 代办界面 -->
        <div id="todoSection" class="todo-section">
          <div class="todo-header">
            <h2>我的代办</h2>
            <button id="sortTodoBtn" class="sort-btn" onclick="sortTodosByPriority()" style="
              padding: 0.5rem 1rem;
              background: #4CAF50;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              font-size: 0.9rem;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            ">
              <i>📊</i>
              <span>优先级排序</span>
            </button>
          </div>

          <div class="todo-stats">
            <div
              class="stat-card"
              onclick="toggleShowAllTasks()"
              style="cursor: pointer; transition: all 0.3s ease"
              id="totalTasksCard"
            >
              <div class="stat-number" id="totalTasks">0</div>
              <div>总任务</div>
            </div>
            <div
              class="stat-card"
              onclick="toggleShowCompletedOnly()"
              style="cursor: pointer; transition: all 0.3s ease"
              id="completedTasksCard"
            >
              <div class="stat-number" id="completedTasks">0</div>
              <div>已完成</div>
            </div>
            <div
              class="stat-card"
              onclick="toggleShowPendingOnly()"
              style="cursor: pointer; transition: all 0.3s ease"
              id="pendingTasksCard"
            >
              <div class="stat-number" id="pendingTasks">0</div>
              <div>未完成</div>
            </div>
          </div>
          <div class="todo-list" id="todoList"></div>
        </div>

        <!-- 工具界面 -->
        <div id="toolsSection" class="tools-section">
          <h2>工具箱</h2>
          <div
            style="
              display: flex;
              gap: 1rem;
              flex-wrap: wrap;
              justify-content: center;
              margin-top: 1.5rem;
            "
          >
            <!-- 番茄钟工具 -->
            <div
              onclick="showEmptyPage('番茄钟')"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 1.5rem;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                min-width: 120px;
                border: 1px solid rgba(255, 255, 255, 0.2);
              "
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">⏰</div>
              <div style="font-weight: bold">番茄钟</div>
            </div>

            <!-- 自律日历工具 -->
            <div
              onclick="showLearningCalendar()"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 1.5rem;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                min-width: 120px;
                border: 1px solid rgba(255, 255, 255, 0.2);
              "
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">📅</div>
              <div style="font-weight: bold">自律日历</div>
            </div>

            <!-- 锁机工具 -->
            <div
              onclick="showEmptyPage('锁机')"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 1.5rem;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                min-width: 120px;
                border: 1px solid rgba(255, 255, 255, 0.2);
              "
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">🔒</div>
              <div style="font-weight: bold">锁机</div>
            </div>

            <!-- 屏蔽网站工具 -->
            <div
              onclick="showEmptyPage('屏蔽网站')"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 1.5rem;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: center;
                min-width: 120px;
                border: 1px solid rgba(255, 255, 255, 0.2);
              "
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 20px rgba(0,0,0,0.1)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">🚫</div>
              <div style="font-weight: bold">屏蔽网站</div>
            </div>
          </div>

          <!-- 空白页面容器 -->
          <div id="emptyPageContainer" style="margin-top: 2rem; display: none">
            <h3 id="emptyPageTitle" style="text-align: center"></h3>
          </div>
        </div>

        <!-- 商城界面 -->
        <div id="shopSection" class="shop-section">
          <h2>金币商城</h2>
          <div
            class="shop-container"
            style="
              display: flex;
              flex-direction: column;
              gap: 1.5rem;
              max-width: 400px;
              margin: 0 auto;
            "
          >
            <!-- 抽奖区域 -->
            <div
              class="shop-card"
              onclick="showLottery()"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 2rem;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(var(--blur-amount));
              "
              onmouseover="this.style.transform='translateY(-5px)'"
              onmouseout="this.style.transform='translateY(0)'"
            >
              <div style="font-size: 3rem; margin-bottom: 1rem">🎰</div>
              <h3 style="color: var(--primary-color); margin-bottom: 0.5rem">
                幸运抽奖
              </h3>
              <p style="color: #666; font-size: 0.9rem">
                消耗金币参与抽奖，赢取钻石奖励
              </p>
              <div style="margin-top: 1rem; color: #ff6b6b; font-weight: bold">
                100 金币/次
              </div>
            </div>

            <!-- 兑换区域 -->
            <div
              class="shop-card"
              onclick="showExchange()"
              style="
                background: rgba(255, 255, 255, var(--text-box-opacity));
                padding: 2rem;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 0.3s ease;
                backdrop-filter: blur(var(--blur-amount));
              "
              onmouseover="this.style.transform='translateY(-5px)'"
              onmouseout="this.style.transform='translateY(0)'"
            >
              <div style="font-size: 3rem; margin-bottom: 1rem">⚖️</div>
              <h3 style="color: var(--primary-color); margin-bottom: 0.5rem">
                货币兑换
              </h3>
              <p style="color: #666; font-size: 0.9rem">
                金币、钻石、自律币互相兑换
              </p>
              <div style="margin-top: 1rem; color: #4ecdc4; font-weight: bold">
                多种兑换选项
              </div>
            </div>
          </div>

          <!-- 抽奖界面 -->
          <div id="lotterySection" style="display: none; margin-top: 2rem">
            <div
              style="
                text-align: center;
                padding: 2rem;
                max-width: 500px;
                margin: 0 auto;
              "
            >
              <h3>🎰 幸运抽奖</h3>
              <div style="margin: 2rem 0">
                <div
                  style="
                    font-size: 4rem;
                    margin-bottom: 1rem;
                    display: flex;
                    gap: 2rem;
                    justify-content: center;
                  "
                >
                  <div>💎</div>
                  <div>🪙</div>
                </div>
                <h4>当前钻石: <span id="diamondCount">0</span></h4>
                <h4>当前自律币: <span id="disciplineCoinCount">0</span></h4>
                <p style="color: #666; margin: 0.5rem 0">
                  钻石概率: <strong>5.1%</strong> (10抽保底)<br />
                  自律币概率: <strong>0.6%</strong> (90抽保底)<br />
                  钻石保底进度: <span id="guaranteeCount">0</span>/10<br />
                  自律币保底进度:
                  <span id="disciplineGuaranteeCount">0</span>/90
                </p>
              </div>

              <div
                style="
                  display: flex;
                  gap: 1rem;
                  justify-content: center;
                  margin: 2rem 0;
                "
              >
                <button
                  onclick="singleDraw()"
                  style="
                    padding: 1rem 2rem;
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 1.1rem;
                    transition: all 0.3s ease;
                  "
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'"
                >
                  单抽 (100金币)
                </button>
                <button
                  onclick="tenDraw()"
                  style="
                    padding: 1rem 2rem;
                    background: #ff6b6b;
                    color: white;
                    border: none;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 1.1rem;
                    transition: all 0.3s ease;
                  "
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'"
                >
                  十连抽 (1000金币)
                </button>
              </div>

              <div
                id="lotteryResult"
                style="margin: 1rem 0; min-height: 2rem"
              ></div>

              <button
                onclick="hideLottery()"
                style="
                  margin-top: 1rem;
                  padding: 0.5rem 1.5rem;
                  background: #666;
                  color: white;
                  border: none;
                  border-radius: 20px;
                  cursor: pointer;
                "
              >
                返回商城
              </button>
            </div>
          </div>

          <!-- 兑换界面 -->
          <div id="exchangeSection" style="display: none; margin-top: 2rem">
            <div
              style="
                text-align: center;
                padding: 2rem;
                max-width: 500px;
                margin: 0 auto;
              "
            >
              <h3>💰 货币兑换</h3>
              <div style="margin: 2rem 0">
                <div style="font-size: 4rem; margin-bottom: 1rem">⚖️</div>
                <div
                  style="
                    display: flex;
                    justify-content: space-around;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: center">
                    <p>当前金币</p>
                    <h4><span id="exchangeCoinCount">0</span></h4>
                  </div>
                  <div style="text-align: center">
                    <p>当前钻石</p>
                    <h4><span id="exchangeDiamondCount">0</span></h4>
                  </div>
                  <div style="text-align: center">
                    <p>当前自律币</p>
                    <h4><span id="exchangeDisciplineCoinCount">0</span></h4>
                  </div>
                </div>
                <p style="color: #666; margin: 0.5rem 0">
                  兑换各种货币，满足不同需求
                </p>
              </div>

              <!-- 金币兑换其他货币 -->
              <div
                style="
                  background: rgba(255, 255, 255, var(--text-box-opacity));
                  padding: 2rem;
                  border-radius: 15px;
                  margin: 2rem 0;
                "
              >
                <h4 style="margin-bottom: 1rem">金币兑换</h4>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: left">
                    <strong>1 颗钻石</strong><br />
                    <span style="color: #666; font-size: 0.9rem"
                      >稀有货币，可用于特殊功能</span
                    >
                  </div>
                  <div>
                    <button
                      onclick="exchangeDiamonds()"
                      style="
                        padding: 0.5rem 1rem;
                        background: var(--primary-color);
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                      "
                    >
                      900 金币兑换
                    </button>
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: left">
                    <strong>1 枚自律币</strong><br />
                    <span style="color: #666; font-size: 0.9rem"
                      >高级货币，用于高级功能</span
                    >
                  </div>
                  <div>
                    <button
                      onclick="exchangeDisciplineCoins()"
                      style="
                        padding: 0.5rem 1rem;
                        background: var(--primary-color);
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                      "
                    >
                      25000 金币兑换
                    </button>
                  </div>
                </div>
              </div>

              <!-- 其他货币兑换回金币 -->
              <div
                style="
                  background: rgba(255, 255, 255, var(--text-box-opacity));
                  padding: 2rem;
                  border-radius: 15px;
                  margin: 2rem 0;
                "
              >
                <h4 style="margin-bottom: 1rem">兑换回金币</h4>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: left">
                    <strong>1 颗钻石 → 金币</strong><br />
                    <span style="color: #666; font-size: 0.9rem"
                      >将钻石转换回金币</span
                    >
                  </div>
                  <div>
                    <button
                      onclick="convertDiamondsToCoins()"
                      style="
                        padding: 0.5rem 1rem;
                        background: #4caf50;
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                      "
                    >
                      兑换 900 金币
                    </button>
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin: 1rem 0;
                  "
                >
                  <div style="text-align: left">
                    <strong>1 枚自律币 → 金币</strong><br />
                    <span style="color: #666; font-size: 0.9rem"
                      >将自律币转换回金币</span
                    >
                  </div>
                  <div>
                    <button
                      onclick="convertDisciplineCoinsToCoins()"
                      style="
                        padding: 0.5rem 1rem;
                        background: #4caf50;
                        color: white;
                        border: none;
                        border-radius: 20px;
                        cursor: pointer;
                      "
                    >
                      兑换 25000 金币
                    </button>
                  </div>
                </div>
              </div>

              <div
                id="exchangeResult"
                style="margin: 1rem 0; min-height: 2rem"
              ></div>

              <button
                onclick="hideExchange()"
                style="
                  margin-top: 1rem;
                  padding: 0.5rem 1.5rem;
                  background: #666;
                  color: white;
                  border: none;
                  border-radius: 20px;
                  cursor: pointer;
                "
              >
                返回商城
              </button>
            </div>
          </div>
        </div>

        <!-- 等级详情界面 -->
        <div
          id="levelDetailsSection"
          class="details-section"
          style="display: none"
        >
          <div class="details-header">
            <button onclick="hideDetails()" class="back-button">← 返回</button>
            <h2>等级系统说明</h2>
          </div>
          <div class="details-content">
            <div class="level-rules">
              <h3>等级规则</h3>
              <ul>
                <li>最高等级：256级</li>
                <li>升级方式：完成每日任务获得高效天数</li>
                <li>每级所需高效天数：当前等级 × 2</li>
              </ul>
            </div>
            <div class="level-colors">
              <h3>等级颜色系统</h3>
              <div class="color-grid">
                <div class="color-item">
                  <span class="color-dot" style="background: #808080"></span>
                  <span class="username level-1">1-30级：灰色</span>
                </div>
                <div class="color-item">
                  <span class="color-dot" style="background: #1e90ff"></span>
                  <span class="username level-2">31-60级：蓝色</span>
                </div>
                <div class="color-item">
                  <span class="color-dot" style="background: #8b4513"></span>
                  <span class="username level-3">61-90级：棕色</span>
                </div>
                <div class="color-item">
                  <span class="color-dot" style="background: #32cd32"></span>
                  <span class="username level-4">91-120级：绿色</span>
                </div>
                <div class="color-item">
                  <span class="color-dot" style="background: #ffa500"></span>
                  <span class="username level-5">121-150级：橙色</span>
                </div>
                <div class="color-item">
                  <span class="color-dot" style="background: #ff0000"></span>
                  <span class="username level-6">151-180级：红色</span>
                </div>
                <div class="color-item">
                  <span class="color-dot" style="background: #8a2be2"></span>
                  <span class="username level-7">181-210级：紫色</span>
                </div>
                <div class="color-item">
                  <span class="color-dot" style="background: #ffd700"></span>
                  <span class="username level-gold level-high"
                    >210级以上：金色+发光特效</span
                  >
                </div>
              </div>
              <p style="color: #666; font-size: 0.9rem; margin-top: 1rem">
                以上文字颜色即为实际等级显示效果
              </p>
            </div>
            <div class="level-rewards">
              <h3>升级奖励</h3>
              <p>每次升级获得：等级 × 10 金币</p>
            </div>
          </div>
        </div>

        <!-- 段位详情界面 -->
        <div
          id="rankDetailsSection"
          class="details-section"
          style="display: none"
        >
          <div class="details-header">
            <button onclick="hideDetails()" class="back-button">← 返回</button>
            <h2>段位系统说明</h2>
          </div>
          <div class="details-content">
            <div class="rank-rules">
              <h3>段位规则</h3>
              <ul>
                <li>最高段位：王者</li>
                <li>升段方式：保持连续高效天数</li>
                <li>升段所需连续天数：当前段位 × 7</li>
              </ul>
            </div>
            <div class="rank-list">
              <h3>段位列表</h3>
              <div class="rank-grid">
                <div class="rank-item bronze">
                  <span class="rank-name">青铜</span>
                  <span class="rank-requirement">需要7天连续高效</span>
                  <span class="rank-badge bronze" style="margin-top: 0.5rem"
                    >青铜</span
                  >
                </div>
                <div class="rank-item silver">
                  <span class="rank-name">白银</span>
                  <span class="rank-requirement">需要14天连续高效</span>
                  <span class="rank-badge silver" style="margin-top: 0.5rem"
                    >白银</span
                  >
                </div>
                <div class="rank-item gold">
                  <span class="rank-name">黄金</span>
                  <span class="rank-requirement">需要21天连续高效</span>
                  <span class="rank-badge gold" style="margin-top: 0.5rem"
                    >黄金</span
                  >
                </div>
                <div class="rank-item platinum">
                  <span class="rank-name">铂金</span>
                  <span class="rank-requirement">需要28天连续高效</span>
                  <span class="rank-badge platinum" style="margin-top: 0.5rem"
                    >铂金</span
                  >
                </div>
                <div class="rank-item diamond">
                  <span class="rank-name">钻石</span>
                  <span class="rank-requirement">需要35天连续高效</span>
                  <span class="rank-badge diamond" style="margin-top: 0.5rem"
                    >钻石</span
                  >
                </div>
                <div class="rank-item master">
                  <span class="rank-name">大师</span>
                  <span class="rank-requirement">需要42天连续高效</span>
                  <span class="rank-badge master" style="margin-top: 0.5rem"
                    >大师</span
                  >
                </div>
                <div class="rank-item grandmaster">
                  <span class="rank-name">宗师</span>
                  <span class="rank-requirement">需要49天连续高效</span>
                  <span
                    class="rank-badge grandmaster"
                    style="margin-top: 0.5rem"
                    >宗师</span
                  >
                </div>
                <div class="rank-item challenger">
                  <span class="rank-name">王者</span>
                  <span class="rank-requirement">需要56天连续高效</span>
                  <span class="rank-badge challenger" style="margin-top: 0.5rem"
                    >王者</span
                  >
                </div>
              </div>
              <p style="color: #666; font-size: 0.9rem; margin-top: 1rem">
                以上铭牌即为实际段位显示效果
              </p>
            </div>
            <div class="rank-rewards">
              <h3>升段奖励</h3>
              <p>每次升段获得：段位系数 × 500 金币</p>
            </div>
          </div>
        </div>

        <!-- 我的界面 -->
        <div id="profileSection" class="profile-section">
          <div class="profile-header">
            <div
              class="profile-avatar"
              id="profileAvatar"
              style="cursor: pointer"
              title="点击上传头像"
            >
              U
            </div>
            <h2 id="profileName">用户名</h2>
            <p>金币: <span id="profileCoins">0</span></p>
            <p>钻石: <span id="profileDiamonds">0</span></p>
            <p>自律币: <span id="profileDisciplineCoins">0</span></p>
            <input
              type="text"
              id="profileSignature"
              placeholder="设置个性签名"
              style="
                border: none;
                background: transparent;
                text-align: center;
                color: #666;
                font-size: 0.9rem;
                margin-top: 0.5rem;
                width: 100%;
              "
              maxlength="30"
            />
          </div>

          <div class="profile-info">
            <div class="info-item">
              <span>成就</span>
              <span>开发中</span>
            </div>
            <div
              class="info-item"
              onclick="showLevelDetails()"
              style="cursor: pointer"
            >
              <span>等级</span>
              <span id="profileLevel">等级 1</span>
            </div>
            <div
              class="info-item"
              onclick="showRankDetails()"
              style="cursor: pointer"
            >
              <span>段位</span>
              <span id="profileRank">段位 青铜</span>
            </div>
            <div class="info-item">
              <span>注册时间</span>
              <span id="profileRegister">-</span>
            </div>
          </div>

          <!-- 礼包码功能 -->
          <div
            style="
              margin-top: 2rem;
              background: rgba(255, 255, 255, var(--text-box-opacity));
              padding: 1.5rem;
              border-radius: 15px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(var(--blur-amount));
            "
          >
            <h3 style="margin-bottom: 1rem; color: #333">礼包码兑换</h3>
            <div style="display: flex; gap: 0.5rem; align-items: center">
              <input
                type="text"
                id="giftCodeInput"
                placeholder="请输入礼包码"
                style="
                  flex: 1;
                  padding: 0.5rem;
                  border: 1px solid #ddd;
                  border-radius: 20px;
                  outline: none;
                "
                maxlength="20"
                title="礼包码输入框"
                aria-label="礼包码"
              />
              <button
                onclick="redeemGiftCode()"
                style="
                  padding: 0.5rem 1rem;
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  border-radius: 20px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                兑换
              </button>
            </div>
            <div
              id="giftCodeResult"
              style="margin-top: 0.5rem; min-height: 1.5rem; font-size: 0.9rem"
            ></div>
          </div>

          <!-- 个性化设置 -->
          <div
            class="profile-settings"
            style="
              margin-top: 2rem;
              background: rgba(255, 255, 255, var(--text-box-opacity));
              padding: 1.5rem;
              border-radius: 15px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(var(--blur-amount));
            "
          >
            <h3 style="margin-bottom: 1rem; color: #333">个性化设置</h3>

            <div class="setting-item" style="margin-bottom: 1.5rem">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >主题颜色</label
              >
              <div
                class="color-picker"
                style="display: flex; gap: 0.5rem; flex-wrap: wrap"
              >
                <div
                  class="color-option"
                  data-color="#667eea"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #667eea;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#ff6b6b"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #ff6b6b;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#4ecdc4"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #4ecdc4;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#45b7d1"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #45b7d1;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#96ceb4"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #96ceb4;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#feca57"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #feca57;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#ff9ff3"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #ff9ff3;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#54a0ff"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #54a0ff;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
                <div
                  class="color-option"
                  data-color="#00cc66"
                  style="
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background: #00cc66;
                    cursor: pointer;
                    border: 2px solid transparent;
                  "
                ></div>
              </div>
            </div>

            <div class="setting-item" style="margin-bottom: 1.5rem">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >界面透明度（白色背景）</label
              >
              <input
                type="range"
                id="contentOpacitySlider"
                min="0"
                max="1"
                step="0.05"
                value="0.95"
                style="width: 100%; margin-bottom: 0.5rem"
              />
              <span
                id="contentOpacityValue"
                style="font-size: 0.8rem; color: #666"
                >95%</span
              >
            </div>

            <div class="setting-item" style="margin-bottom: 1.5rem">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >文字框透明度（任务卡片）</label
              >
              <input
                type="range"
                id="textBoxOpacitySlider"
                min="0"
                max="1"
                step="0.05"
                value="0.9"
                style="width: 100%; margin-bottom: 0.5rem"
              />
              <span
                id="textBoxOpacityValue"
                style="font-size: 0.8rem; color: #666"
                >90%</span
              >
            </div>

            <div class="setting-item" style="margin-bottom: 1.5rem">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >背景模糊程度</label
              >
              <input
                type="range"
                id="blurSlider"
                min="0"
                max="20"
                step="1"
                value="10"
                style="width: 100%; margin-bottom: 0.5rem"
              />
              <span id="blurValue" style="font-size: 0.8rem; color: #666"
                >10px</span
              >
            </div>

            <div class="setting-item">
              <label
                style="
                  display: block;
                  margin-bottom: 0.5rem;
                  color: #555;
                  font-size: 0.9rem;
                "
                >背景图片</label
              >
              <input
                type="file"
                id="bgUpload"
                accept="image/*"
                style="display: none"
              />
              <button
                onclick="document.getElementById('bgUpload').click()"
                style="
                  background: var(--primary-color);
                  color: white;
                  border: none;
                  padding: 0.5rem 1rem;
                  border-radius: 5px;
                  cursor: pointer;
                  margin-right: 0.5rem;
                "
              >
                上传背景
              </button>
              <button
                onclick="removeBackground()"
                style="
                  background: #ccc;
                  color: #333;
                  border: none;
                  padding: 0.5rem 1rem;
                  border-radius: 5px;
                  cursor: pointer;
                "
              >
                移除背景
              </button>
            </div>
          </div>

          <!-- 系统设置 -->
          <div
            style="
              margin-top: 2rem;
              background: rgba(255, 255, 255, var(--text-box-opacity));
              padding: 1.5rem;
              border-radius: 15px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(var(--blur-amount));
            "
          >
            <h3 style="margin-bottom: 1rem; color: #333">系统设置</h3>
            <div
              style="
                display: flex;
                gap: 1rem;
                justify-content: center;
                flex-wrap: wrap;
              "
            >
              <button
                onclick="clearCache()"
                style="
                  background: #ff9500;
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 25px;
                  cursor: pointer;
                  font-size: 1rem;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                清理缓存
              </button>
              <button
                onclick="deleteAccount()"
                style="
                  background: #ff4757;
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 25px;
                  cursor: pointer;
                  font-size: 1rem;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                注销账号
              </button>
            </div>
          </div>

          <!-- 关于我们 -->
          <div
            style="
              margin-top: 2rem;
              background: rgba(255, 255, 255, var(--text-box-opacity));
              padding: 1.5rem;
              border-radius: 15px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(var(--blur-amount));
            "
          >
            <h3 style="margin-bottom: 1rem; color: #333">关于我们</h3>
            <div
              style="
                display: flex;
                gap: 1rem;
                justify-content: center;
                flex-wrap: wrap;
              "
            >
              <button
                onclick="joinUs()"
                style="
                  background: #54a0ff;
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 25px;
                  cursor: pointer;
                  font-size: 1rem;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                加入我们
              </button>
              <button
                onclick="feedbackError()"
                style="
                  background: #4ecdc4;
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 25px;
                  cursor: pointer;
                  font-size: 1rem;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.transform='scale(1.05)'"
                onmouseout="this.style.transform='scale(1)'"
              >
                反馈错误
              </button>
            </div>
          </div>

          <!-- 登出按钮 -->
          <div style="margin-top: 2rem; text-align: center">
            <button
              onclick="logout()"
              style="
                background: #ff4757;
                color: white;
                border: none;
                padding: 0.75rem 2rem;
                border-radius: 25px;
                cursor: pointer;
                font-size: 1rem;
              "
            >
              登出账号
            </button>
          </div>
        </div>
      </div>

      <!-- 公告板界面 -->
      <div
        id="announcementBoard"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          justify-content: center;
          align-items: center;
        "
      >
        <div
          style="
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(var(--blur-amount));
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1.5rem;
            "
          >
            <h2
              style="
                color: #333;
                display: flex;
                align-items: center;
                gap: 0.5rem;
              "
            >
              <i>📢</i>
              公告板
            </h2>
            <button
              onclick="hideAnnouncementBoard()"
              style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #666;
                padding: 0.25rem;
              "
            >
              ×
            </button>
          </div>

          <div id="announcementList">
            <div
              class="announcement-item"
              style="
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                background: #f8f9fa;
                border-radius: 15px;
                border-left: 4px solid var(--primary-color);
              "
            >
              <h4 style="margin: 0 0 0.5rem 0; color: #333">
                自律助手上线啦！
              </h4>
              <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem">
                自律助手是一款帮助你提升效率、培养好习惯的多功能工具，包含以下核心功能：
              </p>
              <ul
                style="
                  margin: 0 0 0.5rem 1.5rem;
                  color: #666;
                  font-size: 0.9rem;
                "
              >
                <li>📋 代办任务管理 - 记录和追踪你的待办事项</li>
                <li>🍅 番茄钟专注 - 提高专注力和工作效率</li>
                <li>🔒 锁机功能 - 避免分心，保持自律</li>
                <li>🚫 网站屏蔽 - 屏蔽干扰网站，保持专注</li>
                <li>🎮 积分系统 - 金币、钻石和自律币奖励机制</li>
                <li>🎰 幸运抽奖 - 使用钻石参与抽奖获得奖励</li>
                <li>👤 个人中心 - 管理个人信息和设置</li>
              </ul>
              <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem">
                立即开始使用自律助手，培养自律习惯，提升生活品质！
              </p>
              <span style="color: #999; font-size: 0.8rem">刚刚</span>
            </div>
          </div>

          <button
            onclick="hideAnnouncementBoard()"
            style="
              width: 100%;
              padding: 0.75rem;
              background: #666;
              color: white;
              border: none;
              border-radius: 10px;
              cursor: pointer;
              font-size: 1rem;
              margin-top: 1rem;
            "
          >
            关闭
          </button>
        </div>
      </div>

      <!-- 底部导航 -->
      <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('todo')">
          <i>📋</i>
          <span>代办</span>
        </div>
        <div class="nav-item" onclick="switchTab('tools')">
          <i>🔧</i>
          <span>工具</span>
        </div>
        <div class="nav-item" onclick="switchTab('shop')">
          <i>🛒</i>
          <span>商城</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile')">
          <i>👤</i>
          <span>我的</span>
        </div>
      </div>
    </div>

    <!-- 添加任务弹窗 -->
    <div id="addTodoModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="todoModalTitle">添加新任务</h3>
          <button class="close-btn" onclick="closeAddTodo()">&times;</button>
        </div>
        <form id="addTodoForm">
          <div class="form-group">
            <label>任务内容</label>
            <input
              type="text"
              id="todoContent"
              placeholder="请输入任务内容"
              required
            />
          </div>
          <div class="form-group">
            <label>截止时间</label>
            <input
              type="datetime-local"
              id="todoDeadline"
              required
              title="任务截止时间"
              aria-label="任务截止时间"
            />
          </div>
          <div class="form-group">
            <label>优先级</label>
            <select
              id="todoPriority"
              required
              title="任务优先级选择"
              aria-label="任务优先级"
            >
              <option value="low">低</option>
              <option value="medium" selected>中</option>
              <option value="high">高</option>
            </select>
          </div>
          <div class="form-group">
            <label>重复周期</label>
            <select
              id="todoRepeat"
              title="任务重复周期"
              aria-label="任务重复周期"
              onchange="toggleCustomDays()"
            >
              <option value="none">不重复</option>
              <option value="daily">每天</option>
              <option value="3days">每3天</option>
              <option value="weekly">每周</option>
              <option value="monthly">每月</option>
              <option value="yearly">每年</option>
              <option value="custom">自定义天数</option>
            </select>
          </div>
          <div class="form-group" id="customDaysGroup" style="display: none">
            <label>自定义天数</label>
            <input
              type="number"
              id="todoCustomDays"
              placeholder="请输入重复天数"
              min="1"
              max="365"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
                outline: none;
              "
            />
          </div>
          <div class="form-group">
            <label>备注</label>
            <textarea
              id="todoNotes"
              placeholder="请输入备注信息（可选）"
              rows="3"
              style="
                width: 100%;
                padding: 0.8rem;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
                resize: vertical;
                outline: none;
                font-family: inherit;
              "
            ></textarea>
          </div>

          <button type="submit" class="btn" id="todoSubmitBtn">添加任务</button>
        </form>
      </div>
    </div>

    <!-- 添加任务按钮 -->
    <button
      class="add-todo-btn"
      onclick="showAddTodo()"
      id="addTodoBtn"
      style="opacity: 0; visibility: hidden"
    >
      +
    </button>

    <script>
      // 全局变量
      let currentUser = null;
      let todos = [];
      let isLoginMode = true;
      let showCompletedOnly = false;
      let showAllTasks = true;
      let showPendingOnly = false;
      let diamonds = 0;
      let lotteryCount = 0; // 钻石抽奖次数，用于保底计算
      let disciplineLotteryCount = 0; // 自律币抽奖次数，用于保底计算
      let disciplineCoins = 0; // 自律币数量

      // 等级和段位数据
      let levelData = {
        totalEfficientDays: 0, // 总高效天数
        currentLevel: 1, // 当前等级（1-256）
        currentExp: 0, // 当前等级经验值
        levelExpRequired: 5, // 当前等级升级所需天数

        currentRank: "青铜", // 当前段位
        currentRankIndex: 0, // 段位索引（0-7）
        currentStreak: 0, // 当前连续高效天数
        rankStreakRequired: 3, // 当前段位升段所需连续天数
        highestRank: "青铜", // 历史最高段位
      };

      // 在顶部导航栏添加自律币显示
      function addDisciplineCoinsToHeader() {
        // 检查自律币显示元素是否已经存在
        if (!document.getElementById("disciplineCoinsDisplay")) {
          // 找到现有的header-left
          const headerLeft = document.querySelector(".top-header .header-left");
          if (headerLeft) {
            // 直接在现有的header-left中添加自律币显示
            const disciplineCoinsElement = document.createElement("span");
            disciplineCoinsElement.id = "disciplineCoinsDisplay";
            disciplineCoinsElement.innerHTML =
              ' 自律币: <span id="topDisciplineCoins">0</span>';

            // 添加到header-left中
            headerLeft.appendChild(disciplineCoinsElement);
          }
        }
      }

      // 更新顶部导航栏的自律币显示
      function updateTopHeaderCurrencies() {
        const topDisciplineCoins =
          document.getElementById("topDisciplineCoins");
        if (topDisciplineCoins) {
          topDisciplineCoins.textContent = disciplineCoins;
        }
      }

      // 初始化
      document.addEventListener("DOMContentLoaded", function () {
        initApp();

        // 延迟添加自律币显示，确保header元素已经完全加载
        setTimeout(() => {
          addDisciplineCoinsToHeader();
        }, 100);
        
        // 设置每分钟整时检查一次过期任务
        setupExpiredTasksCheck();
      });
      
      // 设置每分钟整时检查过期任务的定时器
      function setupExpiredTasksCheck() {
        // 立即执行一次检查
        checkAndCleanExpiredTasks();
        
        // 计算距离下一个整分钟的时间（毫秒）
        const now = new Date();
        const millisecondsUntilNextMinute = (60 - now.getSeconds()) * 1000;
        
        // 在下一个整分钟时启动定时器
        setTimeout(() => {
          // 每分钟执行一次检查
          checkAndCleanExpiredTasks();
          setInterval(checkAndCleanExpiredTasks, 60000); // 60000毫秒 = 1分钟
        }, millisecondsUntilNextMinute);
      }
      
      // 检查并清理过期任务
      function checkAndCleanExpiredTasks() {
        if (!currentUser) return;
        
        // 获取当前用户的所有任务
        const userTodos = JSON.parse(localStorage.getItem("todos") || "{}");
        let todos = userTodos[currentUser] || [];
        
        // 记录原始任务数量
        const originalLength = todos.length;
        
        // 过滤掉过期的任务
        todos = todos.filter((todo) => {
          // 检查任务是否已过期（如果有截止日期且未完成）
          return !todo.deadline || 
            todo.completed || 
            new Date(todo.deadline) >= new Date();
        });
        
        // 如果有任务被删除了，保存更新后的列表并刷新UI
        if (todos.length < originalLength) {
          userTodos[currentUser] = todos;
          localStorage.setItem("todos", JSON.stringify(userTodos));
          
          // 只有在当前显示的是代办界面时才刷新UI
          const todoSection = document.getElementById("todoSection");
          if (todoSection && todoSection.classList.contains("active")) {
            loadTodos(); // 重新加载并渲染任务列表
          }
        }
      }

      // 显示公告板界面
      function showAnnouncementBoard() {
        const announcementBoard = document.getElementById("announcementBoard");
        announcementBoard.style.display = "flex";
        document.body.style.overflow = "hidden"; // 防止背景滚动
      }

      // 隐藏公告板界面
      function hideAnnouncementBoard() {
        const announcementBoard = document.getElementById("announcementBoard");
        announcementBoard.style.display = "none";
        document.body.style.overflow = ""; // 恢复背景滚动
      }

      // 在商城界面增加自律币兑换按钮
      function updateExchangeSection() {
        const exchangeSection = document.querySelector("#exchangeDiamonds");
        if (
          exchangeSection &&
          !document.querySelector("#exchangeDisciplineCoins")
        ) {
          const disciplineExchangeBtn = document.createElement("button");
          disciplineExchangeBtn.id = "exchangeDisciplineCoins";
          disciplineExchangeBtn.onclick = exchangeDisciplineCoins;
          disciplineExchangeBtn.style.cssText = `
            margin-top: 1rem;
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, #ffa502, #ff6348);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
          `;
          disciplineExchangeBtn.innerHTML = "25000 金币兑换 1 自律币";

          disciplineExchangeBtn.onmouseover = function () {
            this.style.transform = "scale(1.02)";
          };
          disciplineExchangeBtn.onmouseout = function () {
            this.style.transform = "scale(1)";
          };

          exchangeSection.parentNode.appendChild(disciplineExchangeBtn);
        }
      }

      // 监听商城界面切换，添加自律币兑换按钮
      document.addEventListener("click", function (e) {
        if (
          e.target.closest(".nav-item") &&
          e.target.closest(".nav-item").textContent.includes("商城")
        ) {
          setTimeout(updateExchangeSection, 500);
        }
      });

      // 抽奖功能
      function singleDraw() {
        if (coins < 100) {
          document.getElementById("lotteryResult").innerHTML =
            '<p style="color: #ff6b6b;">金币不足！需要100金币参与抽奖</p>';
          return;
        }

        coins -= 100;
        lotteryCount++;
        disciplineLotteryCount++;

        // 钻石中奖判定（5.1%概率或10抽保底）
        const isDiamondWin = Math.random() < 0.051 || lotteryCount >= 10;
        // 自律币中奖判定（0.6%概率或90抽保底）
        const isDisciplineWin =
          Math.random() < 0.006 || disciplineLotteryCount >= 90;

        let prizeType = "coin"; // 默认获得1金币

        if (isDisciplineWin) {
          // 自律币中奖（优先级高于钻石）
          disciplineCoins++;
          disciplineLotteryCount = 0;
          prizeType = "discipline";
        } else if (isDiamondWin) {
          // 钻石中奖
          diamonds++;
          lotteryCount = 0;
          prizeType = "diamond";
        } else {
          // 未中钻石和自律币，获得1金币
          coins++;
        }

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateTopHeaderCurrencies();

        let resultText, prizeIcon;
        switch (prizeType) {
          case "diamond":
            resultText = "恭喜获得钻石！";
            prizeIcon = "💎";
            break;
          case "discipline":
            resultText = "恭喜获得自律币！";
            prizeIcon = "🪙";
            break;
          default:
            resultText = "获得1金币！";
            prizeIcon = "💰";
        }

        // 添加动画效果的中奖显示
        const resultElement = document.getElementById("lotteryResult");
        resultElement.innerHTML = "";

        const resultDiv = document.createElement("div");
        resultDiv.style.cssText = `
          margin: 1rem 0;
          padding: 1.5rem;
          border-radius: 15px;
          text-align: center;
          transition: all 0.5s ease;
          position: relative;
          overflow: hidden;
        `;

        if (prizeType !== "coin") {
          // 中奖样式 (钻石或自律币)
          resultDiv.style.background =
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)";
          resultDiv.style.boxShadow = "0 10px 30px rgba(79, 172, 254, 0.5)";

          // 添加闪光效果
          const shine = document.createElement("div");
          shine.style.cssText = `
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
              to bottom right,
              rgba(255,255,255,0) 0%,
              rgba(255,255,255,0.8) 50%,
              rgba(255,255,255,0) 100%
            );
            transform: rotate(30deg);
            animation: shine 1s ease;
          `;
          resultDiv.appendChild(shine);
        }

        // 奖品图标
        const iconDiv = document.createElement("div");
        iconDiv.style.fontSize = "5rem";
        iconDiv.style.marginBottom = "1rem";
        iconDiv.style.animation = prizeType !== "coin" ? "bounce 1s ease" : "";
        iconDiv.textContent = prizeIcon;
        resultDiv.appendChild(iconDiv);

        // 结果文本
        const textStrong = document.createElement("strong");
        textStrong.style.fontSize = "1.5rem";
        textStrong.style.color = prizeType !== "coin" ? "#fff" : "#333";
        textStrong.textContent = resultText;
        resultDiv.appendChild(textStrong);

        // 换行
        resultDiv.appendChild(document.createElement("br"));

        // 详细信息
        const detailsDiv = document.createElement("div");
        detailsDiv.style.marginTop = "1rem";
        detailsDiv.style.color =
          prizeType !== "coin" ? "rgba(255,255,255,0.9)" : "#666";
        detailsDiv.innerHTML = `
          <br>剩余金币: ${coins}
          <br>当前钻石: ${diamonds}
          <br>钻石保底进度: ${lotteryCount}/10
          <br>自律币保底进度: ${disciplineLotteryCount}/90
        `;
        resultDiv.appendChild(detailsDiv);

        resultElement.appendChild(resultDiv);

        // 添加动画样式
        const style = document.createElement("style");
        style.textContent = `
          @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
          }
          @keyframes shine {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
          }
        `;
        document.head.appendChild(style);
        setTimeout(() => document.head.removeChild(style), 2000);

        showNotification(resultText);
      }

      function tenDraw() {
        if (coins < 1000) {
          document.getElementById("lotteryResult").innerHTML =
            '<p style="color: #ff6b6b;">金币不足！需要1000金币参与十连抽</p>';
          return;
        }

        coins -= 1000;
        let totalDiamonds = 0;
        let totalDisciplineCoins = 0;
        let results = [];

        for (let i = 0; i < 10; i++) {
          lotteryCount++;
          disciplineLotteryCount++;

          // 钻石中奖判定（5.1%概率或10抽保底）
          const isDiamondWin = Math.random() < 0.051 || lotteryCount >= 10;
          // 自律币中奖判定（0.6%概率或90抽保底）
          const isDisciplineWin =
            Math.random() < 0.006 || disciplineLotteryCount >= 90;

          let prizeType = "coin"; // 默认获得1金币

          if (isDisciplineWin) {
            // 自律币中奖（优先级高于钻石）
            disciplineCoins++;
            totalDisciplineCoins++;
            disciplineLotteryCount = 0;
            prizeType = "discipline";
          } else if (isDiamondWin) {
            // 钻石中奖
            diamonds++;
            totalDiamonds++;
            lotteryCount = 0;
            prizeType = "diamond";
          } else {
            // 未中钻石和自律币，获得1金币
            coins++;
          }

          // 添加结果
          switch (prizeType) {
            case "diamond":
              results.push("💎 钻石");
              break;
            case "discipline":
              results.push("🪙 自律币");
              break;
            default:
              results.push("💰 1金币");
          }
        }

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateTopHeaderCurrencies();

        let resultText;
        if (totalDisciplineCoins > 0) {
          resultText = `恭喜获得自律币 x${totalDisciplineCoins}！${
            totalDiamonds > 0 ? `并获得钻石 x${totalDiamonds}！` : ""
          }`;
        } else if (totalDiamonds > 0) {
          resultText = `恭喜获得钻石 x${totalDiamonds}！`;
        } else {
          resultText = "获得了一些金币！";
        }

        // 增强的十连抽结果显示
        const resultElement = document.getElementById("lotteryResult");
        resultElement.innerHTML = "";

        const resultDiv = document.createElement("div");
        resultDiv.style.cssText = `
          margin: 1rem 0;
          padding: 1.5rem;
          border-radius: 15px;
          text-align: center;
        `;

        if (totalDiamonds > 0) {
          // 有中奖的样式
          resultDiv.style.background =
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)";
          resultDiv.style.boxShadow = "0 10px 30px rgba(79, 172, 254, 0.5)";
        } else {
          // 未中奖的样式
          resultDiv.style.background = "#f8f9fa";
        }

        // 结果文本
        const textStrong = document.createElement("strong");
        textStrong.style.fontSize = "1.5rem";
        textStrong.style.color = totalDiamonds > 0 ? "#fff" : "#333";
        textStrong.textContent = resultText;
        resultDiv.appendChild(textStrong);

        // 详细信息
        const detailsDiv = document.createElement("div");
        detailsDiv.style.marginTop = "1rem";
        detailsDiv.style.color =
          totalDiamonds > 0 ? "rgba(255,255,255,0.9)" : "#666";
        detailsDiv.innerHTML = `
          <br>剩余金币: ${coins}
          <br>当前钻石: ${diamonds}
          <br>钻石保底进度: ${lotteryCount}/10
          <br>自律币保底进度: ${disciplineLotteryCount}/90
        `;
        resultDiv.appendChild(detailsDiv);

        // 十连抽结果列表
        const resultsHeader = document.createElement("div");
        resultsHeader.style.marginTop = "1rem";
        resultsHeader.style.fontWeight = "bold";
        resultsHeader.style.color =
          totalDiamonds > 0 ? "rgba(255,255,255,0.9)" : "#333";
        resultsHeader.textContent = "十连抽结果:";
        resultDiv.appendChild(resultsHeader);

        const resultsGrid = document.createElement("div");
        resultsGrid.style.display = "flex";
        resultsGrid.style.flexWrap = "wrap";
        resultsGrid.style.justifyContent = "center";
        resultsGrid.style.gap = "0.5rem";
        resultsGrid.style.marginTop = "0.5rem";

        // 逐个添加结果，带延迟动画
        results.forEach((result, index) => {
          const resultItem = document.createElement("div");
          const isItemWin =
            result.includes("钻石") || result.includes("自律币");

          resultItem.style.cssText = `
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
          `;

          if (isItemWin) {
            resultItem.style.background = "rgba(255,255,255,0.2)";
            resultItem.style.color = "#fff";
            resultItem.style.boxShadow = "0 2px 8px rgba(255,255,255,0.3)";
          } else {
            resultItem.style.background = "rgba(255,255,255,0.8)";
            resultItem.style.color = "#666";
          }

          resultItem.textContent = result;
          resultsGrid.appendChild(resultItem);

          // 延迟显示动画
          setTimeout(() => {
            resultItem.style.opacity = "1";
            resultItem.style.transform = "scale(1)";
          }, index * 150);
        });

        resultDiv.appendChild(resultsGrid);
        resultElement.appendChild(resultDiv);

        showNotification(resultText);
      }

      // 确保disciplineCoins变量在全局作用域中已经声明

      function exchangeDiamonds() {
        const exchangeRate = 900;
        if (coins < exchangeRate) {
          document.getElementById(
            "exchangeResult"
          ).innerHTML = `<p style="color: #ff6b6b;">金币不足！需要${exchangeRate}金币兑换1颗钻石</p>`;
          return;
        }

        coins -= exchangeRate;
        diamonds++;

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateDisciplineCoinDisplay();
        updateTopHeaderCurrencies();

        document.getElementById("exchangeResult").innerHTML = `
            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
              <strong>兑换成功！</strong>
              <br>消耗金币: ${exchangeRate}
              <br>获得钻石: 1
              <br>剩余金币: ${coins}
              <br>当前钻石: ${diamonds}
            </div>
          `;

        showNotification("成功兑换1颗钻石！");
      }

      function exchangeDisciplineCoins() {
        const exchangeRate = 25000;
        if (coins < exchangeRate) {
          document.getElementById(
            "exchangeResult"
          ).innerHTML = `<p style="color: #ff6b6b;">金币不足！需要${exchangeRate}金币兑换1枚自律币</p>`;
          return;
        }

        coins -= exchangeRate;
        disciplineCoins++;

        saveUserData();
        updateCoinDisplay();
        updateDisciplineCoinDisplay();
        updateTopHeaderCurrencies();

        document.getElementById("exchangeResult").innerHTML = `
            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
              <strong>兑换成功！</strong>
              <br>消耗金币: ${exchangeRate}
              <br>获得自律币: 1
              <br>剩余金币: ${coins}
              <br>当前自律币: ${disciplineCoins}
            </div>
          `;

        showNotification("成功兑换1枚自律币！");
      }

      // 将钻石兑换回金币
      function convertDiamondsToCoins() {
        const exchangeRate = 900;
        if (diamonds < 1) {
          document.getElementById(
            "exchangeResult"
          ).innerHTML = `<p style="color: #ff6b6b;">钻石不足！需要1颗钻石进行兑换</p>`;
          return;
        }

        diamonds--;
        coins += exchangeRate;

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateDisciplineCoinDisplay();
        updateTopHeaderCurrencies();

        document.getElementById("exchangeResult").innerHTML = `
            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
              <strong>兑换成功！</strong>
              <br>消耗钻石: 1
              <br>获得金币: ${exchangeRate}
              <br>剩余金币: ${coins}
              <br>当前钻石: ${diamonds}
            </div>
          `;

        showNotification("成功将1颗钻石兑换为900金币！");
      }

      // 将自律币兑换回金币
      function convertDisciplineCoinsToCoins() {
        const exchangeRate = 25000;
        if (disciplineCoins < 1) {
          document.getElementById(
            "exchangeResult"
          ).innerHTML = `<p style="color: #ff6b6b;">自律币不足！需要1枚自律币进行兑换</p>`;
          return;
        }

        disciplineCoins--;
        coins += exchangeRate;

        saveUserData();
        updateCoinDisplay();
        updateDiamondDisplay();
        updateDisciplineCoinDisplay();
        updateTopHeaderCurrencies();

        document.getElementById("exchangeResult").innerHTML = `
            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
              <strong>兑换成功！</strong>
              <br>消耗自律币: 1
              <br>获得金币: ${exchangeRate}
              <br>剩余金币: ${coins}
              <br>当前自律币: ${disciplineCoins}
            </div>
          `;

        showNotification("成功将1枚自律币兑换为25000金币！");
      }

      function updateDiamondDisplay() {
        const diamondElements = document.querySelectorAll(
          "#diamondCount, #exchangeDiamondCount, #profileDiamonds, #headerDiamonds"
        );
        diamondElements.forEach((el) => (el.textContent = diamonds));

        // 更新保底显示
        const guaranteeEl = document.getElementById("guaranteeCount");
        if (guaranteeEl) {
          guaranteeEl.textContent = lotteryCount;
        }

        const disciplineGuaranteeEl = document.getElementById(
          "disciplineGuaranteeCount"
        );
        if (disciplineGuaranteeEl) {
          disciplineGuaranteeEl.textContent = disciplineLotteryCount;
        }
      }

      function updateDisciplineCoinDisplay() {
        const disciplineCoinElements = document.querySelectorAll(
          "#profileDisciplineCoins, #disciplineCoinCount"
        );
        disciplineCoinElements.forEach(
          (el) => (el.textContent = disciplineCoins)
        );
      }

      // 统一保存用户数据
      function saveUserData() {
        const users = JSON.parse(localStorage.getItem("users") || "{}");
        if (users[currentUser]) {
          users[currentUser].coins = coins;
          users[currentUser].diamonds = diamonds;
          users[currentUser].disciplineCoins = disciplineCoins;
          users[currentUser].lotteryCount = lotteryCount;
          users[currentUser].disciplineLotteryCount = disciplineLotteryCount;
          users[currentUser].levelData = levelData;
          localStorage.setItem("users", JSON.stringify(users));
        }
      }

      // 更新金币显示
      function updateCoinDisplay() {
        const coinElements = document.querySelectorAll(
          "#headerCoins, #profileCoins"
        );
        coinElements.forEach((el) => (el.textContent = coins));
      }

      // 将showNotification函数附加到window对象，确保全局可访问
      window.showNotification = function (title, message) {
        // 如果只有一个参数，则将其作为消息，标题默认为空
        if (arguments.length === 1) {
          message = title;
          title = "";
        }

        // 创建通知元素
        const notification = document.createElement("div");
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            animation: fadeInOut 3s ease-in-out;
            font-weight: bold;
          `;

        // 设置通知内容
        if (title) {
          notification.innerHTML = `<strong>${title}：</strong>${message}`;
        } else {
          notification.textContent = message;
        }

        document.body.appendChild(notification);

        // 3秒后移除
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 3000);
      };

      // 保持原函数名的兼容性
      function showNotification(title, message) {
        window.showNotification(title, message);
      }

      // 显示空白页面
      function showEmptyPage(toolName) {
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        // 检查元素是否存在
        if (!emptyPageContainer || !emptyPageTitle) {
          console.warn("无法找到空白页面元素");
          return;
        }

        // 设置页面标题并显示容器
        emptyPageTitle.textContent = toolName;
        emptyPageContainer.style.display = "block";

        console.log(`showEmptyPage被调用，工具名: ${toolName}`);

        // 清除容器内容，准备添加新内容
        // 先保存标题元素
        let titleElement = null;
        for (let i = 0; i < emptyPageContainer.children.length; i++) {
          if (emptyPageContainer.children[i].id === "emptyPageTitle") {
            titleElement = emptyPageContainer.children[i];
            break;
          }
        }

        // 清空所有子元素
        emptyPageContainer.innerHTML = "";

        // 重新添加标题元素
        if (titleElement) {
          emptyPageContainer.appendChild(titleElement);
        }

        // 确保标题显示正确
        emptyPageTitle.textContent = toolName;

        // 滚动到空白页面位置
        emptyPageContainer.scrollIntoView({
          behavior: "smooth",
          block: "start",
        });

        // 为特定工具提供特殊处理
        if (toolName === "番茄钟") {
          showTomatoClock();
        } else if (toolName === "锁机") {
          console.log("调用initLockScreen函数");
          try {
            initLockScreen();
          } catch (error) {
            console.error("initLockScreen函数执行失败:", error);
            showNotification("错误", "锁机功能加载失败");
          }
        } else if (toolName === "屏蔽网站") {
          try {
            showWebsiteBlocker();
          } catch (error) {
            console.error("showWebsiteBlocker函数执行失败:", error);
            showNotification("错误", "屏蔽网站功能加载失败");
          }
        } else {
          // 对于其他工具，显示默认的占位符
          const placeholder = document.createElement("div");
          // 不再添加默认的"该功能正在开发中"占位文本
          // emptyPageContainer现在只包含emptyPageTitle元素
        }
      }

      // 番茄钟功能实现
      function showTomatoClock() {
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");

        // 检查元素是否存在
        if (!emptyPageContainer) {
          console.warn("无法找到空白页面容器");
          return;
        }

        // 清空容器，保留标题元素
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild.id === "emptyPageTitle") {
            break;
          }
          emptyPageContainer.removeChild(emptyPageContainer.firstChild);
        }

        // 创建番茄钟界面
        const tomatoClockContainer = document.createElement("div");
        tomatoClockContainer.className = "tomato-clock-container";
        tomatoClockContainer.style.cssText = `
          background: rgba(255, 255, 255, var(--text-box-opacity));
          border-radius: 15px;
          padding: 2rem;
          margin: 1rem auto;
          max-width: 500px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        `;

        // 番茄钟HTML结构
        tomatoClockContainer.innerHTML = `
          <div id="tomatoClockSettings" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h4 style="color: var(--primary-color); margin: 0;">设置</h4>
              <button id="closeTomatoClock" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #666;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s ease;
              " onmouseover="this.style.backgroundColor='rgba(0,0,0,0.05)'; this.style.color='#333';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#666';">
                ×
              </button>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 1; min-width: 150px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">专注时间（分钟）</label>
                <input type="number" id="focusTime" min="1" max="120" value="25" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
              <div style="flex: 1; min-width: 150px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">休息时间（分钟）</label>
                <input type="number" id="breakTime" min="1" max="60" value="5" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
            </div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 1; min-width: 150px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">重复次数</label>
                <input type="number" id="repeatCount" min="1" max="10" value="1" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
              <div style="flex: 1; min-width: 150px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">提示音</label>
                <select id="notificationSound" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
                  <option value="ding">提示音1</option>
                  <option value="beep">提示音2</option>
                  <option value="chime">提示音3</option>
                  <option value="upload">上传自定义</option>
                  <option value="none">静音</option>
                </select>
                <input type="file" id="customSound" accept="audio/*" style="display: none;">
              </div>
            </div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 2; min-width: 300px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">任务名称</label>
                <input type="text" id="taskName" placeholder="请输入任务名称" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
            </div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 2; min-width: 300px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">鼓励语</label>
                <textarea id="encouragementText" placeholder="请输入鼓励语，在专注进行中显示" rows="2" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  resize: vertical;
                  outline: none;
                "></textarea>
              </div>
            </div>
          </div>
          
          <div id="tomatoClockDisplay" style="text-align: center; margin-bottom: 2rem;">
            <div id="taskNameDisplay" style="font-size: 1.2rem; font-weight: bold; color: #555; margin-bottom: 0.5rem;"></div>
            <div id="timeDisplay" style="font-size: 8rem; font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem; text-shadow: 3px 3px 6px rgba(0,0,0,0.1); transition: all 0.3s ease;">25:00</div>
            <div id="encouragementDisplay" style="font-size: 1.1rem; color: #666; font-style: italic; margin-bottom: 0.5rem;"></div>
            <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 1rem;">准备开始专注</div>
            <div style="display: flex; justify-content: center; gap: 1rem;">
              <button id="startTomato" class="btn" style="background: var(--primary-color); color: white;">开始</button>
            </div>
            <div id="abandonIcon" style="display: none; font-size: 10rem; color: #f44336; margin-top: 1rem;">✗</div>
          </div>
        `;

        // 添加到容器
        emptyPageContainer.appendChild(tomatoClockContainer);

        // 初始化番茄钟
        if (typeof initTomatoClock === "function") {
          initTomatoClock();
        } else {
          console.warn("initTomatoClock函数未定义，但番茄钟界面已加载完成");
        }
      }

      // 锁机功能实现
      function initLockScreen() {
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        if (!emptyPageContainer) {
          console.error("无法找到空白页面容器");
          showNotification("错误", "无法找到空白页面元素");
          return;
        }

        // 清空容器但保留标题元素
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild !== emptyPageTitle) {
            emptyPageContainer.removeChild(emptyPageContainer.firstChild);
          } else {
            break;
          }
        }

        // 创建锁机界面
        const lockScreenContainer = document.createElement("div");
        lockScreenContainer.className = "lock-screen-container";
        lockScreenContainer.style.cssText = `
          background: rgba(255, 255, 255, var(--text-box-opacity));
          border-radius: 15px;
          padding: 2rem;
          margin: 1rem auto;
          max-width: 600px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        `;

        // 锁机HTML结构
        lockScreenContainer.innerHTML = `
          <div style="margin-bottom: 2rem;">
            <h4 style="color: var(--primary-color); margin: 0 0 1.5rem 0;">锁机设置</h4>
            
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
              <div style="flex: 1; min-width: 200px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">锁机时长（分钟）</label>
                <input type="number" id="lockDuration" min="1" max="180" value="30" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
              <div style="flex: 1; min-width: 200px;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">解锁密码</label>
                <input type="password" id="lockPassword" placeholder="设置解锁密码" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  outline: none;
                ">
              </div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
              <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">白名单应用（每行一个，例如 chrome.exe）</label>
              <textarea id="whitelistApps" placeholder="
chrome.exe
code.exe
notepad.exe
" rows="6" style="
                width: 100%;
                padding: 0.7rem;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 1rem;
                font-family: monospace;
                resize: vertical;
                outline: none;
              "></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
              <button id="startLockScreen" class="btn" style="background: var(--primary-color); color: white; flex: 1;">开始锁机</button>
              <button id="saveWhitelist" class="btn" style="background: #6c757d; color: white; flex: 1;">保存白名单</button>
            </div>
          </div>
          
          <div style="text-align: center; margin-bottom: 2rem;">
            <div id="lockStatus" style="font-size: 1.2rem; color: #666; margin-bottom: 1rem;">未锁机</div>
            <div id="lockCountdown" style="display: none; font-size: 4rem; font-weight: bold; color: var(--primary-color); margin-bottom: 1rem;">00:00</div>
            <div id="allowedApps" style="display: none; margin-top: 1rem;">
              <h5 style="color: #666; margin: 0 0 0.5rem 0;">允许运行的应用：</h5>
              <div id="allowedAppsList" style="text-align: left; font-family: monospace; font-size: 0.9rem; color: #555;"></div>
            </div>
          </div>
        `;

        // 添加到容器
        emptyPageContainer.appendChild(lockScreenContainer);

        // 加载保存的白名单
        const savedWhitelist = localStorage.getItem("lockScreenWhitelist");
        if (savedWhitelist) {
          document.getElementById("whitelistApps").value = savedWhitelist;
        }

        // 更新允许应用列表显示
        updateAllowedAppsList();

        // 添加事件监听器
        document
          .getElementById("startLockScreen")
          .addEventListener("click", startLockScreen);
        document
          .getElementById("saveWhitelist")
          .addEventListener("click", saveWhitelist);

        // 保存白名单函数
        function saveWhitelist() {
          const whitelistApps = document.getElementById("whitelistApps").value;
          localStorage.setItem("lockScreenWhitelist", whitelistApps);
          updateAllowedAppsList();
          showNotification("成功", "白名单已保存");
        }

        // 更新允许应用列表显示
        function updateAllowedAppsList() {
          const whitelistApps = document.getElementById("whitelistApps").value;
          const allowedAppsList = document.getElementById("allowedAppsList");
          const allowedAppsDiv = document.getElementById("allowedApps");

          if (whitelistApps.trim() === "") {
            allowedAppsDiv.style.display = "none";
            return;
          }

          allowedAppsDiv.style.display = "block";
          const apps = whitelistApps
            .split("\n")
            .filter((app) => app.trim() !== "");
          allowedAppsList.innerHTML = "";

          apps.forEach((app) => {
            const appItem = document.createElement("div");
            appItem.style.cssText = `
              padding: 0.2rem 0;
              border-bottom: 1px solid #eee;
            `;
            appItem.textContent = app.trim();
            allowedAppsList.appendChild(appItem);
          });
        }

        // 开始锁机函数
        function startLockScreen() {
          console.log("开始锁机函数被调用");

          // 确保所有需要的元素都存在
          const lockDuration = document.getElementById("lockDuration");
          const lockPassword = document.getElementById("lockPassword");
          const whitelistApps = document.getElementById("whitelistApps");
          const lockStatus = document.getElementById("lockStatus");
          const lockCountdown = document.getElementById("lockCountdown");

          if (
            !lockDuration ||
            !lockPassword ||
            !whitelistApps ||
            !lockStatus ||
            !lockCountdown
          ) {
            console.error("锁机相关元素未找到");
            showNotification("错误", "锁机功能初始化失败，请刷新页面重试");
            return;
          }

          const duration = parseInt(lockDuration.value) || 30;
          const password = lockPassword.value;
          const whitelistAppsValue = whitelistApps.value;

          // 验证输入
          if (duration < 1 || duration > 180) {
            showNotification("错误", "锁机时长应在1-180分钟之间");
            return;
          }

          if (password.length < 4) {
            showNotification("错误", "密码长度至少为4位");
            return;
          }

          // 保存设置
          localStorage.setItem(
            "lockScreenSettings",
            JSON.stringify({
              duration: duration,
              password: password,
              whitelistApps: whitelistAppsValue,
            })
          );

          // 显示锁机状态
          lockStatus.textContent = "已锁机";
          lockCountdown.style.display = "block";

          // 计算结束时间
          const endTime = new Date().getTime() + duration * 60 * 1000;
          localStorage.setItem("lockScreenEndTime", endTime);

          // 开始倒计时
          updateCountdown();
          const countdownInterval = setInterval(updateCountdown, 1000);

          // 显示锁机警告
          showNotification(
            "提示",
            `电脑将在${duration}分钟后解锁，白名单应用可正常使用`
          );

          // 启动锁机监控（注意：这只是模拟，实际监控需要后端支持）
          const lockMonitorInterval = setInterval(monitorRunningApps, 5000);

          console.log("尝试显示解锁界面");
          // 立即显示全屏锁界面
          setTimeout(() => {
            if (window.showUnlockScreen) {
              console.log("调用window.showUnlockScreen()");
              window.showUnlockScreen();
            } else {
              console.error("window.showUnlockScreen() 函数未定义");
            }
          }, 1000);

          // 倒计时更新函数
          function updateCountdown() {
            const now = new Date().getTime();
            const timeLeft = endTime - now;

            if (timeLeft <= 0) {
              clearInterval(countdownInterval);
              clearInterval(lockMonitorInterval);
              document.getElementById("lockStatus").textContent = "已解锁";
              document.getElementById("lockCountdown").style.display = "none";
              localStorage.removeItem("lockScreenEndTime");
              showNotification("完成", "电脑已解锁");
              return;
            }

            const minutes = Math.floor(
              (timeLeft % (1000 * 60 * 60)) / (1000 * 60)
            );
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            document.getElementById("lockCountdown").textContent = `${minutes
              .toString()
              .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
          }

          // 监控运行应用函数（模拟）
          function monitorRunningApps() {
            // 注意：在实际环境中，这需要使用Windows API或其他系统级API
            // 这里我们只是模拟检查
            console.log("监控运行中的应用...");
            // 在实际实现中，这里应该调用后端脚本来检查运行的进程
            // 并与白名单进行对比
          }
        }
      }

      // 显示通知函数
      function showNotification(title, message) {
        // 获取设置区域下方的位置
        const settingsContainer =
          document.getElementById("tomatoClockSettings") || document.body;
        const notificationPosition = settingsContainer.getBoundingClientRect();

        // 创建通知元素
        const notification = document.createElement("div");
        notification.style.cssText = `
            position: fixed;
            left: 50%;
            top: ${notificationPosition.bottom + 10}px;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
          `;

        // 根据标题决定显示对号还是其他图标
        const icon =
          title.includes("完成") || title.includes("成功")
            ? "✅"
            : title.includes("结束")
            ? "🔔"
            : "❓";

        notification.innerHTML = `
            <div style="font-size: 1.5rem;">${icon}</div>
            <div>
              <h4 style="margin: 0 0 5px 0;">${title}</h4>
              <p style="margin: 0; font-size: 0.9rem;">${message}</p>
            </div>
          `;

        // 添加到页面
        document.body.appendChild(notification);

        // 显示通知
        setTimeout(() => {
          notification.style.opacity = "1";
        }, 10);

        // 3秒后隐藏通知
        setTimeout(() => {
          notification.style.opacity = "0";
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      // 番茄钟核心逻辑
      function initTomatoClock() {
        // 获取元素引用并设置为全局变量
        window.focusTimeInput = document.getElementById("focusTime") || {
          value: 25,
        };
        window.breakTimeInput = document.getElementById("breakTime") || {
          value: 5,
        };
        window.repeatCountInput = document.getElementById("repeatCount") || {
          value: 1,
        };
        window.notificationSoundSelect = document.getElementById(
          "notificationSound"
        ) || { value: "ding" };
        window.customSoundInput = document.getElementById("customSound") || {};
        window.taskNameInput = document.getElementById("taskName") || {
          value: "",
        };
        window.encouragementTextInput = document.getElementById(
          "encouragementText"
        ) || { value: "你做得很棒！继续保持！" };
        window.taskNameDisplay =
          document.getElementById("taskNameDisplay") ||
          document.createElement("div");
        window.encouragementDisplay =
          document.getElementById("encouragementDisplay") ||
          document.createElement("div");
        window.timeDisplay =
          document.querySelector("#tomatoClockDisplay > div:nth-child(2)") ||
          document.createElement("div");
        window.statusDisplay =
          document.querySelector("#tomatoClockDisplay > div:nth-child(3)") ||
          document.createElement("div");
        window.startButton =
          document.getElementById("startTomato") ||
          document.createElement("button");
        window.settingsContainer =
          document.getElementById("tomatoClockSettings") ||
          document.createElement("div");
        window.abandonIcon =
          document.getElementById("abandonIcon") ||
          document.createElement("div");

        // 先定义变量，再添加事件监听器
        let timerInterval = null;
        let currentTime = 0;
        let totalTime = 0;
        let isFocusMode = true;
        let isPaused = false;
        let notificationSound = "ding";
        let customSound = null;
        let taskName = "";
        let encouragementText = "你做得很棒！继续保持！";

        // 创建默认声音元素
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();

        // 为时间输入框添加事件监听器，实时更新时间显示
        if (window.focusTimeInput && window.timeDisplay) {
          window.focusTimeInput.addEventListener("input", function () {
            // 允许输入框为空，只有在有值时才验证范围
            if (window.focusTimeInput.value.trim() !== "") {
              const value = parseInt(window.focusTimeInput.value) || 25;
              const validValue = Math.max(1, Math.min(120, value));
              window.focusTimeInput.value = validValue;
            }

            // 只有在番茄钟未开始时才更新显示
            if (!timerInterval) {
              const focusMinutes = parseInt(window.focusTimeInput.value) || 25;
              window.timeDisplay.textContent = formatTime(focusMinutes * 60);
            }
          });
        }

        if (window.breakTimeInput && window.timeDisplay) {
          window.breakTimeInput.addEventListener("input", function () {
            // 允许输入框为空，只有在有值时才验证范围
            if (window.breakTimeInput.value.trim() !== "") {
              const value = parseInt(window.breakTimeInput.value) || 5;
              const validValue = Math.max(1, Math.min(60, value));
              window.breakTimeInput.value = validValue;
            }
          });
        }

        // 格式化时间显示
        function formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins.toString().padStart(2, "0")}:${secs
            .toString()
            .padStart(2, "0")}`;
        }

        // 播放提示音
        function playNotificationSound() {
          if (notificationSound === "none") return;

          try {
            // 简单的声音合成函数
            function generateSound(type) {
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();

              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);

              switch (type) {
                case "ding":
                  oscillator.type = "sine";
                  oscillator.frequency.setValueAtTime(
                    880,
                    audioContext.currentTime
                  );
                  oscillator.frequency.exponentialRampToValueAtTime(
                    440,
                    audioContext.currentTime + 0.5
                  );
                  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 1.5
                  );
                  oscillator.start();
                  oscillator.stop(audioContext.currentTime + 1.5);
                  break;
                case "beep":
                  oscillator.type = "square";
                  oscillator.frequency.setValueAtTime(
                    1000,
                    audioContext.currentTime
                  );
                  gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 0.5
                  );
                  oscillator.start();
                  oscillator.stop(audioContext.currentTime + 0.5);

                  // 第二声
                  setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    osc2.type = "square";
                    osc2.frequency.setValueAtTime(
                      800,
                      audioContext.currentTime
                    );
                    gain2.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(
                      0.01,
                      audioContext.currentTime + 0.5
                    );
                    osc2.start();
                    osc2.stop(audioContext.currentTime + 0.5);
                  }, 300);
                  break;
                case "chime":
                  oscillator.type = "sine";
                  oscillator.frequency.setValueAtTime(
                    523.25,
                    audioContext.currentTime
                  ); // C5
                  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 2
                  );

                  // 添加谐波
                  const osc2 = audioContext.createOscillator();
                  const gain2 = audioContext.createGain();
                  osc2.connect(gain2);
                  gain2.connect(audioContext.destination);
                  osc2.type = "sine";
                  osc2.frequency.setValueAtTime(
                    783.99,
                    audioContext.currentTime
                  ); // G5
                  gain2.gain.setValueAtTime(0.15, audioContext.currentTime);
                  gain2.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 2
                  );

                  oscillator.start();
                  osc2.start();
                  oscillator.stop(audioContext.currentTime + 2);
                  osc2.stop(audioContext.currentTime + 2);
                  break;
              }
            }

            // 播放内置声音或自定义声音
            if (notificationSound === "upload" && customSound) {
              const audio = new Audio(URL.createObjectURL(customSound));
              audio.play();
            } else {
              generateSound(notificationSound);
            }
          } catch (e) {
            console.error("播放声音失败:", e);
          }
        }

        // 开始番茄钟
        function startTomatoClock() {
          // 获取设置值，确保当专注时间输入框为空时默认使用25分钟
          const focusMinutes = parseInt(window.focusTimeInput.value) || 25;
          const breakMinutes = parseInt(window.breakTimeInput.value) || 5;
          repeatCount = parseInt(window.repeatCountInput.value) || 1;
          notificationSound = window.notificationSoundSelect.value;
          taskName = window.taskNameInput.value || "";
          encouragementText =
            window.encouragementTextInput.value || "你做得很棒！继续保持！";

          // 初始化
          isFocusMode = true;
          currentRepeat = 0;
          currentTime = focusMinutes * 60;
          totalTime = currentTime;

          // 更新显示
          if (window.timeDisplay)
            window.timeDisplay.textContent = formatTime(currentTime);
          // 状态文本不那么突出
          if (window.statusDisplay)
            window.statusDisplay.textContent = "专注中...";
          if (window.taskNameDisplay)
            window.taskNameDisplay.textContent = taskName
              ? `正在专注：${taskName}`
              : "";
          if (window.abandonIcon) window.abandonIcon.style.display = "none";
          if (window.encouragementDisplay)
            window.encouragementDisplay.textContent = encouragementText;

          // 已移除进度点功能

          // 隐藏设置
          window.settingsContainer.style.display = "none";

          // 更新按钮
          window.startButton.textContent = "暂停";

          // 添加控制按钮
          if (document.getElementById("resumeTomato")) return;

          const controlsDiv = startButton && startButton.parentElement;
          if (!controlsDiv) return;

          controlsDiv.innerHTML = "";

          const pauseButton = document.createElement("button");
          pauseButton.id = "pauseTomato";
          pauseButton.className = "btn";
          pauseButton.style.backgroundColor = "#ff9800";
          pauseButton.style.color = "white";
          pauseButton.textContent = "暂停";
          pauseButton.onclick = pauseTomatoClock;

          const resetButton = document.createElement("button");
          resetButton.id = "resetTomato";
          resetButton.className = "btn";
          resetButton.style.backgroundColor = "#f44336";
          resetButton.style.color = "white";
          resetButton.textContent = "放弃";
          resetButton.onclick = resetTomatoClock;

          controlsDiv.appendChild(pauseButton);
          controlsDiv.appendChild(resetButton);

          // 开始计时
          if (timerInterval) clearInterval(timerInterval);
          timerInterval = setInterval(updateTomatoClock, 1000);
        }

        // 暂停番茄钟
        function pauseTomatoClock() {
          if (isPaused) {
            // 恢复
            if (!timerInterval) {
              timerInterval = setInterval(updateTomatoClock, 1000);
            }
            document.getElementById("pauseTomato").textContent = "暂停";
            // 状态文本不那么突出
            window.statusDisplay.textContent = isFocusMode
              ? "专注中..."
              : "休息中...";
            // 恢复时，如果是专注模式则显示鼓励语
            if (isFocusMode && window.encouragementDisplay) {
              window.encouragementDisplay.textContent = encouragementText;
            }
          } else {
            // 暂停
            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }
            document.getElementById("pauseTomato").textContent = "继续";
            // 状态文本不那么突出
            statusDisplay.textContent = "已暂停专注";
            // 暂停时清空鼓励语
            if (encouragementDisplay) {
              encouragementDisplay.textContent = "";
            }
          }
          isPaused = !isPaused;
        }

        // 重置番茄钟
        function resetTomatoClock() {
          clearInterval(timerInterval);
          timerInterval = null;
          isPaused = false;

          // 显示设置
          window.settingsContainer.style.display = "block";

          // 更新显示
          const focusMinutes = parseInt(window.focusTimeInput.value) || 25;
          if (window.timeDisplay)
            window.timeDisplay.textContent = formatTime(focusMinutes * 60);
          // 状态文本不那么突出
          if (window.statusDisplay)
            window.statusDisplay.textContent = "准备开始专注...";
          if (window.taskNameDisplay) window.taskNameDisplay.textContent = "";
          if (window.encouragementDisplay)
            window.encouragementDisplay.textContent = "";

          // 使用与完成任务相同的方式显示叉号图标
          const abandonIcon = document.createElement("div");
          abandonIcon.style.cssText = `
            position: fixed;
            left: 50%;
            top: 30%;
            transform: translateX(-50%);
            font-size: 8rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
          `;
          abandonIcon.textContent = "✗";
          document.body.appendChild(abandonIcon);

          setTimeout(() => {
            abandonIcon.style.opacity = "1";
          }, 10);

          // 3秒后隐藏图标
          setTimeout(() => {
            abandonIcon.style.opacity = "0";
            setTimeout(() => {
              if (document.body.contains(abandonIcon)) {
                document.body.removeChild(abandonIcon);
              }
            }, 300);
          }, 2500);

          // 更新按钮
          const controlsDiv =
            document.getElementById("pauseTomato").parentElement;
          controlsDiv.innerHTML = "";

          const startButton = document.createElement("button");
          startButton.id = "startTomato";
          startButton.className = "btn";
          startButton.style.backgroundColor = "var(--primary-color)";
          startButton.style.color = "white";
          startButton.textContent = "开始";
          startButton.onclick = startTomatoClock;

          controlsDiv.appendChild(startButton);
        }

        // 更新番茄钟
        function updateTomatoClock() {
          if (currentTime <= 0) {
            // 清除定时器
            if (timerInterval) {
              clearInterval(timerInterval);
              timerInterval = null;
            }

            // 播放提示音
            playNotificationSound();

            // 显示通知
            if (isFocusMode) {
              showNotification("专注时间结束！", encouragementText);
            } else {
              showNotification("休息时间结束！", "准备开始下一个专注时段");
            }

            if (isFocusMode) {
              // 专注时间结束
              // 所有重复完成
              window.statusDisplay.textContent = "专注时间已完成！";

              // 在设置下方显示完成图标
              const completionIcon = document.createElement("div");
              completionIcon.style.cssText = `
                  position: fixed;
                  left: 50%;
                  top: 30%;
                  transform: translateX(-50%);
                  font-size: 8rem;
                  z-index: 1000;
                  opacity: 0;
                  transition: opacity 0.3s ease;
                `;
              completionIcon.textContent = "✅";
              document.body.appendChild(completionIcon);

              setTimeout(() => {
                completionIcon.style.opacity = "1";
              }, 10);

              // 3秒后隐藏图标，不再自动重置番茄钟，让用户手动操作
              setTimeout(() => {
                completionIcon.style.opacity = "0";
                setTimeout(() => {
                  if (document.body.contains(completionIcon)) {
                    document.body.removeChild(completionIcon);
                  }
                }, 300);
              }, 2500);
            } else {
              // 休息时间结束
              isFocusMode = true;
              const focusMinutes = parseInt(window.focusTimeInput.value) || 25;
              currentTime = focusMinutes * 60;
              totalTime = currentTime;

              // 更新显示
              if (window.timeDisplay)
                window.timeDisplay.textContent = formatTime(currentTime);
              // 状态文本不那么突出
              if (window.statusDisplay)
                window.statusDisplay.textContent = "专注中...";
              if (window.taskNameDisplay)
                window.taskNameDisplay.textContent = taskName
                  ? `正在专注：${taskName}`
                  : "";
              if (window.encouragementDisplay)
                window.encouragementDisplay.textContent = encouragementText;

              // 开始专注计时 - 确保不会重复设置定时器
              if (!timerInterval) {
                timerInterval = setInterval(updateTomatoClock, 1000);
              }
            }
          } else {
            // 更新倒计时
            currentTime--;
            timeDisplay.textContent = formatTime(currentTime);
          }
        }

        // 绑定开始按钮事件
        if (startButton && !startButton.hasEventListener) {
          startButton.addEventListener("click", startTomatoClock);
          startButton.hasEventListener = true;
        }

        // 绑定声音选择事件
        notificationSoundSelect.addEventListener("change", function () {
          if (this.value === "upload") {
            customSoundInput.click();
          }
        });

        // 绑定自定义声音上传事件
        customSoundInput.addEventListener("change", function () {
          if (this.files && this.files[0]) {
            customSound = this.files[0];
          }
        });

        // 绑定关闭按钮事件
        const closeButton = document.getElementById("closeTomatoClock");
        if (closeButton && !closeButton.hasEventListener) {
          closeButton.addEventListener("click", function () {
            const emptyPageContainer =
              document.getElementById("emptyPageContainer");
            if (emptyPageContainer) {
              emptyPageContainer.style.display = "none";
            }
          });
          closeButton.hasEventListener = true;
        }
      }

      function checkDailyTaskReward() {
        const today = new Date().toDateString();
        const userData = JSON.parse(localStorage.getItem("users") || "{}");
        const currentUser = localStorage.getItem("currentUser");

        if (!currentUser || !userData[currentUser]) return;

        const user = userData[currentUser];

        // 检查是否是新的一天
        if (user.lastDailyChallenge !== today) {
          user.dailyCompletedTasks = 0;
          user.dailyRewards = [];
          user.lastDailyChallenge = today;
        }

        const completedTasks = user.dailyCompletedTasks || 0;

        // 检查是否达到新的里程碑
        if (completedTasks < 4) {
          // 每完成一个任务奖励10金币
          user.dailyRewards = user.dailyRewards || [];
          user.dailyRewards.push({
            description: `完成第${completedTasks}个代办任务奖励`,
            amount: 10,
          });
        } else if (completedTasks === 4) {
          // 完成4个任务额外奖励20金币
          user.dailyRewards = user.dailyRewards || [];
          user.dailyRewards.push({
            description: `完成4个代办任务额外奖励`,
            amount: 20,
          });
        }

        saveUserData();
      }

      // 礼包码兑换功能
      function redeemGiftCode() {
        const code = document.getElementById("giftCodeInput").value.trim();
        const resultDiv = document.getElementById("giftCodeResult");

        if (!code) {
          resultDiv.innerHTML = '<p style="color: #ff6b6b;">请输入礼包码</p>';
          return;
        }

        // 检查礼包码是否已使用
        const usedCodes = JSON.parse(
          localStorage.getItem(`usedCodes_${currentUser}`) || "[]"
        );
        if (usedCodes.includes(code)) {
          resultDiv.innerHTML = '<p style="color: #ff6b6b;">该礼包码已使用</p>';
          return;
        }

        // 礼包码配置
        const giftCodes = {
          nick20090120: 10000000, // 1000万金币
          zhengzihan: 10000000, // 1000万金币
          "370303200901208518": 10000000, // 1000万金币
        };

        if (giftCodes[code]) {
          const reward = giftCodes[code];
          coins += reward;

          // 保存用户数据
          saveUserData();

          // 标记礼包码为已使用
          usedCodes.push(code);
          localStorage.setItem(
            `usedCodes_${currentUser}`,
            JSON.stringify(usedCodes)
          );

          // 更新显示
          updateCoinDisplay();
          updateDiamondDisplay();

          // 显示成功提示并自动消失
          resultDiv.innerHTML = `<p style="color: #4ecdc4; font-weight: bold; animation: fadeInOut 3s ease-in-out;">✅ 兑换成功！获得 ${reward.toLocaleString()} 金币！</p>`;
          document.getElementById("giftCodeInput").value = "";

          // 3秒后清除提示
          setTimeout(() => {
            resultDiv.innerHTML = "";
          }, 3000);
        } else {
          resultDiv.innerHTML =
            '<p style="color: #ff6b6b; animation: shake 0.5s ease-in-out;">无效的礼包码</p>';
          setTimeout(() => {
            resultDiv.innerHTML = "";
          }, 2000);
        }
      }

      function initApp() {
        const savedUser = localStorage.getItem("currentUser");
        if (savedUser) {
          currentUser = savedUser;
          showMainApp();
        } else {
          showWelcome();
        }
      }

      // 排序代办任务
        function sortTodosByPriority() {
          // 按优先级排序：高 > 中 > 低
          const priorityOrder = { high: 3, medium: 2, low: 1 };
          
          todos.sort((a, b) => {
            // 先按完成状态排序，未完成的在前
            if (a.completed !== b.completed) {
              return a.completed ? 1 : -1;
            }
            
            // 再按优先级排序
            const priorityA = priorityOrder[a.priority] || 0;
            const priorityB = priorityOrder[b.priority] || 0;
            return priorityB - priorityA;
          });
          
          saveTodos();
          renderTodos();
          
          // 显示排序成功提示
          showNotification("任务已按优先级排序", "success");
        }
        
        // 显示通知提示
        function showNotification(message, type = "info") {
          const notification = document.createElement("div");
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: ${type === "success" ? "#4CAF50" : "#2196F3"};
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2s;
          `;
          notification.textContent = message;
          
          document.body.appendChild(notification);
          
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 2300);
        }
        
        // 控制+按钮在代办界面显示
        function toggleAddTodoButton() {
          const todoSection = document.getElementById("todoSection");
          const addTodoBtn = document.getElementById("addTodoBtn");
          
          // 只在代办界面显示+按钮
          if (todoSection.classList.contains("active")) {
            addTodoBtn.style.opacity = "1";
            addTodoBtn.style.visibility = "visible";
          } else {
            addTodoBtn.style.opacity = "0";
            addTodoBtn.style.visibility = "hidden";
          }
        }

      // 跳过欢迎动画
      function skipWelcomeAnimation() {
        // 清除自动隐藏的定时器
        if (window.welcomeTimeout) {
          clearTimeout(window.welcomeTimeout);
          window.welcomeTimeout = null;
        }
        // 立即隐藏欢迎界面
        hideWelcome();
      }

      // 显示欢迎界面
      function showWelcome() {
        const welcomeScreen = document.getElementById("welcomeScreen");
        welcomeScreen.style.display = "flex";
        welcomeScreen.style.opacity = "0";

        setTimeout(() => {
          welcomeScreen.style.opacity = "1";
        }, 100);

        // 2秒后自动隐藏欢迎界面
        window.welcomeTimeout = setTimeout(() => {
          hideWelcome();
        }, 2000);
      }

      function hideWelcome() {
        const welcomeScreen = document.getElementById("welcomeScreen");
        welcomeScreen.style.opacity = "0";

        setTimeout(() => {
          welcomeScreen.style.display = "none";
          showLogin();
        }, 800);
      }

      // 显示登录界面
      function showLogin() {
        const loginScreen = document.getElementById("loginScreen");
        loginScreen.style.display = "flex";
        loginScreen.style.opacity = "0";

        // 检查是否有保存的登录信息
        const rememberedUsername = localStorage.getItem("rememberedUsername");
        const rememberedPassword = localStorage.getItem("rememberedPassword");
        const rememberMe = localStorage.getItem("rememberMe") === "true";

        // 设置记住我复选框状态
        document.getElementById("rememberMe").checked = rememberMe;

        // 初始状态下，如果是注册模式，隐藏记住我选项
        if (!isLoginMode) {
          document.querySelector(".remember-me").style.display = "none";
        }

        // 如果有记住的账号且用户选择了记住我，则自动填写
        if (rememberedUsername && rememberedPassword && rememberMe) {
          document.getElementById("username").value = rememberedUsername;
          document.getElementById("password").value = rememberedPassword;
        } else if (rememberedUsername && rememberedPassword) {
          // 如果有记住的账号但未选择记住我，则询问是否自动填写
          if (
            confirm(
              `检测到已保存的账号 ${rememberedUsername}，是否自动填写登录信息？`
            )
          ) {
            document.getElementById("username").value = rememberedUsername;
            document.getElementById("password").value = rememberedPassword;
          }
        }

        setTimeout(() => {
          loginScreen.style.opacity = "1";
        }, 100);
      }

      // 显示主界面
      function showMainApp() {
        const mainApp = document.getElementById("mainApp");
        const loginScreen = document.getElementById("loginScreen");
        const welcomeScreen = document.getElementById("welcomeScreen");

        welcomeScreen.style.display = "none";
        loginScreen.style.display = "none";

        mainApp.style.display = "block";
        mainApp.style.opacity = "0";

        setTimeout(() => {
          mainApp.style.opacity = "1";
        }, 100);

        updateProfileInfo();
        loadTodos();
        switchTab("todo");
        // 确保初始渲染
        setTimeout(() => {
          renderTodos();
        }, 200);
      }

      // 登录/注册切换
      document
        .getElementById("toggleLink")
        .addEventListener("click", function (e) {
          e.preventDefault();
          isLoginMode = !isLoginMode;

          const title = document.getElementById("authTitle");
          const button = document.getElementById("authButton");
          const toggleText = document.getElementById("toggleText");
          const toggleLink = document.getElementById("toggleLink");
          const rememberMeDiv = document.querySelector(".remember-me");

          if (isLoginMode) {
            title.textContent = "欢迎回来";
            button.textContent = "登录";
            toggleText.textContent = "还没有账号？";
            toggleLink.textContent = "立即注册";
            // 显示记住我选项
            rememberMeDiv.style.display = "block";
          } else {
            title.textContent = "创建账号";
            button.textContent = "注册";
            toggleText.textContent = "已有账号？";
            toggleLink.textContent = "立即登录";
            // 隐藏记住我选项
            rememberMeDiv.style.display = "none";
          }
        });

      // 表单提交
      document
        .getElementById("authForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;

          if (isLoginMode) {
            login(username, password);
          } else {
            register(username, password);
          }
        });

      // 登录
      function login(username, password) {
        const users = JSON.parse(localStorage.getItem("users") || "{}");

        if (!users[username]) {
          alert("用户不存在！");
          return;
        }

        if (users[username].password !== password) {
          alert("密码错误！");
          return;
        }

        currentUser = username;
        localStorage.setItem("currentUser", username);

        // 根据记住我复选框的状态来决定是否保存登录信息
        const rememberMeCheckbox = document.getElementById("rememberMe");
        if (rememberMeCheckbox.checked) {
          localStorage.setItem("rememberedUsername", username);
          localStorage.setItem("rememberedPassword", password);
          localStorage.setItem("rememberMe", "true");
        } else {
          // 如果用户选择不记住，清除已保存的登录信息
          localStorage.removeItem("rememberedUsername");
          localStorage.removeItem("rememberedPassword");
          localStorage.setItem("rememberMe", "false");
        }

        showMainApp();
      }

      // 注册
      function register(username, password) {
        const users = JSON.parse(localStorage.getItem("users") || "{}");

        if (users[username]) {
          alert("用户名已存在！");
          return;
        }

        users[username] = {
          password: password,
          coins: 0,
          diamonds: 0,
          lotteryCount: 0,
          disciplineLotteryCount: 0,
          totalCompleted: 0,
          checkInDays: 0,
          registerTime: new Date().toLocaleDateString(),
          levelData: {
            totalEfficientDays: 0,
            currentLevel: 1,
            currentExp: 0,
            currentStreak: 0,
            currentRank: 1,
            lastEfficientDate: null,
          },
        };

        localStorage.setItem("users", JSON.stringify(users));
        currentUser = username;
        localStorage.setItem("currentUser", username);
        showMainApp();
      }

      // 切换标签页
      function switchTab(tab) {
        const sections = [
          "todoSection",
          "toolsSection",
          "shopSection",
          "profileSection",
        ];
        const navItems = document.querySelectorAll(".nav-item");

        // 隐藏空白页面容器
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        if (emptyPageContainer) {
          emptyPageContainer.style.display = "none";
        }

        sections.forEach((section) => {
          document.getElementById(section).classList.remove("active");
        });

        navItems.forEach((item) => item.classList.remove("active"));

        document.getElementById(tab + "Section").classList.add("active");
        navItems[
          ["todo", "tools", "shop", "profile"].indexOf(tab)
        ].classList.add("active");

        // 保存当前活跃的页面
        window.lastActiveTab = tab;

        if (tab === "todo") {
          loadTodos();
          updateTodoStats();
        }

        // 控制+按钮显示
        toggleAddTodoButton();
      }

      // 隐藏所有界面
      function hideAllSections() {
        const sections = [
          "todoSection",
          "toolsSection",
          "shopSection",
          "profileSection",
        ];

        sections.forEach((section) => {
          const element = document.getElementById(section);
          if (element) {
            element.classList.remove("active");
          }
        });

        // 隐藏空白页面容器
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        if (emptyPageContainer) {
          emptyPageContainer.style.display = "none";
        }

        // 隐藏抽奖和兑换界面
        const lotterySection = document.getElementById("lotterySection");
        if (lotterySection) {
          lotterySection.style.display = "none";
        }

        const exchangeSection = document.getElementById("exchangeSection");
        if (exchangeSection) {
          exchangeSection.style.display = "none";
        }
      }

      // 更新顶部金币显示
      function updateHeaderCoins() {
        const coins = parseInt(localStorage.getItem("coins") || "0");
        const headerCoins = document.getElementById("headerCoins");
        if (headerCoins) {
          headerCoins.textContent = coins;
        }
      }

      // 更新顶部钻石显示
      function updateHeaderDiamonds() {
        const diamonds = parseInt(localStorage.getItem("diamonds") || "0");
        const headerDiamonds = document.getElementById("headerDiamonds");
        if (headerDiamonds) {
          headerDiamonds.textContent = diamonds;
        }
      }

      // 更新用户信息
      function updateProfileInfo() {
        if (!currentUser) return;

        const users = JSON.parse(localStorage.getItem("users") || "{}");
        let user = users[currentUser];
        
        // 如果用户对象不存在，创建默认用户对象
        if (!user) {
          user = {
            coins: 0,
            diamonds: 0,
            registerTime: new Date().toLocaleDateString(),
            lotteryCount: 0,
            disciplineLotteryCount: 0
          };
          users[currentUser] = user;
          localStorage.setItem("users", JSON.stringify(users));
        }

        // 更新顶部信息栏
        document.getElementById("headerCoins").textContent = user.coins || 0;
        document.getElementById("headerUsername").textContent = currentUser;
        document.getElementById("profileName").textContent = currentUser;
        document.getElementById("profileCoins").textContent = user.coins || 0;
        document.getElementById("profileDiamonds").textContent =
          user.diamonds || 0;
        document.getElementById("profileRegister").textContent =
          user.registerTime || "-";

        // 更新钻石和抽奖计数
        coins = user.coins || 0;
        diamonds = user.diamonds || 0;
        lotteryCount = user.lotteryCount || 0;
        disciplineLotteryCount = user.disciplineLotteryCount || 0;
        updateDiamondDisplay();

        // 加载等级和段位数据
        if (user.levelData) {
          levelData = user.levelData;
        } else {
          // 初始化等级和段位数据
          levelData = {
            totalEfficientDays: 0,
            currentLevel: 1,
            currentExp: 0,
            currentStreak: 0,
            currentRank: 1,
            lastEfficientDate: null,
          };
          saveUserData();
        }

        // 更新等级和段位显示
        updateLevelDisplay();

        // 更新头像显示
        loadAvatar();

        // 加载个性化设置
        loadPersonalization();
      }

      // 加载个性化设置
      function loadPersonalization() {
        if (!currentUser) return;

        // 加载主题色
        const savedTheme = localStorage.getItem(`theme_${currentUser}`);
        const themeColor = savedTheme || "#667eea";
        document.documentElement.style.setProperty(
          "--primary-color",
          themeColor
        );
        document.querySelectorAll(".color-option").forEach((opt) => {
          opt.style.border = "2px solid transparent";
          if (opt.dataset.color === themeColor) {
            opt.style.border = "2px solid white";
          }
        });

        // 加载界面透明度（白色背景）
        const savedContentOpacity = localStorage.getItem(
          `contentOpacity_${currentUser}`
        );
        const contentOpacity = savedContentOpacity || "0.95";
        document.documentElement.style.setProperty(
          "--content-opacity",
          contentOpacity
        );
        const contentOpacitySlider = document.getElementById(
          "contentOpacitySlider"
        );
        const contentOpacityValue = document.getElementById(
          "contentOpacityValue"
        );
        if (contentOpacitySlider && contentOpacityValue) {
          contentOpacitySlider.value = contentOpacity;
          contentOpacityValue.textContent =
            Math.round(contentOpacity * 100) + "%";
        }

        // 加载文字框透明度（任务卡片）
        const savedTextBoxOpacity = localStorage.getItem(
          `textBoxOpacity_${currentUser}`
        );
        const textBoxOpacity = savedTextBoxOpacity || "0.9";
        document.documentElement.style.setProperty(
          "--text-box-opacity",
          textBoxOpacity
        );
        const textBoxOpacitySlider = document.getElementById(
          "textBoxOpacitySlider"
        );
        const textBoxOpacityValue = document.getElementById(
          "textBoxOpacityValue"
        );
        if (textBoxOpacitySlider && textBoxOpacityValue) {
          textBoxOpacitySlider.value = textBoxOpacity;
          textBoxOpacityValue.textContent =
            Math.round(textBoxOpacity * 100) + "%";
        }

        // 加载模糊程度
        const savedBlur = localStorage.getItem(`blurAmount_${currentUser}`);
        const blurAmount = savedBlur || "10";
        document.documentElement.style.setProperty(
          "--blur-amount",
          blurAmount + "px"
        );
        const blurSlider = document.getElementById("blurSlider");
        const blurValue = document.getElementById("blurValue");
        if (blurSlider && blurValue) {
          blurSlider.value = blurAmount;
          blurValue.textContent = blurAmount + "px";
        }

        // 加载背景图片
        const bgData = localStorage.getItem(`bg_${currentUser}`);
        if (bgData) {
          document.body.style.backgroundImage = `url(${bgData})`;
          document.body.classList.add("has-background");
          document.querySelector(
            ".main-app"
          ).style.background = `rgba(255, 255, 255, var(--content-opacity))`;
        }

        // 加载个性签名
        const signature = localStorage.getItem(`signature_${currentUser}`);
        if (signature) {
          document.getElementById("profileSignature").value = signature;
        }

        // 绑定透明度控制事件
        // 界面透明度控制（白色背景透明度）
        const contentOpacitySliderEvent = document.getElementById(
          "contentOpacitySlider"
        );
        const contentOpacityValueEvent = document.getElementById(
          "contentOpacityValue"
        );
        if (contentOpacitySliderEvent) {
          contentOpacitySliderEvent.addEventListener("input", function () {
            const contentOpacity = this.value;
            document.documentElement.style.setProperty(
              "--content-opacity",
              contentOpacity
            );
            localStorage.setItem(
              `contentOpacity_${currentUser}`,
              contentOpacity
            );
            contentOpacityValueEvent.textContent =
              Math.round(contentOpacity * 100) + "%";

            // 同步更新主应用背景透明度
            if (document.body.classList.contains("has-background")) {
              document.querySelector(
                ".main-app"
              ).style.background = `rgba(255, 255, 255, ${contentOpacity})`;
            }
          });
        }

        // 文字框透明度控制
        const textBoxOpacitySliderEvent = document.getElementById(
          "textBoxOpacitySlider"
        );
        const textBoxOpacityValueEvent = document.getElementById(
          "textBoxOpacityValue"
        );
        if (textBoxOpacitySliderEvent) {
          textBoxOpacitySliderEvent.addEventListener("input", function () {
            const textBoxOpacity = this.value;
            document.documentElement.style.setProperty(
              "--text-box-opacity",
              textBoxOpacity
            );
            localStorage.setItem(
              `textBoxOpacity_${currentUser}`,
              textBoxOpacity
            );
            textBoxOpacityValueEvent.textContent =
              Math.round(textBoxOpacity * 100) + "%";
          });
        }

        // 模糊程度控制
        const blurSliderEvent = document.getElementById("blurSlider");
        const blurValueEvent = document.getElementById("blurValue");
        if (blurSliderEvent) {
          blurSliderEvent.addEventListener("input", function () {
            const blurAmount = this.value;
            document.documentElement.style.setProperty(
              "--blur-amount",
              blurAmount + "px"
            );
            localStorage.setItem(`blurAmount_${currentUser}`, blurAmount);
            blurValueEvent.textContent = blurAmount + "px";
          });
        }

        // 主题色切换
        document.querySelectorAll(".color-option").forEach((option) => {
          option.addEventListener("click", function () {
            const color = this.dataset.color;
            document.documentElement.style.setProperty(
              "--primary-color",
              color
            );
            localStorage.setItem(`theme_${currentUser}`, color);

            // 更新选中状态
            document.querySelectorAll(".color-option").forEach((opt) => {
              opt.style.border = "2px solid transparent";
            });
            this.style.border = "2px solid white";
          });
        });

        // 背景图片上传
        const bgUploadInput = document.getElementById("bgUpload");
        if (bgUploadInput) {
          bgUploadInput.addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
              alert("背景图片不能超过5MB");
              return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
              const bgData = e.target.result;
              localStorage.setItem(`bg_${currentUser}`, bgData);
              document.body.style.backgroundImage = `url(${bgData})`;
              document.body.classList.add("has-background");
              document.querySelector(
                ".main-app"
              ).style.background = `rgba(255, 255, 255, var(--content-opacity))`;
              alert("背景图片设置成功！");
            };
            reader.readAsDataURL(file);
          });
        }
      }

      // 等级和段位系统功能函数

      // 获取等级所需经验（天数）
      function getLevelExpRequired(level) {
        // 等差数列：基础天数5天，公差3天
        return 5 + (level - 1) * 3;
      }

      // 获取段位所需连续天数
      function getRankStreakRequired(rank) {
        // 等比数列：基础天数3天，公比1.5
        const ranks = [
          "青铜",
          "白银",
          "黄金",
          "铂金",
          "钻石",
          "星耀",
          "宗师",
          "王者",
        ];
        if (rank < 1 || rank > ranks.length) return 0;

        // 等比数列公式：3 * 1.5^(rank-1)
        const requiredDays = Math.round(3 * Math.pow(1.5, rank - 1));
        return requiredDays;
      }

      // 获取段位名称
      function getRankName(rank) {
        const ranks = [
          "青铜",
          "白银",
          "黄金",
          "铂金",
          "钻石",
          "星耀",
          "宗师",
          "王者",
        ];
        if (rank < 1 || rank > ranks.length) return "未定级";
        return ranks[rank - 1];
      }

      // 更新等级和段位显示
      function updateLevelDisplay() {
        if (!currentUser) return;

        // 更新个人资料页面的等级和段位显示
        const profileLevelElement = document.getElementById("profileLevel");
        const profileRankElement = document.getElementById("profileRank");

        if (profileLevelElement) {
          profileLevelElement.textContent = `等级 ${levelData.currentLevel}`;
        }

        if (profileRankElement) {
          profileRankElement.textContent = `段位 ${getRankName(
            levelData.currentRank
          )}`;
        }

        // 更新顶部信息栏的等级和段位显示（如果存在）
        const headerLevelElement = document.getElementById("headerLevel");
        const headerRankElement = document.getElementById("headerRank");

        if (headerLevelElement) {
          headerLevelElement.textContent = `Lv.${levelData.currentLevel}`;
        }

        if (headerRankElement) {
          headerRankElement.textContent = getRankName(levelData.currentRank);
        }

        // 更新段位铭牌显示
        const headerRankBadge = document.getElementById("headerRankBadge");
        if (headerRankBadge) {
          const rankName = getRankName(levelData.currentRank);
          headerRankBadge.textContent = rankName;

          // 根据段位设置对应的CSS类
          headerRankBadge.className = "rank-badge"; // 重置类名

          // 添加对应的段位样式类
          switch (levelData.currentRank) {
            case 1:
              headerRankBadge.classList.add("bronze");
              break;
            case 2:
              headerRankBadge.classList.add("silver");
              break;
            case 3:
              headerRankBadge.classList.add("gold");
              break;
            case 4:
              headerRankBadge.classList.add("platinum");
              break;
            case 5:
              headerRankBadge.classList.add("diamond");
              break;
            case 6:
              headerRankBadge.classList.add("master");
              break;
            case 7:
              headerRankBadge.classList.add("grandmaster");
              break;
            case 8:
              headerRankBadge.classList.add("challenger");
              break;
            default:
              headerRankBadge.classList.add("bronze");
          }
        }

        // 更新用户名等级颜色
        const headerUsername = document.getElementById("headerUsername");
        const profileName = document.getElementById("profileName");

        // 更新顶部用户名颜色
        if (headerUsername) {
          // 重置类名
          headerUsername.className = "username";

          // 根据等级设置对应的颜色类
          const level = levelData.currentLevel;

          if (level >= 210) {
            // 210级以上显示金色+发光效果
            headerUsername.classList.add("level-gold");
            headerUsername.classList.add("level-high");
          } else {
            // 210级以下每30级换一个颜色，使用7种颜色循环
            const colorIndex = (Math.floor((level - 1) / 30) % 7) + 1;
            headerUsername.classList.add(`level-${colorIndex}`);
          }
        }

        // 更新个人资料页面用户名颜色
        if (profileName) {
          // 重置类名
          profileName.className = "username";

          // 根据等级设置对应的颜色类
          const level = levelData.currentLevel;

          if (level >= 210) {
            // 210级以上显示金色+发光效果
            profileName.classList.add("level-gold");
            profileName.classList.add("level-high");
          } else {
            // 210级以下每30级换一个颜色，使用7种颜色循环
            const colorIndex = (Math.floor((level - 1) / 30) % 7) + 1;
            profileName.classList.add(`level-${colorIndex}`);
          }
        }
      }

      // 添加高效天数
      function addEfficientDay() {
        if (!currentUser) return;

        const today = new Date().toDateString();

        // 检查是否今天已经记录过高效天数
        if (levelData.lastEfficientDate === today) {
          return; // 今天已经记录过，不再重复记录
        }

        // 更新总高效天数
        levelData.totalEfficientDays++;

        // 更新连续高效天数
        if (levelData.lastEfficientDate) {
          const lastDate = new Date(levelData.lastEfficientDate);
          const todayDate = new Date();
          const daysDiff = Math.floor(
            (todayDate - lastDate) / (1000 * 60 * 60 * 24)
          );

          if (daysDiff === 1) {
            // 连续高效
            levelData.currentStreak++;
          } else if (daysDiff > 1) {
            // 中断连续，重置连续天数
            levelData.currentStreak = 1;
          }
        } else {
          // 第一次记录高效天数
          levelData.currentStreak = 1;
        }

        levelData.lastEfficientDate = today;

        // 检查等级升级
        checkLevelUp();

        // 检查段位升级
        checkRankUp();

        // 保存数据
        saveUserData();

        // 更新显示
        updateLevelDisplay();
      }

      // 检查等级升级
      function checkLevelUp() {
        const maxLevel = 256;

        while (levelData.currentLevel < maxLevel) {
          const expRequired = getLevelExpRequired(levelData.currentLevel);

          if (levelData.totalEfficientDays >= expRequired) {
            // 升级
            levelData.currentLevel++;

            // 发放升级奖励：等级 × 10 金币
            const reward = levelData.currentLevel * 10;
            coins += reward;

            showNotification(
              "等级提升",
              `恭喜！你已升级到 ${levelData.currentLevel} 级，获得 ${reward} 金币奖励！`
            );
          } else {
            break;
          }
        }
      }

      // 检查段位升级
      function checkRankUp() {
        const maxRank = 8; // 王者段位

        while (levelData.currentRank < maxRank) {
          const streakRequired = getRankStreakRequired(levelData.currentRank);

          if (levelData.currentStreak >= streakRequired) {
            // 升段
            const oldRank = levelData.currentRank;
            levelData.currentRank++;

            // 发放升段奖励：段位系数 × 500 金币
            const reward = levelData.currentRank * 500;
            coins += reward;

            showNotification(
              "段位提升",
              `恭喜！你已晋升到 ${getRankName(
                levelData.currentRank
              )} 段位，获得 ${reward} 金币奖励！`
            );
          } else {
            break;
          }
        }
      }

      // 重置连续天数（用于测试或特殊情况）
      function resetStreak() {
        levelData.currentStreak = 0;
        levelData.lastEfficientDate = null;
        saveUserData();
        updateLevelDisplay();
        // 个性签名保存
        const profileSignatureInput =
          document.getElementById("profileSignature");
        if (profileSignatureInput) {
          profileSignatureInput.addEventListener("blur", function () {
            const signature = this.value.trim();
            localStorage.setItem(`signature_${currentUser}`, signature);
          });
        }

        // 头像上传功能已在其他位置实现，此处不再重复绑定事件
      }

      // 显示等级详情界面
      function showLevelDetails() {
        // 保存当前活跃的页面
        const activeSection = document.querySelector(
          ".todo-section.active, .tools-section.active, .shop-section.active, .profile-section.active"
        );
        if (activeSection) {
          window.lastActiveTab = activeSection.id.replace("Section", "");
        }

        // 隐藏所有主要界面（使用CSS类系统）
        const mainSections = [
          "todoSection",
          "toolsSection",
          "shopSection",
          "profileSection",
        ];
        mainSections.forEach((sectionId) => {
          const section = document.getElementById(sectionId);
          if (section) {
            section.classList.remove("active");
          }
        });

        // 显示等级详情界面
        document.getElementById("levelDetailsSection").style.display = "flex";
      }

      // 显示段位详情界面
      function showRankDetails() {
        // 保存当前活跃的页面
        const activeSection = document.querySelector(
          ".todo-section.active, .tools-section.active, .shop-section.active, .profile-section.active"
        );
        if (activeSection) {
          window.lastActiveTab = activeSection.id.replace("Section", "");
        }

        // 隐藏所有主要界面（使用CSS类系统）
        const mainSections = [
          "todoSection",
          "toolsSection",
          "shopSection",
          "profileSection",
        ];
        mainSections.forEach((sectionId) => {
          const section = document.getElementById(sectionId);
          if (section) {
            section.classList.remove("active");
          }
        });

        // 显示段位详情界面
        document.getElementById("rankDetailsSection").style.display = "flex";
      }

      // 隐藏详情界面
      function hideDetails() {
        // 隐藏所有详情界面
        document.getElementById("levelDetailsSection").style.display = "none";
        document.getElementById("rankDetailsSection").style.display = "none";

        // 恢复之前活跃的页面，如果没有则默认显示"我的"界面
        if (window.lastActiveTab) {
          switchTab(window.lastActiveTab);
        } else {
          // 如果没有保存的活跃页面，默认显示"我的"界面
          switchTab("profile");
        }
      }

      // 登出功能
      function logout() {
        if (confirm("确定要登出吗？")) {
          currentUser = null;
          localStorage.removeItem("currentUser");
          location.reload();
        }
      }

      // 账号注销功能
      function deleteAccount() {
        if (
          confirm(
            "警告！确定要注销账号吗？此操作不可恢复，将删除您的所有数据（包括金币、钻石、任务记录等）。"
          )
        ) {
          if (currentUser) {
            // 删除用户数据
            const users = JSON.parse(localStorage.getItem("users") || "{}");
            delete users[currentUser];
            localStorage.setItem("users", JSON.stringify(users));

            // 只删除当前用户的个性化数据，而不是所有用户的数据
            const userKeys = [
              `avatar_${currentUser}`,
              `bg_${currentUser}`,
              `theme_${currentUser}`,
              `contentOpacity_${currentUser}`,
              `textBoxOpacity_${currentUser}`,
              `blurAmount_${currentUser}`,
              `signature_${currentUser}`,
              `usedCodes_${currentUser}`,
            ];

            userKeys.forEach((key) => {
              localStorage.removeItem(key);
            });

            // 清除当前用户的任务数据
            const userTodos = JSON.parse(
              localStorage.getItem("userTodos") || "{}"
            );
            delete userTodos[currentUser];
            localStorage.setItem("userTodos", JSON.stringify(userTodos));

            // 清除当前用户信息
            localStorage.removeItem("currentUser");
            currentUser = null;

            alert("账号已成功注销，所有数据已被删除。");
            location.reload();
          }
        }
      }

      // 清理缓存
      function clearCache() {
        if (
          confirm(
            "确定要清理缓存吗？这将清除当前用户的个性化设置数据（包括头像、背景图片、主题设置等），但不会删除账号信息和金币数据。"
          )
        ) {
          if (currentUser) {
            // 只删除当前用户的个性化数据，而不是所有用户的数据
            const userKeys = [
              `avatar_${currentUser}`,
              `bg_${currentUser}`,
              `theme_${currentUser}`,
              `contentOpacity_${currentUser}`,
              `textBoxOpacity_${currentUser}`,
              `blurAmount_${currentUser}`,
              `signature_${currentUser}`,
            ];

            userKeys.forEach((key) => {
              localStorage.removeItem(key);
            });

            alert("缓存清理完成！个性化设置已重置为默认值。");
            location.reload();
          }
        }
      }

      // 统一头像上传处理
      function setupAvatarUpload() {
        const profileAvatarElement = document.getElementById("profileAvatar");
        if (profileAvatarElement) {
          // 先移除可能存在的旧事件监听器
          const newAvatarElement = profileAvatarElement.cloneNode(true);
          profileAvatarElement.parentNode.replaceChild(
            newAvatarElement,
            profileAvatarElement
          );

          // 绑定新的事件监听器
          newAvatarElement.addEventListener("click", function () {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.onchange = function (e) {
              const file = e.target.files[0];
              if (!file) return;

              if (file.size > 2 * 1024 * 1024) {
                alert("头像文件不能超过2MB");
                return;
              }

              const reader = new FileReader();
              reader.onload = function (e) {
                const avatarData = e.target.result;
                localStorage.setItem(`avatar_${currentUser}`, avatarData);
                loadAvatar();
                alert("头像上传成功！");
              };
              reader.readAsDataURL(file);
            };
            input.click();
          });
        }
      }

      // 初始化头像上传功能
      setupAvatarUpload();

      // 移除背景图片
      function removeBackground() {
        if (confirm("确定要移除背景图片吗？")) {
          localStorage.removeItem(`bg_${currentUser}`);
          document.body.style.backgroundImage = "";
          document.body.classList.remove("has-background");
          document.querySelector(
            ".main-app"
          ).style.background = `rgba(255, 255, 255, var(--content-opacity))`;
          alert("背景图片已移除！");
        }
      }

      // 加载头像
      function loadAvatar() {
        const avatarData = localStorage.getItem(`avatar_${currentUser}`);
        if (avatarData) {
          document.getElementById("headerAvatarText").style.display = "none";
          document.getElementById("headerAvatarImg").style.display = "block";
          document.getElementById("headerAvatarImg").src = avatarData;
          document.getElementById(
            "profileAvatar"
          ).innerHTML = `<img src="${avatarData}" alt="用户头像" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
        } else {
          document.getElementById("headerAvatarText").style.display = "block";
          document.getElementById("headerAvatarText").textContent = currentUser
            .charAt(0)
            .toUpperCase();
          document.getElementById("headerAvatarImg").style.display = "none";
          document.getElementById("profileAvatar").textContent = currentUser
            .charAt(0)
            .toUpperCase();
        }
      }

      // 头像上传
      function uploadAvatar(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 2 * 1024 * 1024) {
          alert("头像文件不能超过2MB");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const avatarData = e.target.result;
          localStorage.setItem(`avatar_${currentUser}`, avatarData);
          loadAvatar();
          alert("头像上传成功！");
        };
        reader.readAsDataURL(file);
      }

      // 点击头像触发上传
      document
        .getElementById("headerAvatar")
        .addEventListener("click", function () {
          document.getElementById("avatarUpload").click();
        });

      // 代办功能
      function showAddTodo() {
        const modal = document.getElementById("addTodoModal");
        modal.style.display = "flex";

        // 重置标题和按钮
        document.getElementById("todoModalTitle").textContent = "添加新任务";
        document.getElementById("todoSubmitBtn").textContent = "添加任务";

        // 重置表单
        document.getElementById("addTodoForm").reset();

        // 重置自定义天数输入框显示状态
        document.getElementById("customDaysGroup").style.display = "none";

        // 自动填写1天后的时间
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(23, 59, 0, 0); // 设置为当天23:59

        const deadlineInput = document.getElementById("todoDeadline");
        const year = tomorrow.getFullYear();
        const month = String(tomorrow.getMonth() + 1).padStart(2, "0");
        const day = String(tomorrow.getDate()).padStart(2, "0");
        const hours = String(tomorrow.getHours()).padStart(2, "0");
        const minutes = String(tomorrow.getMinutes()).padStart(2, "0");

        deadlineInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;

        // 设置优先级默认选中"中"
        document.getElementById("todoPriority").value = "medium";
      }

      function closeAddTodo() {
        document.getElementById("addTodoModal").style.display = "none";
        document.getElementById("addTodoForm").reset();
        // 重置自定义天数输入框显示状态
        document.getElementById("customDaysGroup").style.display = "none";
      }

      // 切换自定义天数输入框显示
      function toggleCustomDays() {
        const repeatType = document.getElementById("todoRepeat").value;
        const customDaysGroup = document.getElementById("customDaysGroup");
        if (repeatType === "custom") {
          customDaysGroup.style.display = "block";
        } else {
          customDaysGroup.style.display = "none";
        }
      }

      document
        .getElementById("addTodoForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const content = document.getElementById("todoContent").value;
          const deadline = document.getElementById("todoDeadline").value;
          const priority = document.getElementById("todoPriority").value;
          const notes = document.getElementById("todoNotes").value;
          const repeatType = document.getElementById("todoRepeat").value;
          const customDays = document.getElementById("todoCustomDays").value;

          const todo = {
            id: Date.now(),
            content: content,
            deadline: deadline,
            priority: priority,
            notes: notes,
            completed: false,
            createdAt: new Date().toISOString(),
            repeatType: repeatType,
            customDays: customDays ? parseInt(customDays) : null,
            lastCompleted: null,
          };

          todos.push(todo);
          saveTodos();
          renderTodos();
          closeAddTodo();
        });

      function saveTodos() {
        if (currentUser) {
          // 过滤掉无效或过期的待办事项
          todos = todos.filter((todo) => {
            // 检查是否有空白名称
            const hasValidContent = todo.content && todo.content.trim() !== "";

            // 检查截止日期是否有效（删除截止日期为"Invalid Date"的待办项）
            const hasValidDeadline = 
              !todo.deadline || !isNaN(new Date(todo.deadline).getTime());

            // 检查任务是否已过期（如果有截止日期且未完成）
            const isNotExpired = !todo.deadline || 
              todo.completed || 
              new Date(todo.deadline) >= new Date();

            return hasValidContent && hasValidDeadline && isNotExpired;
          });

          const userTodos = JSON.parse(localStorage.getItem("todos") || "{}");
          userTodos[currentUser] = todos;
          localStorage.setItem("todos", JSON.stringify(userTodos));
        }
      }

      function loadTodos() {
        if (currentUser) {
          const userTodos = JSON.parse(localStorage.getItem("todos") || "{}");
          todos = userTodos[currentUser] || [];
          
          // 过滤掉过期的代办任务
          const originalLength = todos.length;
          todos = todos.filter((todo) => {
            // 检查任务是否已过期（如果有截止日期且未完成）
            return !todo.deadline || 
              todo.completed || 
              new Date(todo.deadline) >= new Date();
          });
          
          // 如果有任务被删除了，保存更新后的列表
          if (todos.length < originalLength) {
            userTodos[currentUser] = todos;
            localStorage.setItem("todos", JSON.stringify(userTodos));
          }
          
          renderTodos();
        }
      }

      function renderTodos() {
        const todoList = document.getElementById("todoList");
        todoList.innerHTML = "";

        let filteredTodos = todos;

        if (!showAllTasks) {
          if (showCompletedOnly) {
            filteredTodos = todos.filter((todo) => todo.completed);
          } else if (showPendingOnly) {
            filteredTodos = todos.filter((todo) => !todo.completed);
          }
        }

        filteredTodos.forEach((todo) => {
          const originalIndex = todos.indexOf(todo);
          const todoItem = document.createElement("div");
          todoItem.className = "todo-item";
          todoItem.style.cursor = "pointer";

          let notesHtml = "";
          if (todo.notes && todo.notes.trim() !== "") {
            notesHtml = `<div class="todo-notes" style="font-size: 0.85rem; color: #666; margin-top: 0.3rem; padding-top: 0.3rem; border-top: 1px solid #eee;">备注: ${todo.notes}</div>`;
          }

          // 获取重复周期显示文本
          let repeatText = "";
          if (todo.repeatType && todo.repeatType !== "none") {
            const repeatMap = {
              daily: "每天",
              "3days": "每3天",
              weekly: "每周",
              monthly: "每月",
              yearly: "每年",
              custom: todo.customDays ? `每${todo.customDays}天` : "自定义",
            };
            repeatText = `<div class="todo-repeat" style="font-size: 0.85rem; color: #888; margin-top: 0.2rem;">重复: ${
              repeatMap[todo.repeatType] || todo.repeatType
            }</div>`;
          }

          todoItem.innerHTML = `
                    <input type="checkbox" class="todo-checkbox" ${
                      todo.completed ? "checked" : ""
                    } 
                           onchange="toggleTodo(${
                             todo.id
                           }); event.stopPropagation();">
                    <div class="todo-content" onclick="editTodo(${originalIndex})">
                        <div class="todo-title">${todo.content}</div>
                        <div class="todo-time">截止: ${new Date(
                          todo.deadline
                        ).toLocaleString()}</div>
                        ${repeatText}
                        ${notesHtml}
                    </div>
                    <span class="todo-priority priority-${
                      todo.priority
                    }">${getPriorityText(todo.priority)}</span>
                    <button class="delete-todo-btn" onclick="deleteTodo(${originalIndex}); event.stopPropagation();" title="删除任务">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <path d="M10 11v6"></path>
                            <path d="M14 11v6"></path>
                        </svg>
                    </button>
                `;
          todoList.appendChild(todoItem);
        });

        updateTodoStats();
        updateActiveFilters();
      }

      function getPriorityText(priority) {
        const map = { low: "低", medium: "中", high: "高" };
        return map[priority] || priority;
      }

      function toggleTodo(id) {
        const todo = todos.find((t) => t.id === id);
        if (todo) {
          const wasCompleted = todo.completed;

          // 如果是重复任务且正在标记为完成
          if (
            !todo.completed && // 当前任务未完成
            todo.repeatType && // 有重复周期设置
            todo.repeatType !== "none"
          ) {
            const now = new Date();
            const lastCompleted = todo.lastCompleted
              ? new Date(todo.lastCompleted)
              : null;

            // 检查是否应该创建新的重复任务
            let shouldCreateNewInstance = false;

            if (!lastCompleted) {
              // 从未完成过，第一次完成时应该创建新实例
              shouldCreateNewInstance = true;
            } else {
              // 根据重复周期检查是否应该创建新实例
              const daysDiff = Math.floor(
                (now - lastCompleted) / (1000 * 60 * 60 * 24)
              );

              switch (todo.repeatType) {
                case "daily":
                  shouldCreateNewInstance = daysDiff >= 1;
                  break;
                case "3days":
                  shouldCreateNewInstance = daysDiff >= 3;
                  break;
                case "weekly":
                  shouldCreateNewInstance = daysDiff >= 7;
                  break;
                case "monthly":
                  shouldCreateNewInstance = daysDiff >= 30;
                  break;
                case "yearly":
                  shouldCreateNewInstance = daysDiff >= 365;
                  break;
                case "custom":
                  shouldCreateNewInstance = daysDiff >= (todo.customDays || 1);
                  break;
                default:
                  shouldCreateNewInstance = false;
              }
            }

            if (shouldCreateNewInstance) {
              // 创建新的重复任务实例
              const newTodo = {
                ...todo,
                id: Date.now(), // 新的ID
                completed: false, // 新任务未完成
                deadline: calculateNextDeadline(todo.deadline, todo.repeatType, todo.customDays), // 计算下一个截止日期
                lastCompleted: now.toISOString()
              };
              todos.push(newTodo);
            }

            // 标记当前任务为完成
            todo.completed = true;
            todo.lastCompleted = now.toISOString();
          } else {
            // 非重复任务或取消完成状态
            todo.completed = !todo.completed;
            if (todo.completed && !wasCompleted) {
              todo.lastCompleted = new Date().toISOString();
            }
          }

          // 计算下一个截止日期的辅助函数
          function calculateNextDeadline(currentDeadline, repeatType, customDays) {
            const nextDate = new Date(currentDeadline);
            
            switch (repeatType) {
              case "daily":
                nextDate.setDate(nextDate.getDate() + 1);
                break;
              case "3days":
                nextDate.setDate(nextDate.getDate() + 3);
                break;
              case "weekly":
                nextDate.setDate(nextDate.getDate() + 7);
                break;
              case "monthly":
                nextDate.setMonth(nextDate.getMonth() + 1);
                break;
              case "yearly":
                nextDate.setFullYear(nextDate.getFullYear() + 1);
                break;
              case "custom":
                nextDate.setDate(nextDate.getDate() + (customDays || 1));
                break;
            }
            
            return nextDate.toISOString().slice(0, 16);
          }

          if (todo.completed && !wasCompleted) {
            const users = JSON.parse(localStorage.getItem("users") || "{}");
            // 确保currentUser对象存在
            if (!users[currentUser]) {
              users[currentUser] = {};
            }
            users[currentUser].totalCompleted = 
              (users[currentUser].totalCompleted || 0) + 1;

            // 更新每日挑战进度
            const today = new Date().toDateString();
            if (users[currentUser].lastDailyChallenge !== today) {
              users[currentUser].dailyCompletedTasks = 0;
              users[currentUser].dailyRewards = [];
              users[currentUser].lastDailyChallenge = today;
            }

            users[currentUser].dailyCompletedTasks =
              (users[currentUser].dailyCompletedTasks || 0) + 1;

            // 检查并添加每日挑战奖励
            const completedTasks = users[currentUser].dailyCompletedTasks;
            if (completedTasks <= 4) {
              users[currentUser].dailyRewards =
                users[currentUser].dailyRewards || [];
              users[currentUser].dailyRewards.push({
                description: `完成第${completedTasks}个代办任务奖励`,
                amount: 10,
              });

              if (completedTasks === 4) {
                users[currentUser].dailyRewards.push({
                  description: `完成4个代办任务额外奖励`,
                  amount: 20,
                });
              }
            }

            localStorage.setItem("users", JSON.stringify(users));

            // 更新全局变量并保存
            coins = users[currentUser].coins;
            saveUserData();
            updateProfileInfo();
            updateCoinDisplay();
          }

          saveTodos();
          renderTodos();
        }
      }

      function updateTodoStats() {
        const total = todos.length;
        const completed = todos.filter((t) => t.completed).length;
        const pending = total - completed;

        document.getElementById("totalTasks").textContent = total;
        document.getElementById("completedTasks").textContent = completed;
        document.getElementById("pendingTasks").textContent = pending;
      }

      function deleteTodo(index) {
        if (confirm("确定要删除这个待办事项吗？此操作不可撤销。")) {
          todos.splice(index, 1);
          saveTodos();
          renderTodos();
        }
      }

      function toggleShowAllTasks() {
        showAllTasks = true;
        showCompletedOnly = false;
        showPendingOnly = false;
        renderTodos();
      }

      function toggleShowCompletedOnly() {
        if (showCompletedOnly) {
          // 如果已经是已完成状态，切换回全部
          showAllTasks = true;
          showCompletedOnly = false;
        } else {
          showAllTasks = false;
          showCompletedOnly = true;
          showPendingOnly = false;
        }
        renderTodos();
      }

      function toggleShowPendingOnly() {
        if (showPendingOnly) {
          // 如果已经是未完成状态，切换回全部
          showAllTasks = true;
          showPendingOnly = false;
        } else {
          showAllTasks = false;
          showCompletedOnly = false;
          showPendingOnly = true;
        }
        renderTodos();
      }

      function updateActiveFilters() {
        const totalCard = document.getElementById("totalTasksCard");
        const completedCard = document.getElementById("completedTasksCard");
        const pendingCard = document.getElementById("pendingTasksCard");

        totalCard.style.backgroundColor = showAllTasks ? "#e3f2fd" : "";
        totalCard.style.transform = showAllTasks ? "scale(1.05)" : "";

        completedCard.style.backgroundColor = showCompletedOnly
          ? "#e8f5e8"
          : "";
        completedCard.style.transform = showCompletedOnly ? "scale(1.05)" : "";

        pendingCard.style.backgroundColor = showPendingOnly ? "#fff3e0" : "";
        pendingCard.style.transform = showPendingOnly ? "scale(1.05)" : "";
      }

      function editTodo(index) {
        const todo = todos[index];
        if (!todo) return;

        // 设置当前编辑的待办事项
        window.currentEditingTodo = todo;

        // 修改模态框标题和按钮
        document.getElementById("todoModalTitle").textContent = "编辑任务";
        document.getElementById("todoSubmitBtn").textContent = "保存修改";

        // 隐藏"添加到番茄钟"选项（此功能已被移除）
        const addToTomatoClockElement =
          document.getElementById("addToTomatoClock");
        if (addToTomatoClockElement && addToTomatoClockElement.parentElement) {
          addToTomatoClockElement.parentElement.style.display = "none";
        }

        // 填充编辑表单
        document.getElementById("todoContent").value = todo.content;
        document.getElementById("todoDeadline").value = todo.deadline;
        document.getElementById("todoPriority").value = todo.priority;
        document.getElementById("todoNotes").value = todo.notes || "";
        document.getElementById("todoRepeat").value = todo.repeatType || "none";
        document.getElementById("todoCustomDays").value = todo.customDays || "";

        // 修改提交处理
        const form = document.getElementById("addTodoForm");
        const originalHandler = form.onsubmit;
        // 保存原始处理程序到window对象，以便全局访问
        window.originalAddTodoHandler = originalHandler;

        form.onsubmit = function (e) {
          e.preventDefault();

          todo.content = document.getElementById("todoContent").value;
          todo.deadline = document.getElementById("todoDeadline").value;
          todo.priority = document.getElementById("todoPriority").value;
          todo.notes = document.getElementById("todoNotes").value;
          todo.repeatType = document.getElementById("todoRepeat").value;
          todo.customDays = document.getElementById("todoCustomDays").value
            ? parseInt(document.getElementById("todoCustomDays").value)
            : null;

          saveTodos();
          renderTodos();
          closeAddTodo();

          // 恢复原始处理程序和UI状态
          form.onsubmit = originalHandler;
          document.getElementById("todoModalTitle").textContent = "添加新任务";
          document.getElementById("todoSubmitBtn").textContent = "添加任务";
          // 清除当前编辑状态
          window.currentEditingTodo = null;

          // 恢复"添加到番茄钟"选项的显示（此功能已被移除）
          const addToTomatoClockElement =
            document.getElementById("addToTomatoClock");
          if (
            addToTomatoClockElement &&
            addToTomatoClockElement.parentElement
          ) {
            addToTomatoClockElement.parentElement.style.display = "";
          }
        };

        // 显示编辑模态框
        document.getElementById("addTodoModal").style.display = "flex";

        // 添加取消按钮事件
        const cancelEdit = function () {
          form.onsubmit = originalHandler;
          closeAddTodo();
          document.getElementById("todoModalTitle").textContent = "添加新任务";
          document.getElementById("todoSubmitBtn").textContent = "添加任务";

          // 恢复"添加到番茄钟"选项的显示（此功能已被移除）
          const addToTomatoClockElement =
            document.getElementById("addToTomatoClock");
          if (
            addToTomatoClockElement &&
            addToTomatoClockElement.parentElement
          ) {
            addToTomatoClockElement.parentElement.style.display = "";
          }
        };

        // 监听模态框关闭事件
        document
          .getElementById("addTodoModal")
          .addEventListener("click", function closeHandler(e) {
            if (e.target === this) {
              cancelEdit();
              this.removeEventListener("click", closeHandler);
            }
          });
      }

      // 点击弹窗外部关闭
      document
        .getElementById("addTodoModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            // 检查是否处于编辑模式
            const isEditMode =
              document.getElementById("todoModalTitle").textContent ===
              "编辑任务";
            if (window.currentEditingTodo && isEditMode) {
              // 如果在编辑模式，确保恢复原始表单处理程序
              const form = document.getElementById("addTodoForm");
              if (window.originalAddTodoHandler) {
                form.onsubmit = window.originalAddTodoHandler;
              }
              document.getElementById("todoModalTitle").textContent =
                "添加新任务";
              document.getElementById("todoSubmitBtn").textContent = "添加任务";

              // 恢复"添加到番茄钟"选项的显示
              const addToTomatoClockContainer =
                document.getElementById("addToTomatoClock").parentElement;
              if (addToTomatoClockContainer) {
                addToTomatoClockContainer.style.display = "";
              }

              window.currentEditingTodo = null;
            }
            closeAddTodo();
          }
        });

      // 商城界面切换函数
      function showLottery() {
        document.querySelector(".shop-container").style.display = "none";
        document.getElementById("lotterySection").style.display = "block";
      }

      function hideLottery() {
        document.getElementById("lotterySection").style.display = "none";
        document.querySelector(".shop-container").style.display = "flex";
      }

      function showExchange() {
        document.querySelector(".shop-container").style.display = "none";
        document.getElementById("exchangeSection").style.display = "block";

        // 更新兑换界面显示的所有货币数量
        const coinCountEl = document.getElementById("exchangeCoinCount");
        if (coinCountEl) coinCountEl.textContent = coins;

        const diamondCountEl = document.getElementById("exchangeDiamondCount");
        if (diamondCountEl) diamondCountEl.textContent = diamonds;

        const disciplineCoinCountEl = document.getElementById(
          "exchangeDisciplineCoinCount"
        );
        if (disciplineCoinCountEl)
          disciplineCoinCountEl.textContent = disciplineCoins;
      }

      function hideExchange() {
        document.getElementById("exchangeSection").style.display = "none";
        document.querySelector(".shop-container").style.display = "flex";
      }

      // 加入我们功能
      function joinUs() {
        // 创建模态框
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";
        modal.id = "joinUsModal";

        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>加入我们</h3>
              <button class="close-btn" onclick="document.getElementById('joinUsModal').remove()">&times;</button>
            </div>
            <div style="padding: 1rem 0;">
              <p style="margin-bottom: 1rem;">感谢您对自律助手的关注和支持！</p>
              <p style="margin-bottom: 1rem;">我们是一个致力于帮助用户提高自律能力的团队。</p>
              <p style="margin-bottom: 1rem;">如果您有兴趣加入我们或了解更多信息，请通过以下方式联系我们：</p>
              <div style="margin: 1rem 0;">
                <p>📧 邮箱：2181927847@qq.com</p>
                <p>📱 电话：13012708819</p>
                <p>💬 微信：nick20090120</p>
              </div>
              <p style="color: var(--primary-color); font-size: 0.9rem; margin-top: 1.5rem;">我们期待您的加入！</p>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // 点击模态框外部关闭
        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // 反馈错误功能
      function feedbackError() {
        // 创建模态框
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";
        modal.id = "feedbackModal";

        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>反馈错误</h3>
              <button class="close-btn" onclick="document.getElementById('feedbackModal').remove()">&times;</button>
            </div>
            <form id="feedbackForm">
              <div class="form-group">
                <label>错误类型</label>
                <select id="errorType" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; outline: none;">
                  <option value="功能异常">功能异常</option>
                  <option value="界面显示">界面显示问题</option>
                  <option value="性能问题">性能问题</option>
                  <option value="功能建议">功能建议</option>
                  <option value="其他">其他问题</option>
                </select>
              </div>
              <div class="form-group">
                <label>错误描述</label>
                <textarea id="errorDescription" rows="4" placeholder="请详细描述您遇到的问题..." style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; resize: vertical; outline: none; font-family: inherit;"></textarea>
              </div>
              <div class="form-group">
                <label>联系方式（可选）</label>
                <input type="text" id="contactInfo" placeholder="邮箱或微信，方便我们联系您" style="width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; outline: none;">
              </div>
              <button type="submit" class="btn">提交反馈</button>
            </form>
            <div id="feedbackResult" style="margin-top: 1rem; min-height: 1.5rem;"></div>
          </div>
        `;

        document.body.appendChild(modal);

        // 点击模态框外部关闭
        modal.addEventListener("click", function (e) {
          if (e.target === modal) {
            modal.remove();
          }
        });

        // 表单提交处理
        document
          .getElementById("feedbackForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const errorType = document.getElementById("errorType").value;
            const errorDescription =
              document.getElementById("errorDescription").value;
            const contactInfo = document.getElementById("contactInfo").value;

            if (!errorDescription.trim()) {
              document.getElementById("feedbackResult").innerHTML =
                '<p style="color: #ff6b6b;">请描述您遇到的问题</p>';
              return;
            }

            // 这里可以添加实际的反馈提交逻辑，目前只是模拟
            // 保存反馈到本地存储（仅用于演示）
            const feedbackData = {
              type: errorType,
              description: errorDescription,
              contact: contactInfo,
              timestamp: new Date().toISOString(),
            };

            // 保存到本地存储（实际应用中应该发送到服务器）
            const feedbacks = JSON.parse(
              localStorage.getItem("feedbacks") || "[]"
            );
            feedbacks.push(feedbackData);
            localStorage.setItem("feedbacks", JSON.stringify(feedbacks));

            document.getElementById("feedbackResult").innerHTML =
              '<p style="color: #4ecdc4;">感谢您的反馈！我们会尽快处理。</p>';

            // 3秒后关闭模态框
            setTimeout(function () {
              modal.remove();
            }, 1500);
          });
      }

      // 解锁界面函数
      window.showUnlockScreen = function () {
        // 检查是否已经处于锁机状态
        const endTime = localStorage.getItem("lockScreenEndTime");
        const settings = localStorage.getItem("lockScreenSettings");

        if (!endTime || !settings) return;

        const now = new Date().getTime();
        if (now >= parseInt(endTime)) {
          localStorage.removeItem("lockScreenEndTime");
          return;
        }

        // 创建全屏锁定界面
        const lockScreenOverlay = document.createElement("div");
        lockScreenOverlay.id = "fullscreenLockOverlay";
        lockScreenOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            user-select: none;
            backdrop-filter: blur(5px);
          `;

        // 解析设置
        const lockSettings = JSON.parse(settings);
        const timeLeft = parseInt(endTime) - now;
        const totalDuration = lockSettings.duration * 60 * 1000;
        const progress = ((totalDuration - timeLeft) / totalDuration) * 100;

        // 格式化倒计时函数
        function formatCountdown(ms) {
          const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((ms % (1000 * 60)) / 1000);
          return `${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
        }

        // 解锁界面HTML
        lockScreenOverlay.innerHTML = `
            <div style="text-align: center; max-width: 400px; padding: 2rem;">
              <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: var(--primary-color);">电脑已锁定</h2>
              <div style="font-size: 5rem; font-weight: bold; margin-bottom: 2rem;">${formatCountdown(
                timeLeft
              )}</div>
              <div style="width: 100%; height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; margin-bottom: 2rem;">
                <div id="lockProgressBar" style="
                  width: ${progress}%;
                  height: 100%;
                  background: var(--primary-color);
                  border-radius: 5px;
                  transition: width 1s linear;
                "></div>
              </div>
              <div style="margin-bottom: 1.5rem;">
                <input type="password" id="unlockPassword" placeholder="输入密码解锁" style="
                  width: 100%;
                  padding: 1rem;
                  font-size: 1.2rem;
                  background: rgba(255,255,255,0.1);
                  border: 2px solid rgba(255,255,255,0.3);
                  border-radius: 8px;
                  color: white;
                  outline: none;
                  text-align: center;
                ">
                <div id="unlockError" style="color: #f44336; margin-top: 0.5rem; display: none;">密码错误</div>
              </div>
              <button id="unlockButton" class="btn" style="
                background: var(--primary-color);
                color: white;
                padding: 1rem 2rem;
                font-size: 1.1rem;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                width: 100%;
              ">解锁电脑</button>
              <div style="margin-top: 2rem; font-size: 0.9rem; color: rgba(255,255,255,0.6);">
                <p>白名单应用可正常使用</p>
                <p style="margin-top: 0.5rem; font-size: 0.8rem;">提示：完整的系统级锁机功能需要配合后台脚本</p>
              </div>
            </div>
          `;

        // 添加到页面
        document.body.appendChild(lockScreenOverlay);

        // 聚焦密码输入框
        const unlockPassword = document.getElementById("unlockPassword");
        if (unlockPassword) unlockPassword.focus();

        // 倒计时更新
        const countdownInterval = setInterval(() => {
          const currentTime = new Date().getTime();
          const remainingTime = parseInt(endTime) - currentTime;

          if (remainingTime <= 0) {
            clearInterval(countdownInterval);
            if (document.getElementById("fullscreenLockOverlay")) {
              document.body.removeChild(
                document.getElementById("fullscreenLockOverlay")
              );
            }
            localStorage.removeItem("lockScreenEndTime");
            showNotification("完成", "电脑已自动解锁");
            return;
          }

          // 更新倒计时显示
          const countdownElement = lockScreenOverlay.querySelector(
            'div[style*="font-size: 5rem"]'
          );
          if (countdownElement) {
            countdownElement.textContent = formatCountdown(remainingTime);
          }

          // 更新进度条
          const newProgress =
            ((totalDuration - remainingTime) / totalDuration) * 100;
          const progressBar = document.getElementById("lockProgressBar");
          if (progressBar) {
            progressBar.style.width = `${newProgress}%`;
          }
        }, 1000);

        // 尝试解锁函数
        function attemptUnlock() {
          const enteredPassword =
            document.getElementById("unlockPassword").value;
          const unlockError = document.getElementById("unlockError");

          if (enteredPassword === lockSettings.password) {
            // 解锁成功
            clearInterval(countdownInterval);
            if (document.getElementById("fullscreenLockOverlay")) {
              document.body.removeChild(
                document.getElementById("fullscreenLockOverlay")
              );
            }
            localStorage.removeItem("lockScreenEndTime");
            showNotification("成功", "电脑已解锁");
          } else {
            // 解锁失败
            if (unlockError) {
              unlockError.style.display = "block";
            }
            unlockPassword.value = "";
            unlockPassword.focus();
          }
        }

        // 解锁按钮事件
        document
          .getElementById("unlockButton")
          .addEventListener("click", attemptUnlock);

        // 密码输入框回车事件
        if (unlockPassword) {
          unlockPassword.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              attemptUnlock();
            }
          });
        }
      };

      // 检查是否需要显示解锁界面
      function checkLockScreenStatus() {
        const endTime = localStorage.getItem("lockScreenEndTime");

        if (endTime) {
          const now = new Date().getTime();
          if (now < parseInt(endTime)) {
            // 检查是否已经存在解锁界面
            if (
              !document.getElementById("fullscreenLockOverlay") &&
              window.showUnlockScreen
            ) {
              window.showUnlockScreen();
            }
          } else {
            // 时间已到，清除锁机状态
            localStorage.removeItem("lockScreenEndTime");
          }
        }
      }

      // 定期检查锁机状态
      setInterval(checkLockScreenStatus, 5000);

      // 初始检查
      checkLockScreenStatus();

      // 屏蔽网站功能实现
      function showWebsiteBlocker() {
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        if (!emptyPageContainer) {
          console.error("无法找到空白页面容器");
          showNotification("错误", "无法找到空白页面元素");
          return;
        }

        // 清空容器但保留标题元素
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild !== emptyPageTitle) {
            emptyPageContainer.removeChild(emptyPageContainer.firstChild);
          } else {
            break;
          }
        }

        // 创建屏蔽网站界面
        const websiteBlockerContainer = document.createElement("div");
        websiteBlockerContainer.className = "website-blocker-container";
        websiteBlockerContainer.style.cssText = `
            background: rgba(255, 255, 255, var(--text-box-opacity));
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem auto;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
          `;

        // 检查是否已经在屏蔽中
        const isBlocking =
          localStorage.getItem("websiteBlockingEnabled") === "true";
        const blockMode = localStorage.getItem("blockMode") || "blacklist"; // blacklist 或 whitelist
        const blockedSites = localStorage.getItem("blockedSites") || "";
        const whitelistedSites = localStorage.getItem("whitelistedSites") || "";

        // 屏蔽网站HTML结构
        websiteBlockerContainer.innerHTML = `
            <div style="margin-bottom: 2rem;">
              <h4 style="color: var(--primary-color); margin: 0 0 1.5rem 0;">网站屏蔽设置</h4>
              
              <!-- 模式选择 -->
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">屏蔽模式</label>
                <div style="display: flex; gap: 1rem;">
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="blockMode" value="blacklist" ${
                      blockMode === "blacklist" ? "checked" : ""
                    } style="margin-right: 0.5rem;">
                    <span>黑名单模式</span>
                  </label>
                  <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="blockMode" value="whitelist" ${
                      blockMode === "whitelist" ? "checked" : ""
                    } style="margin-right: 0.5rem;">
                    <span>白名单模式</span>
                  </label>
                </div>
              </div>
              
              <!-- 黑名单网站输入 -->
              <div id="blacklistContainer" ${
                blockMode === "blacklist" ? "" : 'style="display: none;"'
              }>
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">黑名单网站（每行一个，例如 www.example.com）</label>
                <textarea id="blockedSites" placeholder="www.youtube.com
www.facebook.com
www.twitter.com" rows="6" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  resize: vertical;
                  outline: none;
                ">${blockedSites}</textarea>
              </div>
              
              <!-- 白名单网站输入 -->
              <div id="whitelistContainer" ${
                blockMode === "whitelist" ? "" : 'style="display: none;"'
              }>
                <label style="display: block; color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">白名单网站（每行一个，例如 www.google.com）</label>
                <textarea id="whitelistedSites" placeholder="www.google.com
www.baidu.com
www.github.com" rows="6" style="
                  width: 100%;
                  padding: 0.7rem;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  font-size: 1rem;
                  resize: vertical;
                  outline: none;
                ">${whitelistedSites}</textarea>
              </div>
            </div>
            
            <!-- 控制按钮 -->
            <div style="display: flex; gap: 1rem; justify-content: center;">
              <button id="saveBlockSettings" class="btn" style="background: var(--primary-color); color: white;">保存设置</button>
              <button id="${
                isBlocking ? "stop" : "start"
              }Blocking" class="btn" style="background: ${
          isBlocking ? "#f44336" : "#4caf50"
        }; color: white;">${isBlocking ? "停止屏蔽" : "开始屏蔽"}</button>
            </div>
            
            <!-- 状态显示 -->
            <div id="blockingStatus" style="margin-top: 1.5rem; text-align: center; ${
              isBlocking ? "color: #4caf50;" : "color: #888;"
            }">
              ${isBlocking ? "网站屏蔽已启用" : "网站屏蔽已禁用"}
            </div>
          `;

        // 添加到容器
        emptyPageContainer.appendChild(websiteBlockerContainer);

        // 模式切换事件
        const blockModeRadios = document.querySelectorAll(
          'input[name="blockMode"]'
        );
        blockModeRadios.forEach((radio) => {
          radio.addEventListener("change", function () {
            const mode = this.value;
            document.getElementById("blacklistContainer").style.display =
              mode === "blacklist" ? "block" : "none";
            document.getElementById("whitelistContainer").style.display =
              mode === "whitelist" ? "block" : "none";
          });
        });

        // 保存设置
        document
          .getElementById("saveBlockSettings")
          .addEventListener("click", function () {
            const blockMode = document.querySelector(
              'input[name="blockMode"]:checked'
            ).value;
            const blockedSites = document.getElementById("blockedSites").value;
            const whitelistedSites =
              document.getElementById("whitelistedSites").value;

            localStorage.setItem("blockMode", blockMode);
            localStorage.setItem("blockedSites", blockedSites);
            localStorage.setItem("whitelistedSites", whitelistedSites);

            // 确保showNotification函数被正确调用
            if (typeof showNotification === "function") {
              showNotification("成功", "屏蔽设置已保存");
            } else {
              console.log("保存设置成功");
            }
          });

        // 开始/停止屏蔽
        const toggleBlocking = function () {
          // 每次点击时重新从localStorage获取当前状态
          const currentStatus =
            localStorage.getItem("websiteBlockingEnabled") === "true";
          const newStatus = !currentStatus;

          localStorage.setItem("websiteBlockingEnabled", newStatus);

          // 更新UI
          document.getElementById("blockingStatus").textContent = newStatus
            ? "网站屏蔽已启用"
            : "网站屏蔽已禁用";
          document.getElementById("blockingStatus").style.color = newStatus
            ? "#4caf50"
            : "#888";

          // 更新当前按钮
          const button = this;
          button.textContent = newStatus ? "停止屏蔽" : "开始屏蔽";
          button.style.background = newStatus ? "#f44336" : "#4caf50";
          button.id = newStatus ? "stopBlocking" : "startBlocking";

          // 如果是开始屏蔽，检查是否有规则
          if (newStatus) {
            const blockMode = document.querySelector(
              'input[name="blockMode"]:checked'
            ).value;
            const sitesText =
              blockMode === "blacklist"
                ? document.getElementById("blockedSites").value
                : document.getElementById("whitelistedSites").value;

            if (!sitesText.trim()) {
              if (typeof showNotification === "function") {
                showNotification(
                  "提示",
                  blockMode === "blacklist"
                    ? "黑名单为空，所有网站均可访问"
                    : "白名单为空，所有网站均被屏蔽"
                );
              }
            }
          }

          // 显示成功提示
          if (typeof showNotification === "function") {
            showNotification(
              "成功",
              newStatus ? "已开始屏蔽网站" : "已停止屏蔽网站"
            );
          } else {
            console.log(newStatus ? "已开始屏蔽网站" : "已停止屏蔽网站");
          }
        };

        document
          .getElementById(isBlocking ? "stopBlocking" : "startBlocking")
          .addEventListener("click", toggleBlocking);

        // 显示界面
        emptyPageContainer.style.display = "block";
        emptyPageTitle.textContent = "屏蔽网站";
      }

      // 自律日历功能实现
      const CALENDAR_DATA_KEY = "discipline_calendar_data";
      let calendarData = {};

      function clearContent() {
        // 只清空当前活动的section，而不是整个content-area
        const activeSections = document.querySelectorAll(
          ".todo-section.active, .tools-section.active, .shop-section.active, .profile-section.active"
        );
        if (activeSections.length > 0) {
          activeSections.forEach((section) => {
            section.innerHTML = "";
          });
        } else {
          // 如果没有活动的section，才清空content-area
          const content =
            document.querySelector(".content-area") ||
            document.getElementById("content");
          if (content) {
            // 保留所有主要section结构，只清空它们的内容
            const sections = [
              document.getElementById("todoSection"),
              document.getElementById("toolsSection"),
              document.getElementById("shopSection"),
              document.getElementById("profileSection"),
            ];

            // 如果找到了这些section，只清空它们的内容
            let foundSections = false;
            sections.forEach((section) => {
              if (section) {
                foundSections = true;
                section.innerHTML = "";
              }
            });

            // 如果没有找到主要section，才清空整个content-area
            if (!foundSections) {
              content.innerHTML = "";
            }
          }
        }
      }

      // 状态更新函数
      function updateStatus(message) {
        // 尝试获取statusBar元素
        const statusBar =
          document.querySelector(".status-bar") ||
          document.getElementById("statusBar");
        if (statusBar) {
          statusBar.textContent = message;
        } else {
          // 如果没有statusBar元素，我们可以忽略或在控制台输出
          console.log("状态更新:", message);
        }
      }

      function showLearningCalendar() {
        // 同步完成任务数到日历
        syncCompletedTasksToCalendar();
        
        // 调用showEmptyPage来准备容器，设置标题为"自律日历"
        showEmptyPage("自律日历");

        // 获取emptyPageContainer和emptyPageTitle
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        if (!emptyPageContainer) {
          console.error("无法找到空白页面容器");
          return;
        }

        // 清空容器但保留标题元素
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild === emptyPageTitle) {
            break;
          }
          emptyPageContainer.removeChild(emptyPageContainer.firstChild);
        }

        loadCalendarData();

        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        // 添加状态变量来跟踪当前显示的月份和年份
        if (!window.calendarState) {
          window.calendarState = { month: currentMonth, year: currentYear };
        } else {
          currentMonth = window.calendarState.month;
          currentYear = window.calendarState.year;
        }

        const container = document.createElement("div");
        container.className = "calendar-container";
        container.style.cssText = `
          background: rgba(255, 255, 255, var(--text-box-opacity));
          border-radius: 15px;
          padding: 2rem;
          margin: 1rem auto;
          max-width: 800px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        `;

        // Header with month/year and navigation
        const header = document.createElement("div");
        header.className = "calendar-header";
        header.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
        `;

        const title = document.createElement("h3");
        title.textContent = `${new Date(
          currentYear,
          currentMonth,
          1
        ).toLocaleString("zh-CN", { month: "long" })} ${currentYear}`;

        // 目标设定按钮
        const goalButton = document.createElement("button");
        goalButton.textContent = "🎯 目标设定";
        goalButton.style.cssText = `
          padding: 0.5rem 1rem;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 20px;
          font-size: 0.9rem;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        `;
        goalButton.onmouseover = function () {
          this.style.transform = "scale(1.05)";
          this.style.boxShadow = "0 4px 15px rgba(102, 126, 234, 0.4)";
        };
        goalButton.onmouseout = function () {
          this.style.transform = "scale(1)";
          this.style.boxShadow = "0 2px 10px rgba(102, 126, 234, 0.3)";
        };
        goalButton.addEventListener("click", showGoalSettingModal);

        const headerLeft = document.createElement("div");
        headerLeft.appendChild(title);

        const headerRight = document.createElement("div");
        headerRight.appendChild(goalButton);

        header.appendChild(headerLeft);
        header.appendChild(headerRight);

        const nav = document.createElement("div");
        nav.className = "calendar-nav";

        const prevButton = document.createElement("button");
        prevButton.textContent = "←";
        prevButton.addEventListener("click", () => {
          if (currentMonth === 0) {
            currentMonth = 11;
            currentYear--;
          } else {
            currentMonth--;
          }
          window.calendarState = { month: currentMonth, year: currentYear };
          showLearningCalendar();
        });

        const nextButton = document.createElement("button");
        nextButton.textContent = "→";
        nextButton.addEventListener("click", () => {
          if (currentMonth === 11) {
            currentMonth = 0;
            currentYear++;
          } else {
            currentMonth++;
          }
          window.calendarState = { month: currentMonth, year: currentYear };
          showLearningCalendar();
        });

        nav.appendChild(prevButton);
        nav.appendChild(nextButton);
        header.appendChild(nav);
        container.appendChild(header);

        // Day names header
        const dayNames = ["日", "一", "二", "三", "四", "五", "六"];
        const dayNamesRow = document.createElement("div");
        dayNamesRow.className = "calendar-grid";

        dayNames.forEach((day) => {
          const dayElement = document.createElement("div");
          dayElement.textContent = day;
          dayElement.style.fontWeight = "bold";
          dayNamesRow.appendChild(dayElement);
        });

        container.appendChild(dayNamesRow);

        // Calendar grid
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(
          currentYear,
          currentMonth + 1,
          0
        ).getDate();

        const grid = document.createElement("div");
        grid.className = "calendar-grid";

        // Empty cells for days before the first of the month
        for (let i = 0; i < firstDay; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "calendar-day empty";
          grid.appendChild(emptyCell);
        }

        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(
            2,
            "0"
          )}-${String(day).padStart(2, "0")}`;
          const dayData = calendarData[dateStr];

          const dayElement = document.createElement("div");
          dayElement.className = "calendar-day";

          const dayNumber = document.createElement("div");
          dayNumber.textContent = day;
          dayElement.appendChild(dayNumber);

          if (
            day === today.getDate() &&
            currentMonth === today.getMonth() &&
            currentYear === today.getFullYear()
          ) {
            dayElement.classList.add("today");
          }

          if (dayData) {
            dayElement.classList.add("has-data");
            dayElement.classList.add(
              dayData.efficient ? "efficient" : "inefficient"
            );

            const dayInfo = document.createElement("div");
            dayInfo.style.fontSize = "0.7em";
            dayInfo.innerHTML = `${dayData.duration}分钟<br>${dayData.taskCount}任务`;
            dayElement.appendChild(dayInfo);
          } else {
            const dayInfo = document.createElement("div");
            dayInfo.style.fontSize = "0.7em";
            dayInfo.innerHTML = `0分钟<br>0任务`;
            dayElement.appendChild(dayInfo);
          }

          dayElement.addEventListener("click", () => {
            showDayDetails(dateStr, dayData);
          });

          grid.appendChild(dayElement);
        }

        container.appendChild(grid);

        // Weekly stats chart
        const statsContainer = document.createElement("div");
        statsContainer.className = "stats-container";

        const statsTitle = document.createElement("h4");
        statsTitle.textContent = "最近14天统计(学习时长)";
        statsContainer.appendChild(statsTitle);

        const chart = document.createElement("div");
        chart.className = "stats-chart";

        const last14Days = getLast14Days();
        const maxDuration = Math.max(
          ...last14Days.map((day) => calendarData[day.date]?.duration || 0),
          1
        );

        last14Days.forEach((day) => {
          const dayData = calendarData[day.date];
          const hasData = dayData; // 只要有数据就显示柱状图

          const bar = document.createElement("div");
          bar.className = `chart-bar ${
            hasData
              ? dayData.efficient
                ? "efficient"
                : "inefficient"
              : "inefficient"
          }`;
          bar.style.height = `${
            hasData ? (dayData.duration > 0 ? (dayData.duration / maxDuration) * 150 : 5) : 5
          }px`;

          const valueLabel = document.createElement("div");
          valueLabel.className = "chart-value";
          valueLabel.textContent = hasData ? dayData.duration : "0";
          bar.appendChild(valueLabel);

          const dateLabel = document.createElement("div");
          dateLabel.className = "chart-label";
          dateLabel.textContent = day.date.split("-").slice(1).join("/");
          bar.appendChild(dateLabel);

          chart.appendChild(bar);
        });

        statsContainer.appendChild(chart);
        container.appendChild(statsContainer);

        // 将日历添加到emptyPageContainer中
        emptyPageContainer.appendChild(container);
        updateStatus("自律日历");
      }

      function showDayDetails(dateStr, existingData = null) {
        // 调用showEmptyPage来准备容器，设置标题为"学习记录"
        showEmptyPage("学习记录");

        // 获取emptyPageContainer和emptyPageTitle
        const emptyPageContainer =
          document.getElementById("emptyPageContainer");
        const emptyPageTitle = document.getElementById("emptyPageTitle");

        if (!emptyPageContainer) {
          console.error("无法找到空白页面容器");
          return;
        }

        // 清空容器但保留标题元素
        while (emptyPageContainer.firstChild) {
          if (emptyPageContainer.firstChild === emptyPageTitle) {
            break;
          }
          emptyPageContainer.removeChild(emptyPageContainer.firstChild);
        }

        const date = new Date(dateStr);

        // 创建主容器并应用样式
        const container = document.createElement("div");
        container.className = "input-container";
        container.style.cssText = `
          background: rgba(255, 255, 255, var(--text-box-opacity));
          backdrop-filter: blur(var(--blur-amount));
          border-radius: 15px;
          padding: 2rem;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          max-width: 500px;
          margin: 2rem auto;
        `;

        // 创建标题
        const title = document.createElement("h3");
        title.textContent = `学习记录 - ${date.toLocaleDateString("zh-CN")}`;
        title.style.cssText = `
          color: var(--primary-color);
          margin-bottom: 1.5rem;
          text-align: center;
          font-size: 1.5rem;
        `;
        container.appendChild(title);

        // 创建表单样式容器
        const formStyle = document.createElement("div");
        formStyle.style.cssText = `
          display: flex;
          flex-direction: column;
          gap: 1rem;
        `;
        container.appendChild(formStyle);

        // 任务数量输入
        const taskCountContainer = document.createElement("div");
        taskCountContainer.style.marginBottom = "1rem";

        const taskCountLabel = document.createElement("label");
        taskCountLabel.textContent = "完成任务数量:";
        taskCountLabel.style.display = "block";
        taskCountLabel.style.marginBottom = "0.5rem";
        taskCountLabel.style.fontWeight = "500";

        const taskCountInput = document.createElement("input");
        taskCountInput.type = "number";
        taskCountInput.min = "0";
        taskCountInput.value = existingData?.taskCount || "0";
        taskCountInput.disabled = true; // 禁止修改任务数
        taskCountInput.style.cssText = `
          width: 100%;
          padding: 0.8rem;
          border: 1px solid #ddd;
          border-radius: 8px;
          font-size: 1rem;
          outline: none;
          transition: border-color 0.3s ease;
        `;
        taskCountInput.onfocus = function () {
          this.style.borderColor = "var(--primary-color)";
        };
        taskCountInput.onblur = function () {
          this.style.borderColor = "#ddd";
        };

        taskCountContainer.appendChild(taskCountLabel);
        taskCountContainer.appendChild(taskCountInput);
        formStyle.appendChild(taskCountContainer);

        // 学习时长输入
        const durationContainer = document.createElement("div");
        durationContainer.style.marginBottom = "1rem";

        const durationLabel = document.createElement("label");
        durationLabel.textContent = "学习时长 (分钟):";
        durationLabel.style.display = "block";
        durationLabel.style.marginBottom = "0.5rem";
        durationLabel.style.fontWeight = "500";

        const durationInput = document.createElement("input");
        durationInput.type = "number";
        durationInput.min = "0";
        durationInput.value = existingData?.duration || "0";
        durationInput.style.cssText = `
          width: 100%;
          padding: 0.8rem;
          border: 1px solid #ddd;
          border-radius: 8px;
          font-size: 1rem;
          outline: none;
          transition: border-color 0.3s ease;
        `;
        durationInput.onfocus = function () {
          this.style.borderColor = "var(--primary-color)";
        };
        durationInput.onblur = function () {
          this.style.borderColor = "#ddd";
        };

        durationContainer.appendChild(durationLabel);
        durationContainer.appendChild(durationInput);
        formStyle.appendChild(durationContainer);

        // 效率选择
        const efficientContainer = document.createElement("div");
        efficientContainer.style.cssText = `
          display: flex;
          align-items: center;
          gap: 0.5rem;
          margin-bottom: 1.5rem;
          padding: 0.8rem;
          background: #f9f9f9;
          border-radius: 8px;
        `;

        const efficientLabel = document.createElement("label");
        efficientLabel.textContent = "今天的学习效率高吗?";
        efficientLabel.style.fontWeight = "500";

        const efficientCheckbox = document.createElement("input");
        efficientCheckbox.type = "checkbox";
        efficientCheckbox.checked = existingData?.efficient || false;
        efficientCheckbox.style.width = "20px";
        efficientCheckbox.style.height = "20px";
        efficientCheckbox.style.cursor = "pointer";

        efficientContainer.appendChild(efficientCheckbox);
        efficientContainer.appendChild(efficientLabel);
        formStyle.appendChild(efficientContainer);

        // 按钮组
        const buttonGroup = document.createElement("div");
        buttonGroup.className = "button-group";
        buttonGroup.style.cssText = `
          display: flex;
          gap: 1rem;
          justify-content: center;
          margin: 2rem 0;
        `;

        // 保存按钮
        const saveButton = document.createElement("button");
        saveButton.textContent = "保存";
        saveButton.style.cssText = `
          padding: 1rem 2rem;
          background: var(--primary-color);
          color: white;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 1.1rem;
          font-weight: bold;
          transition: all 0.3s ease;
        `;
        saveButton.onmouseover = function () {
          this.style.transform = "scale(1.05)";
          this.style.background = "var(--primary-hover)";
        };
        saveButton.onmouseout = function () {
          this.style.transform = "scale(1)";
        };
        saveButton.addEventListener("click", () => {
          const taskCount = parseInt(taskCountInput.value) || 0;
          const duration = parseInt(durationInput.value) || 0;
          const efficient = efficientCheckbox.checked;

          if (taskCount > 0 || duration > 0) {
            calendarData[dateStr] = {
              taskCount,
              duration,
              efficient,
              timestamp: new Date().toISOString(),
            };
            saveCalendarData();

            // 检查目标进度
            checkGoalProgress();

            // 如果标记为高效学习，添加高效天数
            if (efficient && typeof addEfficientDay === "function") {
              addEfficientDay();
            }

            // 显示保存成功动画效果
            const successMessage = document.createElement("div");
            successMessage.style.cssText = `
              text-align: center;
              padding: 1rem;
              background: #4CAF50;
              color: white;
              border-radius: 8px;
              margin-top: 1rem;
              animation: fadeInOut 2s ease-in-out;
            `;
            successMessage.textContent = "记录已保存！";
            container.appendChild(successMessage);

            updateStatus("记录已保存");

            // 延迟后返回日历
            setTimeout(() => {
              showLearningCalendar();
            }, 1000);
          } else {
            // Remove entry if both are 0
            if (calendarData[dateStr]) {
              delete calendarData[dateStr];
              saveCalendarData();
            }
            updateStatus("记录已清除");
            showLearningCalendar();
          }
        });

        // 返回按钮
        const cancelButton = document.createElement("button");
        cancelButton.textContent = "返回日历";
        cancelButton.className = "cancel";
        cancelButton.style.cssText = `
          padding: 1rem 2rem;
          background: #666;
          color: white;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          font-size: 1.1rem;
          font-weight: bold;
          transition: all 0.3s ease;
        `;
        cancelButton.onmouseover = function () {
          this.style.transform = "scale(1.05)";
          this.style.background = "#555";
        };
        cancelButton.onmouseout = function () {
          this.style.transform = "scale(1)";
        };
        cancelButton.addEventListener("click", () => {
          showLearningCalendar();
        });

        buttonGroup.appendChild(saveButton);
        buttonGroup.appendChild(cancelButton);
        container.appendChild(buttonGroup);

        // 如果有现有数据，显示详情
        if (existingData) {
          const details = document.createElement("div");
          details.className = "day-details";
          details.style.cssText = `
            text-align: center;
            padding: 1.5rem;
            background: #f5f5f5;
            border-radius: 10px;
            margin-top: 1rem;
          `;
          details.innerHTML = `
            <h4 style="color: var(--primary-color); margin-bottom: 1rem;">当前记录</h4>
            <p style="margin: 0.5rem 0; font-size: 1.1rem;">完成任务: <strong>${
              existingData.taskCount
            }</strong></p>
            <p style="margin: 0.5rem 0; font-size: 1.1rem;">学习时长: <strong>${
              existingData.duration
            } 分钟</strong></p>
            <p style="margin: 0.5rem 0; font-size: 1.1rem;">效率: <strong style="color: ${
              existingData.efficient ? "#4CAF50" : "#FF5252"
            };">${existingData.efficient ? "✅ 高效" : "❌ 低效"}</strong></p>
          `;
          container.appendChild(details);
        }

        // 添加动画效果
        container.style.opacity = "0";
        container.style.transform = "translateY(20px)";
        container.style.transition = "opacity 0.5s ease, transform 0.5s ease";

        // 将容器添加到emptyPageContainer中
        emptyPageContainer.appendChild(container);

        // 触发动画
        setTimeout(() => {
          container.style.opacity = "1";
          container.style.transform = "translateY(0)";
        }, 10);
      }

      function loadCalendarData() {
        const savedData = localStorage.getItem(CALENDAR_DATA_KEY);
        if (savedData) {
          try {
            calendarData = JSON.parse(savedData);
          } catch (e) {
            console.error("加载日历数据错误:", e);
            calendarData = {};
          }
        } else {
          calendarData = {};
        }
      }

      function saveCalendarData() {
        try {
          localStorage.setItem(CALENDAR_DATA_KEY, JSON.stringify(calendarData));
          return true;
        } catch (e) {
          console.error("保存日历数据错误:", e);
          return false;
        }
      }

      // 自动从代办界面同步每日完成任务数到日历
      function syncCompletedTasksToCalendar() {
        if (!currentUser) return;
        
        loadCalendarData();
        loadTodos();
        
        const today = new Date().toISOString().split('T')[0];
        
        // 统计今天已完成的任务数
        const todayCompletedTasks = todos.filter(todo => {
          // 检查任务是否已完成
          if (!todo.completed) return false;
          
          // 检查任务是否有完成时间且是今天的
          if (todo.lastCompleted) {
            const completedDate = new Date(todo.lastCompleted).toISOString().split('T')[0];
            return completedDate === today;
          }
          
          // 对于没有完成时间的已完成任务，也计入统计
          return true;
        }).length;
        
        // 获取今天的日历数据
        const todayData = calendarData[today] || { taskCount: 0, duration: 0, efficient: false };
        
        // 如果任务数发生变化，更新日历数据
        if (todayData.taskCount !== todayCompletedTasks) {
          todayData.taskCount = todayCompletedTasks;
          calendarData[today] = todayData;
          saveCalendarData();
        }
      }

      function getLast14Days() {
        const result = [];
        for (let i = 13; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split("T")[0];
          result.push({ date: dateStr });
        }
        return result;
      }

      // 检查网站屏蔽状态
      function checkWebsiteBlockingStatus() {
        const isBlocking =
          localStorage.getItem("websiteBlockingEnabled") === "true";
        const blockMode = localStorage.getItem("blockMode") || "blacklist";
        const blockedSites = localStorage.getItem("blockedSites") || "";
        const whitelistedSites = localStorage.getItem("whitelistedSites") || "";

        // 注意：由于浏览器安全限制，前端JavaScript无法直接拦截网站访问
        // 这里只是模拟功能，实际应用中需要浏览器扩展或其他方式实现
        if (isBlocking) {
          // 这里可以添加实际的网站拦截逻辑（如果在浏览器扩展中运行）
          console.log("网站屏蔽功能已启用，模式：", blockMode);
        }
      }

      // 每日任务功能
      const DAILY_TASKS_KEY = "dailyTasks";
      const DAILY_TASKS_RESET_KEY = "dailyTasksLastReset";

      // 默认每日任务
      const defaultDailyTasks = [
        {
          id: 1,
          title: "高效学习(检查自律日历)",
          reward: 20,
          completed: false,
          type: "efficient_study",
        },
        {
          id: 2,
          title: "学习时长≥300分钟",
          reward: 20,
          completed: false,
          type: "duration_300",
        },
        {
          id: 3,
          title: "学习时长≥450分钟",
          reward: 20,
          completed: false,
          type: "duration_450",
        },
        {
          id: 4,
          title: "学习时长≥600分钟",
          reward: 20,
          completed: false,
          type: "duration_600",
        },
        {
          id: 5,
          title: "完成当天截止的代办",
          reward: 20,
          completed: false,
          type: "complete_today_todos",
        },
      ];

      // 全部完成额外奖励
      const ALL_COMPLETED_BONUS = 100;

      // 显示每日任务界面
      function showDailyTasks() {
        // 检查是否需要重置每日任务
        checkAndResetDailyTasks();

        // 保存当前活跃的界面
        const activeSection = document.querySelector(
          ".todoSection.active, .toolsSection.active, .shopSection.active, .profileSection.active"
        );
        if (activeSection) {
          // 提取section ID并转换为对应的tab名称
          const sectionId = activeSection.id;
          window.lastActiveTab = sectionId.replace("Section", "");
        } else {
          // 如果没有活跃的界面，默认保存todo
          window.lastActiveTab = "todo";
        }

        // 隐藏其他界面
        hideAllSections();

        // 创建每日任务界面
        const container = document.createElement("div");
        container.className = "daily-tasks-container";
        container.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1001;
          backdrop-filter: blur(5px);
        `;

        const modal = document.createElement("div");
        modal.className = "daily-tasks-modal";
        modal.style.cssText = `
          background: white;
          border-radius: 15px;
          padding: 2rem;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        `;

        modal.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: var(--primary-color); margin: 0;">📋 每日任务</h2>
            <button onclick="closeDailyTasks()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
          </div>
          
          <div style="margin-bottom: 1.5rem; text-align: center;">
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">完成每日任务获取金币奖励 (每个任务20金币)</div>
            <div style="font-size: 0.8rem; color: #4CAF50; margin-bottom: 0.5rem;">✨ 全部完成额外奖励100金币 ✨</div>
            <div style="font-size: 0.8rem; color: #2196F3; margin-bottom: 0.5rem; background: #E3F2FD; padding: 0.5rem; border-radius: 5px;">
              📊 任务完成状态会自动从自律日历中监测
            </div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
              <span style="font-size: 1.2rem; font-weight: bold;">今日进度:</span>
              <span id="dailyProgress" style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">0/5</span>
            </div>
          </div>
          
          <div id="dailyTasksList" style="margin-bottom: 1.5rem;"></div>
          
          <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 10px; margin-bottom: 1rem;">
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">今日总奖励</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
              <span id="totalReward">0</span> 金币
            </div>
          </div>
          
          <button onclick="claimAllRewards()" id="claimAllButton" style="
            width: 100%;
            padding: 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
          ">领取全部奖励</button>
        `;

        container.appendChild(modal);
        document.body.appendChild(container);

        // 渲染任务列表
        renderDailyTasks();
      }

      // 关闭每日任务界面
      function closeDailyTasks() {
        const container = document.querySelector(".daily-tasks-container");
        if (container) {
          container.remove();
        }

        // 恢复之前活跃的界面
        // 检查是否有保存的活跃标签页，如果没有则默认显示todo界面
        if (window.lastActiveTab) {
          switchTab(window.lastActiveTab);
        } else {
          switchTab("todo");
        }
      }

      // 渲染每日任务列表
      function renderDailyTasks() {
        const tasksList = document.getElementById("dailyTasksList");
        const dailyTasks = getDailyTasks();

        if (!tasksList) return;

        tasksList.innerHTML = "";

        let completedCount = 0;
        let totalReward = 0;

        dailyTasks.forEach((task) => {
          if (task.completed) {
            completedCount++;
            totalReward += task.reward;
          }

          const taskElement = document.createElement("div");
          taskElement.className = "daily-task-item";
          taskElement.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: ${task.completed ? "#e8f5e8" : "#f8f9fa"};
            border-radius: 10px;
            border-left: 4px solid ${task.completed ? "#4CAF50" : "#ddd"};
            transition: all 0.3s ease;
          `;

          taskElement.innerHTML = `
            <div style="flex: 1;">
              <div style="font-weight: bold; margin-bottom: 0.25rem; color: ${
                task.completed ? "#333" : "#666"
              };">${task.title}</div>
              <div style="font-size: 0.8rem; color: #888;">奖励: ${
                task.reward
              } 金币</div>
            </div>
            <div>
              ${
                task.completed
                  ? '<span style="color: #4CAF50; font-weight: bold;">✅ 已完成</span>'
                  : '<span style="color: #FF9800; font-weight: bold;">⏳ 自动监测中</span>'
              }
            </div>
          `;

          tasksList.appendChild(taskElement);
        });

        // 更新进度和总奖励
        document.getElementById(
          "dailyProgress"
        ).textContent = `${completedCount}/${dailyTasks.length}`;
        document.getElementById("totalReward").textContent = totalReward;

        // 更新领取按钮状态
        const claimButton = document.getElementById("claimAllButton");
        if (claimButton) {
          if (completedCount === 0) {
            claimButton.disabled = true;
            claimButton.style.background = "#ccc";
            claimButton.textContent = "暂无奖励可领取";
          } else {
            claimButton.disabled = false;
            claimButton.style.background = "var(--primary-color)";
            claimButton.textContent = `领取全部奖励 (${totalReward} 金币)`;
          }
        }
      }

      // 完成任务
      function completeTask(taskId) {
        const dailyTasks = getDailyTasks();
        const taskIndex = dailyTasks.findIndex((task) => task.id === taskId);

        if (taskIndex !== -1 && !dailyTasks[taskIndex].completed) {
          dailyTasks[taskIndex].completed = true;
          saveDailyTasks(dailyTasks);
          renderDailyTasks();

          // 显示完成任务动画
          showTaskCompleteAnimation(taskId);

          // 完成任务时添加高效天数（如果当天还没有添加过）
          if (typeof addEfficientDay === "function") {
            addEfficientDay();
          }
        }
      }

      // 领取全部奖励
      function claimAllRewards() {
        const dailyTasks = getDailyTasks();
        let totalReward = 0;
        let allCompleted = true;

        dailyTasks.forEach((task) => {
          if (task.completed && !task.claimed) {
            totalReward += task.reward;
            task.claimed = true;
          }
          if (!task.completed) {
            allCompleted = false;
          }
        });

        // 如果全部任务都完成，添加额外奖励
        if (allCompleted && totalReward > 0) {
          totalReward += ALL_COMPLETED_BONUS;
        }

        if (totalReward > 0) {
          // 更新金币
          const currentCoins = parseInt(localStorage.getItem("coins") || "0");
          localStorage.setItem(
            "coins",
            (currentCoins + totalReward).toString()
          );

          // 保存任务状态
          saveDailyTasks(dailyTasks);

          // 更新界面显示
          updateHeaderCoins();
          renderDailyTasks();

          // 显示奖励领取动画
          showRewardAnimation(totalReward);
        }
      }

      // 显示任务完成动画
      function showTaskCompleteAnimation(taskId) {
        const taskElement = document.querySelector(
          `[onclick*="completeTask(${taskId})"]`
        );
        if (taskElement && taskElement.parentElement) {
          const button = taskElement;
          button.style.transform = "scale(0.9)";
          button.style.background = "#4CAF50";
          button.textContent = "✓";

          setTimeout(() => {
            button.style.transition = "all 0.3s ease";
            button.style.transform = "scale(1)";
          }, 300);
        }
      }

      // 显示奖励领取动画
      function showRewardAnimation(reward) {
        const modal = document.querySelector(".daily-tasks-modal");
        if (modal) {
          const animation = document.createElement("div");
          animation.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: #FFD700;
            animation: rewardBounce 1s ease-in-out;
            z-index: 1002;
          `;
          animation.textContent = `+${reward} 金币`;

          modal.style.position = "relative";
          modal.appendChild(animation);

          setTimeout(() => {
            animation.remove();
          }, 1000);
        }
      }

      // 获取每日任务并自动检查完成状态
      function getDailyTasks() {
        const savedTasks = localStorage.getItem(DAILY_TASKS_KEY);
        let tasks = [...defaultDailyTasks];

        if (savedTasks) {
          try {
            tasks = JSON.parse(savedTasks);
          } catch (e) {
            console.error("解析每日任务数据错误:", e);
          }
        }

        // 自动检查任务完成状态
        const updatedTasks = checkTasksCompletion(tasks);

        // 保存更新后的任务状态
        saveDailyTasks(updatedTasks);

        return updatedTasks;
      }

      // 检查当天截止的代办是否都已完成
      function checkTodayTodosCompleted() {
        const today = new Date().toISOString().split("T")[0];

        // 获取当天截止的所有待办事项
        const todayTodos = todos.filter((todo) => {
          if (!todo.deadline) return false;

          const todoDate = new Date(todo.deadline).toISOString().split("T")[0];
          return todoDate === today;
        });

        // 如果没有当天截止的待办事项，则任务自动完成
        if (todayTodos.length === 0) {
          return true;
        }

        // 检查所有当天截止的待办事项是否都已完成
        return todayTodos.every((todo) => todo.completed);
      }

      // 自动检查任务完成状态
      function checkTasksCompletion(tasks) {
        const today = new Date().toISOString().split("T")[0];
        const todayData = calendarData[today];

        return tasks.map((task) => {
          let completed = task.completed;

          // 如果任务未完成，根据类型自动检查
          if (!completed) {
            switch (task.type) {
              case "efficient_study":
                // 高效学习：检查效率标记为高效，或者有学习记录且效率为高效
                completed = todayData && todayData.efficient;
                break;
              case "duration_300":
                // 学习时长≥300分钟
                completed = todayData && todayData.duration >= 300;
                break;
              case "duration_450":
                // 学习时长≥450分钟
                completed = todayData && todayData.duration >= 450;
                break;
              case "duration_600":
                // 学习时长≥600分钟
                completed = todayData && todayData.duration >= 600;
                break;
              case "complete_today_todos":
                // 完成当天截止的代办：检查所有当天截止的代办是否都已完成
                completed = checkTodayTodosCompleted();
                break;
            }
          }

          return {
            ...task,
            completed: completed,
          };
        });
      }

      // 保存每日任务
      function saveDailyTasks(tasks) {
        try {
          localStorage.setItem(DAILY_TASKS_KEY, JSON.stringify(tasks));
        } catch (e) {
          console.error("保存每日任务数据错误:", e);
        }
      }

      // 检查并重置每日任务
      function checkAndResetDailyTasks() {
        const today = new Date().toDateString();
        const lastReset = localStorage.getItem(DAILY_TASKS_RESET_KEY);

        if (lastReset !== today) {
          // 重置任务
          const resetTasks = defaultDailyTasks.map((task) => ({
            ...task,
            completed: false,
            claimed: false,
          }));

          saveDailyTasks(resetTasks);
          localStorage.setItem(DAILY_TASKS_RESET_KEY, today);
        }
      }

      // 目标设定相关功能
      let userGoal = {
        consecutiveDays: 0,
        penaltyAmount: 0,
        startDate: null,
        currentStreak: 0,
        completed: false,
      };

      // 加载用户目标设置
      function loadUserGoal() {
        const savedGoal = localStorage.getItem("userGoal");
        if (savedGoal) {
          try {
            userGoal = JSON.parse(savedGoal);
            // 检查目标是否已完成
            checkGoalProgress();
          } catch (e) {
            console.error("解析用户目标数据错误:", e);
          }
        }
      }

      // 保存用户目标设置
      function saveUserGoal() {
        try {
          localStorage.setItem("userGoal", JSON.stringify(userGoal));
        } catch (e) {
          console.error("保存用户目标数据错误:", e);
        }
      }

      // 显示目标设定模态框
      function showGoalSettingModal() {
        // 创建模态框
        const modal = document.createElement("div");
        modal.id = "goalModal";
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;

        const modalContent = document.createElement("div");
        modalContent.style.cssText = `
          background: white;
          padding: 2rem;
          border-radius: 15px;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        `;

        modalContent.innerHTML = `
          <h3 style="margin-bottom: 1.5rem; text-align: center; color: #333;">🎯 连续自律目标设定</h3>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">连续高效天数目标：</label>
            <input type="number" id="goalDays" min="1" max="365" value="${
              userGoal.consecutiveDays || 7
            }" ${userGoal.consecutiveDays > 0 && !userGoal.completed ? 'disabled' : ''}
                   style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;${userGoal.consecutiveDays > 0 && !userGoal.completed ? ' background-color: #f5f5f5; cursor: not-allowed;' : ''}">
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">失败扣除金币数：</label>
            <input type="number" id="goalPenalty" min="0" value="${
              userGoal.penaltyAmount || 100
            }" ${userGoal.consecutiveDays > 0 && !userGoal.completed ? 'disabled' : ''}
                   style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;${userGoal.consecutiveDays > 0 && !userGoal.completed ? ' background-color: #f5f5f5; cursor: not-allowed;' : ''}">
            <small style="color: #666; font-size: 0.8rem;">成功奖励：${
              (userGoal.penaltyAmount || 100) * 0.5
            } 金币</small>
          </div>
          
          ${
            userGoal.consecutiveDays > 0
              ? `
          <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; color: #333;">当前进度</h4>
            <p style="margin: 0.25rem 0; color: #666;">目标：连续 ${
              userGoal.consecutiveDays
            } 天高效学习</p>
            <p style="margin: 0.25rem 0; color: #666;">当前连续：${
              userGoal.currentStreak
            } 天</p>
            <p style="margin: 0.25rem 0; color: #666;">开始日期：${
              userGoal.startDate || "未开始"
            }</p>
            <p style="margin: 0.25rem 0; color: ${
              userGoal.completed ? "#4CAF50" : "#666"
            };">
              状态：${userGoal.completed ? "🎉 已完成" : "进行中"}
            </p>
          </div>
          `
              : ""
          }
          
          <div style="display: flex; gap: 1rem;">
            <button id="saveGoal" style="flex: 1; padding: 0.75rem; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: ${userGoal.consecutiveDays > 0 && !userGoal.completed ? 'not-allowed;' : 'pointer;'}" ${userGoal.consecutiveDays > 0 && !userGoal.completed ? 'disabled' : ''}>
              保存目标
            </button>
            ${userGoal.consecutiveDays > 0 && !userGoal.completed ? `
            <button id="giveUpGoal" style="flex: 1; padding: 0.75rem; background: #FF9800; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;">
              放弃目标
            </button>
            ` : ''}
            <button id="closeGoal" style="flex: 1; padding: 0.75rem; background: #f44336; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;">
              关闭
            </button>
          </div>
        `;

        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // 事件监听
        document
          .getElementById("goalPenalty")
          .addEventListener("input", function () {
            const penalty = parseInt(this.value) || 0;
            const reward = Math.floor(penalty * 0.5);
            this.nextElementSibling.textContent = `成功奖励：${reward} 金币`;
          });

        document
          .getElementById("saveGoal")
          .addEventListener("click", saveGoalSettings);
          
        // 放弃目标按钮事件
        const giveUpButton = document.getElementById("giveUpGoal");
        if (giveUpButton) {
          giveUpButton.addEventListener("click", function() {
            if (confirm("确定要放弃当前目标吗？将扣除设定的金币，当前进度将会丢失。")) {
              // 保存当前的惩罚金额
              const penaltyAmount = userGoal.penaltyAmount || 0;
              
              // 扣除金币
              if (penaltyAmount > 0) {
                const currentCoins = parseInt(localStorage.getItem("coins") || "0");
                const newCoins = currentCoins - penaltyAmount;
                // 允许金币总数为负数
                localStorage.setItem("coins", newCoins.toString());
                updateHeaderCoins();
              }
              
              // 重置目标
              userGoal = {
                consecutiveDays: 0,
                penaltyAmount: 0,
                currentStreak: 0,
                startDate: new Date().toISOString().split("T")[0],
                completed: false
              };
              saveUserGoal();
              updateGoalButton();
              
              const modal = document.getElementById("goalModal");
              if (modal) {
                document.body.removeChild(modal);
              }
              
              // 显示消息
              if (penaltyAmount > 0) {
                showGoalMessage(`目标已放弃，扣除 ${penaltyAmount} 金币，您可以重新设定新的目标。`);
              } else {
                showGoalMessage("目标已放弃，您可以重新设定新的目标。");
              }
            }
          });
        }
        
        document.getElementById("closeGoal").addEventListener("click", () => {
          document.body.removeChild(modal);
        });

        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        });
      }

      // 保存目标设置
      function saveGoalSettings() {
        const daysInput = document.getElementById("goalDays");
        const penaltyInput = document.getElementById("goalPenalty");

        const consecutiveDays = parseInt(daysInput.value) || 0;
        const penaltyAmount = Math.max(0, parseInt(penaltyInput.value) || 0);

        if (consecutiveDays <= 0) {
          alert("请输入有效的连续天数目标（大于0）");
          return;
        }

        if (penaltyAmount < 0) {
          alert("惩罚金额不能为负数");
          return;
        }

        // 限制惩罚金额不能超过总天数*200
        const maxPenalty = consecutiveDays * 200;
        if (penaltyAmount > maxPenalty) {
          alert(`惩罚金额不能超过 ${maxPenalty} 金币（总天数 × 200）`);
          return;
        }

        // 如果是新目标或目标天数改变，重置进度
        if (userGoal.consecutiveDays !== consecutiveDays) {
          userGoal = {
            consecutiveDays: consecutiveDays,
            penaltyAmount: penaltyAmount,
            startDate: new Date().toISOString().split("T")[0],
            currentStreak: 0,
            completed: false,
          };
        } else {
          // 只更新惩罚金额
          userGoal.penaltyAmount = penaltyAmount;
        }

        saveUserGoal();
        checkGoalProgress();

        // 关闭模态框
        const modal = document.getElementById("goalModal");
        if (modal) {
          document.body.removeChild(modal);
        }

        // 显示成功消息
        showGoalMessage(
          `目标已保存！连续 ${consecutiveDays} 天高效学习，失败扣除 ${penaltyAmount} 金币，成功奖励 ${Math.floor(
            penaltyAmount * 0.5
          )} 金币`
        );
      }

      // 检查目标进度
      function checkGoalProgress() {
        if (userGoal.consecutiveDays === 0) return;

        const today = new Date().toISOString().split("T")[0];
        
        // 如果是新的一天，检查昨天的进度
        if (userGoal.startDate && userGoal.startDate !== today) {
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().split("T")[0];
          const yesterdayData = calendarData[yesterdayStr];

          // 标记是否需要清空挑战状态
          let needResetGoal = false;

          if (yesterdayData && yesterdayData.efficient) {
            // 昨天高效，增加连续天数
            userGoal.currentStreak++;
            
            // 检查是否完成目标
            if (userGoal.currentStreak >= userGoal.consecutiveDays) {
              userGoal.completed = true;
              applyGoalReward();
              needResetGoal = true; // 挑战成功，需要清空挑战状态
            }
          } else if (yesterdayData) {
            // 昨天有数据但不是高效，挑战失败
            userGoal.completed = false;
            applyGoalPenalty();
            needResetGoal = true; // 挑战失败，需要清空挑战状态
          }

          // 清空挑战状态
          if (needResetGoal) {
            const goalDays = userGoal.consecutiveDays;
            const penaltyAmount = userGoal.penaltyAmount;
            
            // 重置挑战状态
            userGoal = {
              consecutiveDays: 0,
              penaltyAmount: 0,
              currentStreak: 0,
              startDate: today,
              completed: false
            };
          }

          saveUserGoal();
        }

        // 更新按钮显示
        updateGoalButton();
      }

      // 应用目标惩罚
      function applyGoalPenalty() {
        if (userGoal.penaltyAmount > 0) {
          const currentCoins = parseInt(localStorage.getItem("coins") || "0");
          const newCoins = currentCoins - userGoal.penaltyAmount;
          // 允许金币总数为负数
          localStorage.setItem("coins", newCoins.toString());
          updateHeaderCoins();

          showGoalMessage(`连续自律中断！扣除 ${userGoal.penaltyAmount} 金币`);
        }
      }

      // 应用目标奖励
      function applyGoalReward() {
        if (userGoal.penaltyAmount > 0 && userGoal.completed) {
          const reward = Math.floor(userGoal.penaltyAmount * 0.5);
          const currentCoins = parseInt(localStorage.getItem("coins") || "0");
          localStorage.setItem("coins", (currentCoins + reward).toString());
          updateHeaderCoins();

          showGoalMessage(`🎉 恭喜完成连续自律目标！获得 ${reward} 金币奖励`);
        }
      }

      // 显示目标消息
      function showGoalMessage(message) {
        // 创建消息提示
        const messageDiv = document.createElement("div");
        messageDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${message.includes("恭喜") ? "#4CAF50" : "#f44336"};
          color: white;
          padding: 1rem 1.5rem;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
          z-index: 1001;
          animation: slideIn 0.3s ease;
        `;
        messageDiv.textContent = message;

        document.body.appendChild(messageDiv);

        setTimeout(() => {
          messageDiv.style.animation = "slideOut 0.3s ease";
          setTimeout(() => {
            if (messageDiv.parentNode) {
              document.body.removeChild(messageDiv);
            }
          }, 300);
        }, 3000);
      }

      // 更新目标按钮显示
      function updateGoalButton() {
        const goalButton = document.querySelector(
          '[onclick="showGoalSettingModal()"]'
        );
        if (goalButton) {
          if (userGoal.consecutiveDays > 0) {
            if (userGoal.completed) {
              goalButton.textContent = `🎉 目标完成`;
              goalButton.style.background =
                "linear-gradient(135deg, #4CAF50 0%, #45a049 100%)";
            } else {
              goalButton.textContent = `🎯 ${userGoal.currentStreak}/${userGoal.consecutiveDays}天`;
              goalButton.style.background =
                "linear-gradient(135deg, #FF9800 0%, #F57C00 100%)";
            }
          } else {
            goalButton.textContent = "🎯 目标设定";
            goalButton.style.background =
              "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
          }
        }
      }

      // 初始化时加载用户目标
      loadUserGoal();

      // 添加奖励动画CSS
      const style = document.createElement("style");
      style.textContent = `
        @keyframes rewardBounce {
          0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
          50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .daily-task-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
